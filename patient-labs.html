<!DOCTYPE html>
<html lang="en" data-theme="matte">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HealthFlo ‚Äî Labs & Investigations</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/patient-os.css">
</head>
<body>
  <header class="hf-topbar">
    <div class="container topbar-inner">
      <a class="hf-logo" href="patient-dashboard.html"><span class="logo-dot"></span>HealthFlo Patient OS</a>
      <nav class="hf-nav">
        <a href="patient-dashboard.html">Dashboard</a>
        <a href="patient-health.html">Health</a>
        <a href="patient-organs.html">Organs</a>
        <a href="patient-profile.html">Profile</a>
        <a href="patient-hospitals.html">Hospitals</a>
        <a href="patient-pharmacy.html">Pharmacy</a>
        <a class="active" href="patient-labs.html">Labs</a>
        <a href="patient-insurance.html">Insurance</a>
        <a href="patient-settings.html">Settings</a>
      </nav>
      <div class="topbar-actions">
        <button class="icon-btn" id="themeToggle">üåì</button>
        <button class="icon-btn">üîî</button>
      </div>
    </div>
  </header>

  <main class="container labs-shell">
    <section class="section hero-grid">
      <div class="hero-card hero-elevated">
        <p class="chip">Labs & Radiology</p>
        <h1 class="hero-title">Book investigations faster with VOKA</h1>
        <p class="hero-sub">Compare nearby hospitals or standalone labs, book home blood collection when available, or pick a direct in-lab or hospital visit. Everything is synced back to your patient dashboard.</p>
        <div class="stat-stack">
          <div class="stat">
            <small>Home pickup</small>
            <strong>45 mins</strong>
            <span class="muted">Partner phlebotomists on map</span>
          </div>
          <div class="stat">
            <small>Radiology slots</small>
            <strong>Today & Tomorrow</strong>
            <span class="muted">MRI, CT, USG, CBCT</span>
          </div>
          <div class="stat">
            <small>Dashboard sync</small>
            <strong>Auto</strong>
            <span class="muted">Reports land in Labs</span>
          </div>
        </div>
        <div class="hero-actions">
          <a class="badge primary" href="#booking">Book blood pickup</a>
          <a class="badge" href="#radiology-board">Plan radiology</a>
          <a class="badge ghost" href="patient-dashboard.html">Open patient dashboard</a>
        </div>
      </div>
      <div class="card sync-card">
        <div class="pill-row">
          <span class="pill ghost">VOKA glass UI</span>
          <span class="pill">Live status</span>
          <span class="pill">Synced</span>
        </div>
        <h3>Patient dashboard mapping</h3>
        <p class="section-sub">Bookings, ETA, and reports reflect instantly inside <strong>Dashboard ‚Üí Labs</strong>. Home visit assignments, hospital directions, and payment links follow you.</p>
        <div class="sync-grid">
          <div>
            <p class="muted">Current profile</p>
            <div class="signal">Hydration steady ¬∑ CBC clean ¬∑ LFT green</div>
          </div>
          <div>
            <p class="muted">Next visit</p>
            <div class="signal accent">USG Pelvis ‚Äî today, VOKA Imaging Hub</div>
          </div>
        </div>
        <div class="flex-row">
          <a class="badge primary" href="patient-dashboard.html">View in dashboard</a>
          <button class="badge" type="button">Share status</button>
        </div>
      </div>
    </section>

    <section id="labs-finder" class="section">
      <header class="finder-head">
        <div>
          <p class="chip">Upgraded workflows</p>
          <h2 class="section-title">Find a lab, home pickup, or hospital slot</h2>
          <p class="section-sub">Search by name, city, visit mode, and availability. These filters mirror to <strong>Dashboard ‚Üí Labs</strong> so you can resume later.</p>
        </div>
        <div class="pill-row">
          <span class="pill">Mapped to dashboard</span>
          <span class="pill ghost">Live ETA</span>
          <span class="pill">Home visit aware</span>
        </div>
      </header>

      <div class="advanced-head card">
        <div class="finder-stats">
          <div class="stat-row">
            <strong id="labsMetaCount">‚Äî labs nearby</strong>
            <span class="pill ghost" id="labsHomeCount">‚Äî home visit</span>
            <span class="pill" id="labsRadCount">‚Äî radiology hubs</span>
          </div>
          <div class="advanced-kpis">
            <div class="kpi-card">
              <small>Nearest first</small>
              <strong id="labsSortMeta">Live location</strong>
              <span class="muted">Auto-applied like Zomato</span>
            </div>
            <div class="kpi-card">
              <small>Dashboard sync</small>
              <strong>Instant</strong>
              <span class="muted">Pins to Labs board</span>
            </div>
            <div class="kpi-card">
              <small>Pricing</small>
              <strong id="labsPriceMeta">‚Çπ‚Äî</strong>
              <span class="muted">Avg. blood panel start</span>
            </div>
          </div>
        </div>
        <div class="finder-stats">
          <div class="notice glass" id="labsMetaStatus">Live location applied ¬∑ home pickup highlighted.</div>
          <div class="stat-row">
            <button class="badge primary" id="pinDashboard" type="button">Pin these results to dashboard</button>
            <span class="pill ghost">Saved automatically</span>
          </div>
        </div>
      </div>

      <div class="location-bar card">
        <div class="location-meta">
          <p class="muted">Live location</p>
          <div class="location-status" id="locationStatus">Using saved preference ¬∑ nearest first</div>
        </div>
        <div class="location-actions">
          <button class="badge" id="locateMe" type="button">Use my location</button>
          <span class="pill ghost" id="cityHint">City: Auto</span>
          <span class="pill">Synced to dashboard</span>
        </div>
      </div>

      <div class="filter-card card">
        <div class="filter-grid">
          <label>Search labs or tests
            <input id="labSearch" type="search" placeholder="CBC, Apollo, MRI, USG" />
          </label>
          <label>City
            <select id="labCity">
              <option value="">All</option>
              <option>Mumbai</option>
              <option>Delhi</option>
              <option>Bengaluru</option>
              <option>Hyderabad</option>
              <option>Chennai</option>
            </select>
          </label>
          <label>Type
            <select id="labType">
              <option value="">Any</option>
              <option value="blood">Blood / Pathology</option>
              <option value="radiology">Radiology / Imaging</option>
            </select>
          </label>
          <label>Sort
            <select id="labSort">
              <option value="nearest">Nearest</option>
              <option value="az">A‚ÄìZ</option>
            </select>
          </label>
        </div>
        <div class="filter-actions">
          <label class="pill switcher">
            <input id="homeOnlyToggle" type="checkbox" /> Home visit only
          </label>
          <label class="pill switcher ghost">
            <input id="openSlotToggle" type="checkbox" /> Show only with open slots
          </label>
          <span class="inline-meta" id="labStatus">Loading labs‚Ä¶</span>
          <button class="badge" id="syncFilters" type="button">Sync filters to dashboard</button>
        </div>
      </div>

      <div class="results-grid zomato-grid" id="labResults" aria-live="polite"></div>

      <!-- Detail modal -->
      <div class="lab-modal" id="labModal" aria-hidden="true">
        <div class="lab-modal__sheet" role="dialog" aria-modal="true" aria-labelledby="labModalTitle">
          <header class="lab-modal__head">
            <div class="lab-modal__meta">
              <p class="muted" id="labModalLocation">‚Äî</p>
              <h3 id="labModalTitle">Lab</h3>
              <div class="pill-row">
                <span class="pill" id="labModalHome">Home visit ‚Ä¢ Yes</span>
                <span class="pill" id="labModalDistance">‚Äî km</span>
                <span class="pill ghost" id="labModalCounts">‚Äî</span>
              </div>
            </div>
            <div class="lab-modal__actions">
              <a class="badge" id="labModalDirections" target="_blank" rel="noopener">Directions</a>
              <a class="badge" id="labModalCall">Call</a>
              <a class="badge ghost" id="labModalWA" target="_blank" rel="noopener">WhatsApp</a>
              <button class="icon-btn" id="labModalClose" type="button">‚úï</button>
            </div>
          </header>

          <div class="lab-modal__tabs" role="tablist">
            <button class="pill" data-tab="blood" aria-selected="true">Blood Tests</button>
            <button class="pill ghost" data-tab="radiology" aria-selected="false">Radiology</button>
            <button class="pill ghost" data-tab="book" aria-selected="false">Book</button>
          </div>

          <div class="lab-modal__panel" data-panel="blood">
            <div class="modal-toolbar">
              <div class="toolbar-field">
                <input id="bloodSearch" type="search" placeholder="Search blood tests" />
              </div>
              <label class="pill switcher">
                <input id="bloodHomeToggle" type="checkbox" /> Home collection
              </label>
              <span class="muted" id="homeFeeText">Home fee: ‚Çπ0</span>
              <div class="spacer"></div>
              <button class="badge ghost" id="bloodClear" type="button">Clear</button>
              <button class="badge" id="bloodWA" type="button">Send on WhatsApp</button>
            </div>
            <div class="modal-list" id="bloodList"></div>
            <footer class="modal-foot">
              <span>Selected: <strong id="bloodCount">0</strong></span>
              <span class="spacer"></span>
              <span>Total: <strong id="bloodTotal">‚Çπ0</strong></span>
            </footer>
          </div>

          <div class="lab-modal__panel hidden" data-panel="radiology">
            <div class="modal-toolbar">
              <div class="toolbar-field">
                <input id="radSearch" type="search" placeholder="Search radiology" />
              </div>
              <div class="spacer"></div>
              <button class="badge ghost" id="radClear" type="button">Clear</button>
              <button class="badge" id="radWA" type="button">Send on WhatsApp</button>
            </div>
            <div class="modal-list" id="radList"></div>
            <footer class="modal-foot">
              <span>Selected: <strong id="radCount">0</strong></span>
              <span class="spacer"></span>
              <span>Total: <strong id="radTotal">‚Çπ0</strong></span>
            </footer>
          </div>

          <div class="lab-modal__panel hidden" data-panel="book">
            <div class="booking-summary">
              <p class="muted">Selections will sync to Dashboard ‚Üí Labs.</p>
              <div id="bookSummary" class="notice">No tests selected yet.</div>
              <div class="modal-foot">
                <span>Total: <strong id="bookTotal">‚Çπ0</strong></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="investigation-board card">
        <header class="board-head">
          <div>
            <p class="chip">Investigations near you</p>
            <h3>Popular tests and price starts</h3>
            <p class="section-sub">Curated from the filtered labs ‚Äî mirrored to Dashboard ‚Üí Labs.</p>
          </div>
          <span class="pill ghost" id="investigationMeta">Live price bands</span>
        </header>
        <div class="investigation-list" id="investigationList"></div>
      </div>
    </section>

    <section class="section labs-actions">
      <header>
        <p class="chip">Workflows</p>
        <h2 class="section-title">Home visit or direct hospital visit</h2>
        <p class="section-sub">Pick how you want to give a sample; the flow adapts to phlebotomist routes or hospital counters.</p>
      </header>
      <div class="lab-action-grid">
        <div class="action-card">
          <div class="pill">Home visit</div>
          <h3>Blood pickup at home</h3>
          <p class="muted">Track the assigned phlebotomist, collection kit QR, and payment link. Works best for CBC, KFT, LFT, HbA1c.</p>
          <div class="action-footer">
            <span class="pill ghost">ETA 45 mins</span>
            <button class="badge primary" type="button">Request pickup</button>
          </div>
        </div>
        <div class="action-card">
          <div class="pill ghost">Hospital / Lab counter</div>
          <h3>Direct visit to lab</h3>
          <p class="muted">Book a slot at hospitals or stand-alone labs, generate a QR for quick check-in, and sync results to the dashboard automatically.</p>
          <div class="action-footer">
            <span class="pill">Queue <strong>Light</strong></span>
            <button class="badge" type="button">Find slot</button>
          </div>
        </div>
        <div class="action-card">
          <div class="pill ghost">Radiology</div>
          <h3>Imaging schedule</h3>
          <p class="muted">MRI, CT, USG, CBCT with hospital directions and prep checklists. Add driver details for transport if needed.</p>
          <div class="action-footer">
            <span class="pill">Today & Tomorrow</span>
            <button class="badge" type="button">Plan imaging</button>
          </div>
        </div>
      </div>
    </section>

    <section id="booking" class="section booking-shell">
      <header>
        <p class="chip">Booking cockpit</p>
        <h2 class="section-title">Book labs with one view</h2>
        <p class="section-sub">Filter by city, visit type, and slot; saved preferences mirror to the patient dashboard.</p>
      </header>
      <div class="booking-grid card">
        <div class="booking-form">
          <div class="form-row">
            <label class="pill switcher"> <input type="radio" name="visit_mode" checked> Home blood collection </label>
            <label class="pill switcher ghost"> <input type="radio" name="visit_mode"> Visit hospital / lab </label>
          </div>
          <div class="form-row">
            <label>City
              <select>
                <option>Mumbai</option>
                <option>Delhi</option>
                <option>Bengaluru</option>
                <option>Hyderabad</option>
                <option>Chennai</option>
              </select>
            </label>
            <label>Area / Locality
              <input type="text" placeholder="Andheri East, Powai, Koramangala" />
            </label>
          </div>
          <div class="form-row">
            <label>Test type
              <select>
                <option>Blood (CBC, LFT, KFT, HbA1c)</option>
                <option>Radiology (USG, MRI, CT)</option>
                <option>Health package</option>
              </select>
            </label>
            <label>Date & Time
              <div class="input-group">
                <input type="date" />
                <input type="time" />
              </div>
            </label>
          </div>
          <div class="form-row">
            <label>Preferred lab
              <input type="text" placeholder="Apollo, SRL, Thyrocare" />
            </label>
            <label>Notes
              <input type="text" placeholder="Fasting, wheelchair, contrast allergy" />
            </label>
          </div>
          <div class="form-row">
            <button class="badge primary" type="button">Confirm & sync</button>
            <button class="badge" type="button">Save preference to dashboard</button>
          </div>
        </div>
        <div class="booking-summary">
          <div class="summary-block">
            <p class="muted">Pinned tests</p>
            <h3>CBC + LFT + HbA1c</h3>
            <p class="notice">Home visit with sterile kit. Payment link shared after confirmation.</p>
          </div>
          <div class="summary-block">
            <p class="muted">Radiology</p>
            <div class="pill-row">
              <span class="pill">USG Pelvis</span>
              <span class="pill">MRI Spine</span>
              <span class="pill ghost">CT Head</span>
            </div>
            <p class="muted">Directions and prep steps show inside the patient dashboard.</p>
          </div>
          <div class="summary-block">
            <p class="muted">Sync destination</p>
            <div class="signal">Dashboard ‚Üí Labs ‚Üí Upcoming</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section home-visit-board">
      <header>
        <p class="chip">Home visit blood collection</p>
        <h2 class="section-title">Live assignment</h2>
        <p class="section-sub">View phlebotomist routing, sample handling, and ETA. The same view stays pinned inside the dashboard.</p>
      </header>
      <div class="home-grid">
        <div class="card">
          <div class="pill-row">
            <span class="pill">CBC + HbA1c</span>
            <span class="pill ghost">Fasting</span>
          </div>
          <h3>Priya ‚Äî assigned</h3>
          <p class="muted">On the way ‚Ä¢ sanitized kit ‚Ä¢ payment link ready</p>
          <ul class="steps">
            <li>üìç Pickup route locked ‚Äî ETA 35 mins</li>
            <li>üßä Sample storage confirmed</li>
            <li>üì± WhatsApp + Dashboard notifications enabled</li>
          </ul>
        </div>
        <div class="card">
          <div class="pill-row">
            <span class="pill">LFT + KFT</span>
            <span class="pill ghost">Non-fasting</span>
          </div>
          <h3>Backup partner</h3>
          <p class="muted">If the first route fails, we auto-assign another partner and keep your dashboard slot intact.</p>
          <div class="notice">Live tracking mirrored to Dashboard ‚Üí Labs ‚Üí In progress</div>
        </div>
      </div>
    </section>

    <section id="radiology-board" class="section">
      <header>
        <p class="chip">Radiology board</p>
        <h2 class="section-title">Hospitals & slots</h2>
        <p class="section-sub">Prep steps and reports sync automatically. Status updates reuse the same board on your dashboard.</p>
      </header>
      <div class="rad-board">
        <div class="rad-card" data-rad-study>
          <div class="rad-head">
            <div>
              <p class="muted">MRI Spine</p>
              <strong>VOKA Imaging Hub</strong>
            </div>
            <span class="chip" data-rad-status>Ready</span>
          </div>
          <div class="rad-meta">
            <span class="pill">Slot: Today</span>
            <span class="pill ghost" data-rad-eta>Today</span>
            <span class="pill">Sedation ready</span>
          </div>
        </div>
        <div class="rad-card" data-rad-study>
          <div class="rad-head">
            <div>
              <p class="muted">USG Pelvis</p>
              <strong>Apollo Diagnostics</strong>
            </div>
            <span class="chip" data-rad-status>Scheduled</span>
          </div>
          <div class="rad-meta">
            <span class="pill">Slot: Today</span>
            <span class="pill ghost" data-rad-eta>Today</span>
            <span class="pill">Prep: Full bladder</span>
          </div>
        </div>
        <div class="rad-card" data-rad-study>
          <div class="rad-head">
            <div>
              <p class="muted">CT Head</p>
              <strong>City Multi-Slice CT</strong>
            </div>
            <span class="chip" data-rad-status>Pending upload</span>
          </div>
          <div class="rad-meta">
            <span class="pill">Slot: Tomorrow</span>
            <span class="pill ghost" data-rad-eta>Tomorrow</span>
            <span class="pill">Contrast ready</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section section-slab">
      <header>
        <p class="chip">Report sync</p>
        <h2 class="section-title">Everything lands in dashboard</h2>
        <p class="section-sub">Labs, blood panels, radiology DICOM links, and payments show in one place. Click below to jump there.</p>
      </header>
      <div class="flex-row">
        <div class="notice">Dashboard ‚Üí Labs ‚Üí Reports will mirror every booking made here. You can share the dashboard view with your doctor or family.</div>
        <a class="badge primary" href="patient-dashboard.html">Open dashboard</a>
      </div>
    </section>
  </main>

  <footer>
    <p>¬© 2025 HealthFlo ‚Äî Labs</p>
  </footer>

  <script src="js/patient-os.js"></script>
  <script>
    (() => {
      const labResults = document.getElementById('labResults');
      if (!labResults) return;

      const labSearch = document.getElementById('labSearch');
      const labCity = document.getElementById('labCity');
      const labType = document.getElementById('labType');
      const labSort = document.getElementById('labSort');
      const homeOnlyToggle = document.getElementById('homeOnlyToggle');
      const openSlotToggle = document.getElementById('openSlotToggle');
      const labStatus = document.getElementById('labStatus');
      const syncFilters = document.getElementById('syncFilters');
      const locateMe = document.getElementById('locateMe');
      const locationStatus = document.getElementById('locationStatus');
      const cityHint = document.getElementById('cityHint');
      const labsMetaCount = document.getElementById('labsMetaCount');
      const labsHomeCount = document.getElementById('labsHomeCount');
      const labsRadCount = document.getElementById('labsRadCount');
      const labsSortMeta = document.getElementById('labsSortMeta');
      const labsPriceMeta = document.getElementById('labsPriceMeta');
      const labsMetaStatus = document.getElementById('labsMetaStatus');
      const pinDashboard = document.getElementById('pinDashboard');
      const investigationList = document.getElementById('investigationList');
      const investigationMeta = document.getElementById('investigationMeta');

      const fmtINR = (n) => `‚Çπ${Number(n || 0).toLocaleString('en-IN')}`;
      const deg2rad = (d) => d * (Math.PI / 180);
      const haversineKm = (a, b) => {
        const R = 6371;
        const dLat = deg2rad(b.lat - a.lat);
        const dLon = deg2rad(b.lng - a.lng);
        const lat1 = deg2rad(a.lat);
        const lat2 = deg2rad(b.lat);
        const h = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * (Math.sin(dLon / 2) ** 2);
        return R * (2 * Math.asin(Math.sqrt(h)));
      };

      const cityCoords = {
        Mumbai: { lat: 19.076, lng: 72.8777 },
        Delhi: { lat: 28.6139, lng: 77.2090 },
        Bengaluru: { lat: 12.9716, lng: 77.5946 },
        Hyderabad: { lat: 17.3850, lng: 78.4867 },
        Chennai: { lat: 13.0827, lng: 80.2707 },
      };

      const baseBlood = [
        { name: 'Complete Blood Count (CBC)', price: 350 },
        { name: 'Fasting Blood Sugar (FBS)', price: 180 },
        { name: 'Post-Prandial Blood Sugar (PPBS)', price: 200 },
        { name: 'HbA1c', price: 520 },
        { name: 'Lipid Profile', price: 900 },
        { name: 'Liver Function Test (LFT)', price: 950 },
        { name: 'Kidney Function Test (KFT)', price: 900 },
        { name: 'Vitamin D (25-OH)', price: 1200 },
        { name: 'Thyroid Profile (T3/T4/TSH)', price: 650 },
        { name: 'C-Reactive Protein (CRP)', price: 550 },
        { name: 'Urine Routine', price: 180 }
      ];

      const baseRad = [
        { name: 'X-Ray Chest PA', price: 450 },
        { name: 'Ultrasound Whole Abdomen', price: 1400 },
        { name: 'CT Brain (Plain)', price: 2500 },
        { name: 'MRI Knee', price: 5200 },
        { name: 'ECG', price: 300 },
        { name: '2D Echo', price: 1800 }
      ];

      const slotPool = [
        'Today ‚Ä¢ 4:30 PM',
        'Today ‚Ä¢ 6:00 PM',
        'Today ‚Ä¢ MRI/CT',
        'Today ‚Ä¢ Counter',
        'Tomorrow ‚Ä¢ 9:15 AM'
      ];

      const labs = [
        { id: 'lab01', name: 'Apollo Diagnostics', city: 'Mumbai', area: 'Andheri', lat: 19.118, lng: 72.846, phone: '+912241234567', homeVisit: true, homeFee: 129, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab02', name: 'Thyrocare Centre', city: 'Mumbai', area: 'Powai', lat: 19.118, lng: 72.905, phone: '+912242345678', homeVisit: true, homeFee: 99, img: 'https://images.unsplash.com/photo-1504439468489-c8920d796a29?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab03', name: 'SRL Diagnostics', city: 'Delhi', area: 'Dwarka', lat: 28.592, lng: 77.046, phone: '+911145678901', homeVisit: true, homeFee: 149, img: 'https://images.unsplash.com/photo-1526256262350-7da7584cf5eb?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab04', name: 'Metropolis Lab', city: 'Delhi', area: 'Preet Vihar', lat: 28.636, lng: 77.289, phone: '+911123456789', homeVisit: true, homeFee: 129, img: 'https://images.unsplash.com/photo-1582719478145-bf0f1f6b68ff?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab05', name: 'Dr. Lal PathLabs', city: 'Bengaluru', area: 'Jayanagar', lat: 12.925, lng: 77.593, phone: '+918023456701', homeVisit: true, homeFee: 119, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab06', name: 'Vijaya Diagnostics', city: 'Hyderabad', area: 'Banjara Hills', lat: 17.416, lng: 78.448, phone: '+914040123456', homeVisit: true, homeFee: 129, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab07', name: 'Aster Labs', city: 'Bengaluru', area: 'Whitefield', lat: 12.969, lng: 77.749, phone: '+918022223333', homeVisit: true, homeFee: 149, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab08', name: 'Hitech Diagnostics', city: 'Chennai', area: 'T. Nagar', lat: 13.041, lng: 80.234, phone: '+914428765432', homeVisit: true, homeFee: 109, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab09', name: 'Kokilaben Ambani Lab', city: 'Mumbai', area: 'Four Bungalows', lat: 19.134, lng: 72.833, phone: '+912261111111', homeVisit: false, homeFee: 0, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab10', name: 'Max Lab', city: 'Delhi', area: 'Saket', lat: 28.528, lng: 77.219, phone: '+911149876543', homeVisit: true, homeFee: 159, img: 'https://images.unsplash.com/photo-1504439468489-c8920d796a29?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab11', name: 'Fortis Lab', city: 'Noida', area: 'Sector 62', lat: 28.62, lng: 77.363, phone: '+911202223344', homeVisit: true, homeFee: 149, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab12', name: 'Medall Diagnostics', city: 'Chennai', area: 'Adyar', lat: 13.006, lng: 80.257, phone: '+914443211234', homeVisit: true, homeFee: 119, img: 'https://images.unsplash.com/photo-1582719478145-bf0f1f6b68ff?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab13', name: 'Suburban Diagnostics', city: 'Pune', area: 'Aundh', lat: 18.563, lng: 73.807, phone: '+912040987654', homeVisit: true, homeFee: 139, img: 'https://images.unsplash.com/photo-1504439468489-c8920d796a29?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab14', name: 'Oncquest Labs', city: 'Jaipur', area: 'C-Scheme', lat: 26.913, lng: 75.789, phone: '+911414567890', homeVisit: true, homeFee: 149, img: 'https://images.unsplash.com/photo-1504439468489-c8920d796a29?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab15', name: 'Redcliffe Labs', city: 'Lucknow', area: 'Gomti Nagar', lat: 26.853, lng: 81.003, phone: '+915224567890', homeVisit: true, homeFee: 119, img: 'https://images.unsplash.com/photo-1504439468489-c8920d796a29?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab16', name: 'Healthians', city: 'Gurugram', area: 'DLF Phase 3', lat: 28.494, lng: 77.097, phone: '+911244567890', homeVisit: true, homeFee: 99, img: 'https://images.unsplash.com/photo-1586773860418-d37222d8fce3?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab17', name: 'Diagno Labs', city: 'Ahmedabad', area: 'Navrangpura', lat: 23.036, lng: 72.558, phone: '+917926543210', homeVisit: true, homeFee: 129, img: 'https://images.unsplash.com/photo-1504439468489-c8920d796a29?q=80&auto=format&fit=crop&w=1200' },
        { id: 'lab18', name: 'Aarthi Scans & Labs', city: 'Kochi', area: 'Vytilla', lat: 9.967, lng: 76.318, phone: '+914844445555', homeVisit: true, homeFee: 109, img: 'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&auto=format&fit=crop&w=1200' }
      ].map((lab, idx) => {
        const bloodMul = 0.92 + (idx % 5) * 0.03;
        const radMul = 1.0 + (idx % 4) * 0.05;
        lab.blood = baseBlood.map(t => ({ ...t, price: Math.round(t.price * bloodMul) }));
        lab.radiology = baseRad.map(t => ({ ...t, price: Math.round(t.price * radMul) }));
        lab.tests = [...lab.blood, ...lab.radiology];
        lab.type = [];
        if (lab.blood.length) lab.type.push('blood');
        if (lab.radiology.length) lab.type.push('radiology');
        lab.slot = slotPool[idx % slotPool.length];
        lab.rating = 4.2 + (idx % 6) * 0.1;
        lab.open = idx % 4 !== 0;
        lab.fallbackDistance = (1.2 + (idx % 7) * 0.7).toFixed(1);
        return lab;
      });

      let userLoc = null;
      const filterKey = 'hf_lab_filters_v2';

      function saveFilters() {
        const payload = {
          q: labSearch?.value || '',
          city: labCity?.value || '',
          type: labType?.value || '',
          sort: labSort?.value || 'nearest',
          home: !!homeOnlyToggle?.checked,
          open: !!openSlotToggle?.checked,
        };
        localStorage.setItem(filterKey, JSON.stringify(payload));
      }

      function restoreFilters() {
        const saved = localStorage.getItem(filterKey);
        if (!saved) return;
        try {
          const filters = JSON.parse(saved);
          if (labSearch) labSearch.value = filters.q || '';
          if (labCity && filters.city) labCity.value = filters.city;
          if (labType && filters.type) labType.value = filters.type;
          if (labSort && filters.sort) labSort.value = filters.sort;
          if (homeOnlyToggle) homeOnlyToggle.checked = !!filters.home;
          if (openSlotToggle) openSlotToggle.checked = !!filters.open;
          if (!userLoc && filters.city && cityCoords[filters.city]) {
            userLoc = cityCoords[filters.city];
            if (locationStatus) locationStatus.textContent = `Using ${filters.city} center for distance`;
            if (cityHint) cityHint.textContent = `City: ${filters.city}`;
          }
        } catch {
          /* ignore */
        }
      }

      function distanceFor(lab) {
        if (userLoc) {
          return Number(haversineKm(userLoc, { lat: lab.lat, lng: lab.lng }).toFixed(1));
        }
        return Number(lab.fallbackDistance);
      }

      const selections = {};

      function getSel(id) {
        if (!selections[id]) {
          selections[id] = { blood: new Set(), rad: new Set(), home: false };
        }
        return selections[id];
      }

      function renderTests(tests, type) {
        const list = tests
          .filter(t => !type || t.type === type)
          .slice(0, 4)
          .map(t => `<span class="test-chip price-pill">${t.name} <strong>${fmtINR(t.price)}</strong></span>`)
          .join('');
        return list || '<span class="pill ghost">All investigations shown in modal</span>';
      }

      const labModal = document.getElementById('labModal');
      const labModalTitle = document.getElementById('labModalTitle');
      const labModalLocation = document.getElementById('labModalLocation');
      const labModalHome = document.getElementById('labModalHome');
      const labModalDistance = document.getElementById('labModalDistance');
      const labModalCounts = document.getElementById('labModalCounts');
      const labModalDirections = document.getElementById('labModalDirections');
      const labModalCall = document.getElementById('labModalCall');
      const labModalWA = document.getElementById('labModalWA');
      const labModalClose = document.getElementById('labModalClose');
      const tabButtons = Array.from(document.querySelectorAll('.lab-modal__tabs [data-tab]'));
      const panels = Array.from(document.querySelectorAll('.lab-modal__panel'));
      const bloodList = document.getElementById('bloodList');
      const radList = document.getElementById('radList');
      const bloodSearch = document.getElementById('bloodSearch');
      const radSearch = document.getElementById('radSearch');
      const bloodHomeToggle = document.getElementById('bloodHomeToggle');
      const homeFeeText = document.getElementById('homeFeeText');
      const bloodClear = document.getElementById('bloodClear');
      const radClear = document.getElementById('radClear');
      const bloodWA = document.getElementById('bloodWA');
      const radWA = document.getElementById('radWA');
      const bloodCount = document.getElementById('bloodCount');
      const radCount = document.getElementById('radCount');
      const bloodTotal = document.getElementById('bloodTotal');
      const radTotal = document.getElementById('radTotal');
      const bookSummary = document.getElementById('bookSummary');
      const bookTotal = document.getElementById('bookTotal');

      let currentLab = null;

      function setActiveTab(tab) {
        tabButtons.forEach(btn => {
          const active = btn.dataset.tab === tab;
          btn.classList.toggle('ghost', !active);
          btn.setAttribute('aria-selected', active);
        });
        panels.forEach(panel => {
          panel.classList.toggle('hidden', panel.dataset.panel !== tab);
        });
      }

      tabButtons.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

      function renderModalList(listEl, tests, selSet, query = '') {
        if (!listEl) return;
        listEl.innerHTML = '';
        const q = query.trim().toLowerCase();
        tests
          .filter(t => !q || t.name.toLowerCase().includes(q))
          .forEach(test => {
            const row = document.createElement('div');
            row.className = 'modal-row';
            row.innerHTML = `
              <label>
                <input type="checkbox" ${selSet.has(test.name) ? 'checked' : ''} />
                <span>${test.name}</span>
              </label>
              <strong>${fmtINR(test.price)}</strong>
            `;
            const checkbox = row.querySelector('input');
            checkbox.addEventListener('change', () => {
              if (checkbox.checked) selSet.add(test.name);
              else selSet.delete(test.name);
              updateTotals();
            });
            listEl.appendChild(row);
          });

        if (!listEl.children.length) {
          const empty = document.createElement('div');
          empty.className = 'notice';
          empty.textContent = 'No tests match this search yet.';
          listEl.appendChild(empty);
        }
      }

      function updateTotals() {
        if (!currentLab) return;
        const sel = getSel(currentLab.id);
        const bloodSel = currentLab.blood.filter(t => sel.blood.has(t.name));
        const radSel = currentLab.radiology.filter(t => sel.rad.has(t.name));
        const bloodFee = sel.home && currentLab.homeVisit ? currentLab.homeFee : 0;
        const bloodSum = bloodSel.reduce((a, t) => a + t.price, 0) + bloodFee;
        const radSum = radSel.reduce((a, t) => a + t.price, 0);

        if (bloodCount) bloodCount.textContent = bloodSel.length;
        if (bloodTotal) bloodTotal.textContent = fmtINR(bloodSum);
        if (radCount) radCount.textContent = radSel.length;
        if (radTotal) radTotal.textContent = fmtINR(radSum);

        if (bookSummary) {
          if (!bloodSel.length && !radSel.length) {
            bookSummary.textContent = 'No tests selected yet.';
          } else {
            const lines = [];
            if (bloodSel.length) {
              lines.push('Blood:');
              bloodSel.forEach(t => lines.push(`‚Ä¢ ${t.name} ‚Äî ${fmtINR(t.price)}`));
              if (bloodFee) lines.push(`‚Ä¢ Home fee ‚Äî ${fmtINR(bloodFee)}`);
            }
            if (radSel.length) {
              lines.push('Radiology:');
              radSel.forEach(t => lines.push(`‚Ä¢ ${t.name} ‚Äî ${fmtINR(t.price)}`));
            }
            bookSummary.textContent = lines.join('\n');
          }
        }
        if (bookTotal) bookTotal.textContent = fmtINR(bloodSum + radSum);
      }

      function openLabModal(lab) {
        currentLab = lab;
        setActiveTab('blood');
        const sel = getSel(lab.id);
        if (labModalTitle) labModalTitle.textContent = lab.name;
        if (labModalLocation) labModalLocation.textContent = `${lab.city}, ${lab.area}`;
        if (labModalHome) labModalHome.textContent = lab.homeVisit ? `Home visit ‚Ä¢ Fee ${fmtINR(lab.homeFee)}` : 'In-lab only';
        if (labModalDistance) labModalDistance.textContent = lab.distanceKm ? `${lab.distanceKm.toFixed(1)} km` : '‚Äî km';
        if (labModalCounts) labModalCounts.textContent = `${lab.blood.length} blood ‚Ä¢ ${lab.radiology.length} radiology`;
        if (homeFeeText) homeFeeText.textContent = lab.homeVisit ? `Home fee: ${fmtINR(lab.homeFee)}` : 'Home collection not available';
        if (bloodHomeToggle) {
          bloodHomeToggle.disabled = !lab.homeVisit;
          bloodHomeToggle.checked = !!sel.home && lab.homeVisit;
        }
        if (labModalDirections) labModalDirections.href = `https://www.google.com/maps?q=${encodeURIComponent(lab.name)}@${lab.lat},${lab.lng}`;
        if (labModalCall) labModalCall.href = `tel:${lab.phone}`;
        if (labModalWA) labModalWA.href = `https://wa.me/?text=${encodeURIComponent(`Hi ${lab.name}, I want to book tests.`)}`;

        renderModalList(bloodList, lab.blood, sel.blood, bloodSearch?.value || '');
        renderModalList(radList, lab.radiology, sel.rad, radSearch?.value || '');
        updateTotals();

        labModal?.classList.add('open');
        labModal?.setAttribute('aria-hidden', 'false');
      }

      function closeLabModal() {
        labModal?.classList.remove('open');
        labModal?.setAttribute('aria-hidden', 'true');
        currentLab = null;
      }

      labModalClose?.addEventListener('click', closeLabModal);
      labModal?.addEventListener('click', (e) => {
        if (e.target === labModal) closeLabModal();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && labModal?.classList.contains('open')) closeLabModal();
      });

      bloodHomeToggle?.addEventListener('change', () => {
        if (!currentLab) return;
        getSel(currentLab.id).home = bloodHomeToggle.checked;
        updateTotals();
      });

      bloodSearch?.addEventListener('input', () => {
        if (!currentLab) return;
        renderModalList(bloodList, currentLab.blood, getSel(currentLab.id).blood, bloodSearch.value);
      });
      radSearch?.addEventListener('input', () => {
        if (!currentLab) return;
        renderModalList(radList, currentLab.radiology, getSel(currentLab.id).rad, radSearch.value);
      });

      bloodClear?.addEventListener('click', () => {
        if (!currentLab) return;
        getSel(currentLab.id).blood.clear();
        renderModalList(bloodList, currentLab.blood, getSel(currentLab.id).blood, bloodSearch?.value || '');
        updateTotals();
      });
      radClear?.addEventListener('click', () => {
        if (!currentLab) return;
        getSel(currentLab.id).rad.clear();
        renderModalList(radList, currentLab.radiology, getSel(currentLab.id).rad, radSearch?.value || '');
        updateTotals();
      });

      bloodWA?.addEventListener('click', () => {
        if (!currentLab) return;
        const sel = getSel(currentLab.id);
        const picks = currentLab.blood.filter(t => sel.blood.has(t.name));
        if (!picks.length) return;
        const fee = sel.home && currentLab.homeVisit ? currentLab.homeFee : 0;
        const total = picks.reduce((a, t) => a + t.price, 0) + fee;
        const msg = [
          `Blood tests ‚Äî ${currentLab.name} (${currentLab.area})`,
          ...picks.map(t => `‚Ä¢ ${t.name} ‚Äî ${fmtINR(t.price)}`),
          fee ? `‚Ä¢ Home fee ‚Äî ${fmtINR(fee)}` : '',
          `Total ‚Äî ${fmtINR(total)}`
        ].filter(Boolean).join('\n');
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      });

      radWA?.addEventListener('click', () => {
        if (!currentLab) return;
        const sel = getSel(currentLab.id);
        const picks = currentLab.radiology.filter(t => sel.rad.has(t.name));
        if (!picks.length) return;
        const total = picks.reduce((a, t) => a + t.price, 0);
        const msg = [
          `Radiology ‚Äî ${currentLab.name} (${currentLab.area})`,
          ...picks.map(t => `‚Ä¢ ${t.name} ‚Äî ${fmtINR(t.price)}`),
          `Total ‚Äî ${fmtINR(total)}`
        ].join('\n');
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
      });

      function updateMeta(filtered, type) {
        if (!labsMetaCount) return;
        const home = filtered.filter(l => l.homeVisit).length;
        const rad = filtered.filter(l => l.type.includes('radiology')).length;
        const pool = filtered.flatMap(l => l.tests.filter(t => !type || t.type === type).map(t => t.price));
        const avg = pool.length ? Math.round(pool.reduce((a, b) => a + b, 0) / pool.length) : null;

        labsMetaCount.textContent = `${filtered.length} labs nearby`;
        labsHomeCount.textContent = `${home} home visit`;
        labsRadCount.textContent = `${rad} radiology hubs`;
        labsPriceMeta.textContent = avg ? fmtINR(avg) : '‚Çπ‚Äî';
        labsMetaStatus.textContent = `${home} home pickups ¬∑ ${rad} imaging hubs ¬∑ synced with dashboard`;
        labsSortMeta.textContent = (labSort?.value || '') === 'az' ? 'A‚ÄìZ sort' : 'Nearest first';
        if (investigationMeta) investigationMeta.textContent = `Pulled from ${filtered.length} labs`;
      }

      function buildInvestigationBoard(filtered, type) {
        if (!investigationList) return;
        investigationList.innerHTML = '';
        const map = new Map();

        filtered.forEach(lab => {
          lab.tests
            .filter(t => !type || t.type === type)
            .forEach(test => {
              const key = test.name;
              const existing = map.get(key) || { name: test.name, type: test.type, price: test.price, labs: 0, home: 0 };
              existing.price = Math.min(existing.price, test.price);
              existing.labs += 1;
              if (lab.homeVisit) existing.home += 1;
              map.set(key, existing);
            });
        });

        const top = Array.from(map.values())
          .sort((a, b) => a.price - b.price)
          .slice(0, 8);

        if (!top.length) {
          investigationList.innerHTML = '<div class="notice">No investigations found for the current filters.</div>';
          return;
        }

        top.forEach(test => {
          const row = document.createElement('div');
          row.className = 'investigation-row';
          row.innerHTML = `
            <div class="stack">
              <strong>${test.name}</strong>
              <small>${test.type === 'blood' ? 'Blood / pathology' : 'Radiology / imaging'}</small>
            </div>
            <div class="stack">
              <small>Starting</small>
              <strong>${fmtINR(test.price)}</strong>
            </div>
            <div class="stack">
              <small>Labs</small>
              <span class="pill">${test.labs} nearby</span>
            </div>
            <div class="stack">
              <small>Home pickup</small>
              <span class="pill ${test.home ? '' : 'ghost'}">${test.home ? `${test.home} offer home visit` : 'Visit lab'}</span>
            </div>
          `;
          investigationList.appendChild(row);
        });
      }

      function renderEmptyState(message) {
        labResults.innerHTML = `<div class="notice">${message}</div>`;
        if (labStatus) labStatus.textContent = message;
        if (investigationList) investigationList.innerHTML = '<div class="notice">No investigations for this filter set.</div>';
      }

      function renderLabs() {
        const query = (labSearch?.value || '').trim().toLowerCase();
        const city = labCity?.value || '';
        const type = labType?.value || '';
        const homeOnly = homeOnlyToggle?.checked;
        const openOnly = openSlotToggle?.checked;

        saveFilters();

        let filtered = labs.filter(lab => {
          if (city && lab.city !== city) return false;
          if (type && !lab.type.includes(type)) return false;
          if (homeOnly && !lab.homeVisit) return false;
          if (openOnly && !lab.open) return false;
          if (query) {
            const blob = `${lab.name} ${lab.city} ${lab.area} ${lab.tests.map(t => t.name).join(' ')}`.toLowerCase();
            if (!blob.includes(query)) return false;
          }
          return true;
        });

        filtered = filtered.map(lab => ({ ...lab, distanceKm: distanceFor(lab) }));

        if ((labSort?.value || '') === 'az') {
          filtered.sort((a, b) => a.name.localeCompare(b.name));
        } else {
          filtered.sort((a, b) => (a.distanceKm ?? 9999) - (b.distanceKm ?? 9999));
        }

        if (!filtered.length) {
          renderEmptyState('No labs match these filters yet. Try another city or clear toggles.');
          updateMeta([], type);
          return;
        }

        labResults.innerHTML = '';
        filtered.forEach(lab => {
          const tests = type === 'blood' ? lab.blood : type === 'radiology' ? lab.radiology : lab.tests;
          const startPrice = tests.length ? Math.min(...tests.map(t => t.price)) : null;
          const card = document.createElement('article');
          card.className = 'lab-card zomato-card advanced';
          card.innerHTML = `
            <div class="lab-img" style="background-image:url('${lab.img}')">
              <div class="lab-badge-row">
                <span class="pill">${lab.distanceKm?.toFixed ? lab.distanceKm.toFixed(1) : '‚Äî'} km</span>
              </div>
            </div>
            <div class="lab-body">
              <h3>${lab.name}</h3>
              <p class="muted">${lab.area} ‚Ä¢ ${lab.city}</p>
              <div class="lab-meta-row">
                <span class="pill">Home visit ${lab.homeVisit ? 'Yes' : 'No'}</span>
                <span class="pill ghost">${lab.homeVisit ? `Fee ${fmtINR(lab.homeFee)}` : 'Visit lab'}</span>
                <span class="pill">${lab.distanceKm?.toFixed ? lab.distanceKm.toFixed(1) : '‚Äî'} km</span>
                <span class="pill ghost">${lab.tests.length} blood & radiology</span>
              </div>
              <div class="price-line">Starts at <strong>${startPrice ? fmtINR(startPrice) : '‚Çπ‚Äî'}</strong> ‚Ä¢ ${lab.slot}</div>
              <div class="lab-tests inline-tests">${renderTests(tests, type)}</div>
              <div class="card-actions">
                <button class="badge primary" type="button" data-action="view">View</button>
                <a class="badge" href="https://www.google.com/maps?q=${encodeURIComponent(lab.name)}@${lab.lat},${lab.lng}" target="_blank" rel="noopener">Directions</a>
                <a class="badge ghost" href="tel:${lab.phone}">Call</a>
              </div>
            </div>
          `;

          card.querySelector('[data-action="view"]')?.addEventListener('click', () => openLabModal(lab));
          card.addEventListener('click', (e) => {
            if (e.target.closest('a')) return;
            openLabModal(lab);
          });

          labResults.appendChild(card);
        });
        
        if (labStatus) {
          labStatus.textContent = `${filtered.length} labs ready ¬∑ filters mirrored to dashboard`;
        }

        updateMeta(filtered, type);
        buildInvestigationBoard(filtered, type);
      }

      [labSearch, labCity, labType, labSort, homeOnlyToggle, openSlotToggle].forEach(el => {
        el?.addEventListener('input', renderLabs);
        el?.addEventListener('change', renderLabs);
      });

      syncFilters?.addEventListener('click', () => {
        if (!labStatus) return;
        labStatus.textContent = 'Filters synced to dashboard ‚úî';
        labStatus.classList.add('accent-text');
        setTimeout(() => labStatus.classList.remove('accent-text'), 1800);
      });

      pinDashboard?.addEventListener('click', () => {
        labsMetaStatus.textContent = 'Pinned to dashboard ‚Üí Labs';
        labsMetaStatus.classList.add('accent-text');
        setTimeout(() => labsMetaStatus.classList.remove('accent-text'), 1800);
      });

      locateMe?.addEventListener('click', () => {
        if (!navigator.geolocation) {
          if (locationStatus) locationStatus.textContent = 'Geolocation not supported on this device';
          return;
        }
        if (locationStatus) locationStatus.textContent = 'Detecting location‚Ä¶';
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            if (locationStatus) locationStatus.textContent = 'Using your live location';
            if (cityHint) cityHint.textContent = 'City: Auto (nearest)';
            renderLabs();
          },
          () => {
            if (locationStatus) locationStatus.textContent = 'Unable to fetch location ‚Äî using saved preference';
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });

      restoreFilters();
      renderLabs();
    })();
  </script>
</body>
</html>
