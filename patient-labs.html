<!DOCTYPE html>
<html lang="en" data-theme="matte">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patient Labs & Investigations</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f18;
      --panel: #111827;
      --panel-2: #182235;
      --panel-3: #0f1724;
      --text: #f6f8ff;
      --muted: #9db0d9;
      --primary: #7dd3fc;
      --primary-strong: #1fb6ff;
      --accent: #a9ffcb;
      --accent-2: #fbbf24;
      --danger: #ff9ea9;
      --chip: #1f2a3d;
      --border: #22314b;
      --shadow: 0 24px 60px rgba(2,6,23,0.55);
      --radius: 18px;
      --glass: rgba(255,255,255,0.04);
      --blur: blur(12px);
      --glow: 0 12px 46px rgba(125,211,252,0.38);
      --pulse: drop-shadow(0 0 14px rgba(113,198,255,0.35));
    }
    [data-theme="day"] {
      --bg: #f7f9ff;
      --panel: #ffffff;
      --panel-2: #f0f4ff;
      --panel-3: #e7eeff;
      --text: #0c1220;
      --muted: #617099;
      --primary: #1f7bff;
      --primary-strong: #0f5ed2;
      --accent: #0fb48c;
      --accent-2: #d97706;
      --danger: #eb3b5a;
      --chip: #e8edfa;
      --border: #d8dff1;
      --shadow: 0 18px 40px rgba(21,34,70,0.12);
      --glass: rgba(255,255,255,0.85);
      --blur: blur(0px);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 12% 18%, rgba(125,211,252,0.14), transparent 28%),
                  radial-gradient(circle at 88% 8%, rgba(249,115,22,0.12), transparent 28%),
                  linear-gradient(135deg, rgba(125,211,252,0.08), rgba(15,180,140,0.08)),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: inherit; text-decoration: none; }
    button, input, select, textarea { font-family: inherit; }
    header.site-head {
      position: sticky; top: 0; z-index: 30;
      backdrop-filter: blur(16px);
      background: rgba(15,17,21,0.8);
      border-bottom: 1px solid var(--border);
    }
    [data-theme="day"] header.site-head { background: rgba(255,255,255,0.9); }
    .head-inner { display:flex; align-items:center; justify-content:space-between; padding:16px 24px; max-width:1200px; margin:0 auto; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:-0.5px; }
    .brand .dot { width:12px; height:12px; border-radius:50%; background:linear-gradient(135deg, var(--primary), var(--accent)); box-shadow:0 0 20px rgba(113,198,255,0.5); }
    .nav-links { display:flex; gap:12px; align-items:center; }
    .nav-links a { padding:10px 14px; border-radius:12px; background:transparent; color:var(--muted); font-weight:600; transition:0.2s; }
    .nav-links a:hover, .nav-links a.active { color:var(--text); background:var(--panel-2); }
    .icon-btn, .pill-btn, .chip, .badge { position:relative; overflow:hidden; }
    .icon-btn { width:40px; height:40px; border-radius:12px; border:1px solid var(--border); background:var(--panel-2); color:var(--text); cursor:pointer; transition:transform 0.2s; }
    .icon-btn:active { transform:scale(0.96); }
    main { max-width:1200px; margin:0 auto; padding:24px; display:flex; flex-direction:column; gap:20px; }
    .pulse { animation:pulse 2.8s ease-in-out infinite; }
    @keyframes pulse { 0% { transform:translateY(0);} 50% { transform:translateY(-2px);} 100% { transform:translateY(0);} }
    .shine { position:relative; overflow:hidden; }
    .shine::after { content:""; position:absolute; inset:0; background:linear-gradient(120deg, transparent 10%, rgba(255,255,255,0.06) 40%, transparent 60%);
      transform:translateX(-120%); animation:shine 6s linear infinite; }
    @keyframes shine { to { transform:translateX(120%); } }
    .hero { display:grid; grid-template-columns:1.1fr 0.9fr; gap:16px; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); position:relative; }
    .card h1, .card h2, .card h3 { margin:6px 0; }
    .muted { color:var(--muted); }
    .hero-title { font-size:32px; line-height:1.2; margin:8px 0; }
    .hero-sub { color:var(--muted); margin-bottom:16px; }
    .metrics { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin-top:10px; }
    .metric { background:var(--panel-2); border:1px solid var(--border); border-radius:14px; padding:10px; }
    .metric strong { font-size:22px; display:block; }
    .metric.animate { animation:pop 0.9s ease; }
    @keyframes pop { 0% { transform:scale(0.9); opacity:0.2; } 100% { transform:scale(1); opacity:1; } }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--panel-2); color:var(--text); cursor:pointer; font-weight:700; }
    .badge.primary { background:linear-gradient(135deg, var(--primary), var(--accent)); color:#041019; border:none; }
    .badge.ghost { background:var(--chip); }
    .toolbar { background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:8px; align-items:center; box-shadow:var(--shadow); }
    .toolbar label { display:flex; flex-direction:column; gap:4px; font-weight:800; color:var(--muted); font-size:13px; }
    .toolbar input, .toolbar select { padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(135deg,var(--panel-2),var(--panel-3)); color:var(--text); min-width:0; width:100%; }
    .toolbar .toggles { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--text); font-weight:700; letter-spacing:-0.1px; }
    .assurance { display:flex; gap:10px; flex-wrap:wrap; }
    .assurance .chip { background:var(--panel-2); border:1px solid var(--border); }
    .insights { display:grid; grid-template-columns:1.1fr 0.9fr; gap:12px; }
    .insight-list { display:flex; flex-direction:column; gap:10px; }
    .insight-row { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--panel-2); }
    .insight-row strong { display:block; }
    .insight-row small { color:var(--muted); display:block; }
    .status-badge { padding:6px 10px; border-radius:999px; font-weight:800; border:1px solid var(--border); }
    .status-badge.good { background:rgba(139,255,181,0.14); color:var(--accent); border-color:rgba(139,255,181,0.3); }
    .status-badge.warn { background:rgba(255,158,169,0.14); color:var(--danger); border-color:rgba(255,158,169,0.3); }
    .status-badge.neutral { background:var(--chip); color:var(--text); }
    .report-card { border:1px dashed var(--border); border-radius:14px; padding:12px; background:var(--panel-2); }
    .timeline { display:flex; gap:10px; flex-wrap:wrap; }
    .timeline .chip { background:var(--panel); }
    .sync-btn { display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(135deg, var(--primary), var(--accent)); color:#041019; font-weight:800; cursor:pointer; box-shadow:var(--glow); }
    .sync-btn:active { transform:scale(0.97); }
    .status-line { color:var(--muted); font-weight:600; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px; }
    .lab-card { display:flex; flex-direction:column; gap:10px; cursor:pointer; transition:transform 0.2s, border 0.2s; }
    .lab-card:hover { transform:translateY(-4px); border-color:var(--primary); }
    .lab-img { width:100%; height:150px; border-radius:14px; object-fit:cover; background:linear-gradient(135deg, rgba(113,198,255,0.12), rgba(139,255,181,0.12)); }
    .label-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chip); color:var(--text); font-weight:700; border:1px solid var(--border); }
    .pill.good { background:rgba(139,255,181,0.14); border-color:rgba(139,255,181,0.3); color:var(--accent); }
    .pill.badge { padding:8px 12px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .actions .tiny { padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:var(--panel-2); font-weight:700; cursor:pointer; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:flex-end; justify-content:center; z-index:200; opacity:0; pointer-events:none; transition:0.25s ease; }
    .modal.show { opacity:1; pointer-events:auto; }
    .sheet { width:100%; max-width:1080px; max-height:90vh; border-radius:24px 24px 0 0; background:var(--panel); box-shadow:0 30px 60px rgba(0,0,0,0.45); overflow:hidden; display:flex; flex-direction:column; }
    .sheet-head { display:flex; gap:12px; justify-content:space-between; padding:18px; border-bottom:1px solid var(--border); background:var(--panel-2); }
    .sheet-meta { display:flex; gap:12px; align-items:center; }
    .logo { width:48px; height:48px; border-radius:14px; background:linear-gradient(135deg, var(--primary), var(--accent)); display:grid; place-items:center; font-weight:800; color:#041019; }
    .tabs { display:flex; gap:8px; padding:14px 18px; border-bottom:1px solid var(--border); }
    .tabs button { padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--chip); color:var(--text); cursor:pointer; font-weight:700; }
    .tabs button[aria-selected="true"] { background:linear-gradient(135deg, var(--primary), var(--accent)); color:#041019; border:none; }
    .panel { padding:18px; overflow:auto; flex:1; display:none; }
    .panel.active { display:block; }
    .panel .modal-toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .modal-list { display:flex; flex-direction:column; gap:10px; }
    .test-row { display:flex; justify-content:space-between; align-items:flex-start; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel-2); gap:8px; }
    .test-row label { display:flex; gap:10px; align-items:flex-start; cursor:pointer; font-weight:700; flex:1; }
    .test-why { color:var(--muted); font-weight:600; margin:4px 0 0; font-size:13px; line-height:1.4; }
    .test-price-wrap { text-align:right; min-width:90px; }
    .modal-foot { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px; border-top:1px solid var(--border); background:var(--panel-2); border-radius:12px; }
    .booking-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .booking-grid label { display:flex; flex-direction:column; gap:6px; color:var(--muted); font-weight:700; }
    .booking-grid input, .booking-grid select { padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--panel-2); color:var(--text); }
    details.profile { border:1px solid var(--border); border-radius:12px; padding:10px; background:var(--panel-2); }
    details.profile summary { cursor:pointer; font-weight:800; }
    .toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--panel-2); border:1px solid var(--border); color:var(--text); padding:12px 16px; border-radius:12px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:0.25s; z-index:300; }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    .ripple { position:absolute; border-radius:50%; transform:scale(0); animation:ripple 500ms linear; background:rgba(255,255,255,0.5); pointer-events:none; }
    @keyframes ripple { to { transform:scale(3); opacity:0; } }
    @media (max-width:900px) {
      .hero { grid-template-columns:1fr; }
      .insights { grid-template-columns:1fr; }
      .booking-grid { grid-template-columns:1fr; }
      .sheet { max-height:95vh; border-radius:20px 20px 0 0; }
    }
  </style>
</head>
<body>
  <header class="site-head">
    <div class="head-inner">
      <div class="brand"><span class="dot"></span>Patient Labs</div>
      <nav class="nav-links">
        <a href="patient-dashboard.html">Dashboard</a>
        <a href="patient-profile.html">Profile</a>
        <a class="active" href="patient-labs.html">Labs</a>
      </nav>
      <div class="nav-links">
        <button class="icon-btn" id="themeToggle" aria-label="Toggle theme">üåì</button>
        <button class="icon-btn" aria-label="Notifications">üîî</button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="card">
        <p class="chip">Labs ‚Ä¢ Hospitals ‚Ä¢ Radiology</p>
        <h1 class="hero-title">Find verified labs, book blood pickup, or plan imaging with one tap</h1>
        <p class="hero-sub">Now showing hospitals and boutique labs in Mumbai, Delhi, Bengaluru, Hyderabad, and Chennai. Compact filters, live GPS distance, and bright visuals keep nearby options addictive to browse.</p>
        <div class="metrics">
          <div class="metric"><small class="muted">Visible labs</small><strong id="visibleCount">‚Äî</strong><span class="muted">Based on filters</span></div>
          <div class="metric"><small class="muted">Home visit ready</small><strong id="homeCount">‚Äî</strong><span class="muted">Labs offering home pickup</span></div>
          <div class="metric"><small class="muted">Radiology hubs</small><strong id="radCount">‚Äî</strong><span class="muted">Labs with imaging</span></div>
          <div class="metric"><small class="muted">Avg. blood panel</small><strong id="avgPrice">‚Çπ‚Äî</strong><span class="muted">Based on filtered labs</span></div>
        </div>
      </div>
      <div class="card">
        <h3>Live counters</h3>
        <p class="muted">Track how filters and search change the set. Nearest-first uses your saved or requested location.</p>
        <div class="metrics">
          <div class="metric"><small class="muted">Sort</small><strong id="sortMeta">A‚ÄìZ</strong><span class="muted">Toggles on toolbar</span></div>
          <div class="metric"><small class="muted">Location</small><strong id="locationMeta">Saved</strong><span class="muted">Tap locate to refresh</span></div>
          <div class="metric"><small class="muted">Home fee avg</small><strong id="homeFeeMeta">‚Çπ‚Äî</strong><span class="muted">For labs allowing home visit</span></div>
        </div>
      </div>
    </section>

    <section class="toolbar">
      <label>Search labs or tests
        <input id="searchInput" type="search" placeholder="Search labs, city, test name" />
      </label>
      <label>City
        <select id="cityFilter">
          <option value="">All</option>
          <option>Mumbai</option>
          <option>Delhi</option>
          <option>Bengaluru</option>
          <option>Hyderabad</option>
          <option>Chennai</option>
        </select>
      </label>
      <label>Test type
        <select id="typeFilter">
          <option value="">Any</option>
          <option value="blood">Blood / Pathology</option>
          <option value="radiology">Radiology / Imaging</option>
        </select>
      </label>
      <label>Facility type
        <select id="facilityFilter">
          <option value="">Any</option>
          <option value="Hospital">Hospital network</option>
          <option value="Private">Private lab</option>
        </select>
      </label>
      <div class="toggles">
        <label class="pill"><input id="homeToggle" type="checkbox"> Home visit only</label>
        <label class="pill"><input id="nearestToggle" type="checkbox" checked> Nearest first</label>
        <button class="badge" id="locateBtn" type="button" data-ripple>üìç Locate me</button>
      </div>
      <div class="status-line" id="sortStatus">Sorting by distance using saved location.</div>
    </section>

    <section class="assurance">
      <span class="chip">Certification-grade partners</span>
      <span class="chip">Transparent pricing</span>
      <span class="chip">WhatsApp confirmation</span>
      <span class="chip">Flexible rescheduling</span>
    </section>

    <section class="insights">
      <div class="card shine" aria-live="polite">
        <div class="label-row" style="justify-content:space-between; align-items:center;">
          <div>
            <p class="chip">Health map & reports</p>
            <h3>Track lab reports and push them to your dashboard</h3>
            <p class="muted">Latest synced report shows where you stand. Sync from any lab modal to refresh this snapshot.</p>
          </div>
          <div class="status-badge neutral" id="dashboardStatus">No reports synced yet</div>
        </div>
        <div class="report-card" id="dashboardReport">
          <p id="dashboardSummary" class="muted">Open a lab, review "Reports & Health Map", then sync to populate this space.</p>
          <div id="dashboardList" class="insight-list"></div>
        </div>
      </div>
      <div class="card pulse" aria-live="polite">
        <p class="chip">Investigation explainers</p>
        <h3>Why each investigation matters</h3>
        <p class="muted">Quick rationale keeps you confident about every blood or imaging test. Hover to feel the subtle glow.</p>
        <div class="insight-list" id="explainerList"></div>
      </div>
    </section>

    <section>
      <div class="grid" id="labsGrid" aria-live="polite"></div>
    </section>
  </main>

  <div class="modal" id="labModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header class="sheet-head">
        <div class="sheet-meta">
          <div class="logo" id="modalLogo">LB</div>
          <div>
            <p class="muted" id="modalLocation">‚Äî</p>
            <h2 id="modalTitle">Lab</h2>
            <div class="label-row">
              <span class="pill" id="modalHome">Home visit</span>
              <span class="pill" id="modalDistance">‚Äî km</span>
              <span class="pill" id="modalCounts">‚Äî</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <a class="badge tiny" id="modalDirections" target="_blank" rel="noopener" data-ripple>Directions</a>
          <a class="badge tiny" id="modalCall" data-ripple>Call</a>
          <a class="badge tiny ghost" id="modalWA" target="_blank" rel="noopener" data-ripple>WhatsApp</a>
          <button class="icon-btn" id="modalClose" aria-label="Close modal" data-ripple>‚úï</button>
        </div>
      </header>
      <nav class="tabs" role="tablist">
        <button data-tab="blood" aria-selected="true">Blood Tests</button>
        <button data-tab="radiology" aria-selected="false">Radiology</button>
        <button data-tab="reports" aria-selected="false">Reports & Health Map</button>
        <button data-tab="book" aria-selected="false">Booking</button>
        <button data-tab="about" aria-selected="false">About</button>
      </nav>
      <div class="panel active" data-panel="blood">
        <div class="modal-toolbar">
          <input id="bloodSearch" type="search" placeholder="Search blood tests" />
          <label class="pill"><input id="bloodHomeToggle" type="checkbox"> Home collection</label>
          <span id="homeFeeText" class="muted">Home fee: ‚Çπ0</span>
          <button class="badge ghost" id="bloodClear" type="button" data-ripple>Clear</button>
          <button class="badge" id="bloodWA" type="button" data-ripple>WhatsApp</button>
        </div>
        <div class="modal-list" id="bloodList"></div>
        <div class="modal-foot">
          <span>Selected: <strong id="bloodCount">0</strong></span>
          <span>Total: <strong id="bloodTotal">‚Çπ0</strong></span>
        </div>
      </div>
      <div class="panel" data-panel="radiology">
        <div class="modal-toolbar">
          <input id="radSearch" type="search" placeholder="Search radiology" />
          <button class="badge ghost" id="radClear" type="button" data-ripple>Clear</button>
          <button class="badge" id="radWA" type="button" data-ripple>WhatsApp</button>
        </div>
        <div class="modal-list" id="radList"></div>
        <div class="modal-foot">
          <span>Selected: <strong id="radCount">0</strong></span>
          <span>Total: <strong id="radTotal">‚Çπ0</strong></span>
        </div>
      </div>
      <div class="panel" data-panel="reports">
        <div class="modal-toolbar">
          <div>
            <strong>Latest lab report preview</strong>
            <p class="muted" id="reportMeta">Live metrics streamed from this lab help plot your dashboard trajectory.</p>
          </div>
          <button class="sync-btn" id="syncDashboard" type="button" data-ripple>üõ∞Ô∏è Sync to dashboard</button>
        </div>
        <div class="reports-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="report-card">
            <h4>Blood markers</h4>
            <div class="modal-list" id="reportBlood"></div>
          </div>
          <div class="report-card">
            <h4>Imaging & impressions</h4>
            <div class="modal-list" id="reportImaging"></div>
          </div>
        </div>
        <div class="timeline" id="reportTimeline"></div>
      </div>
      <div class="panel" data-panel="book">
        <div class="modal-toolbar">
          <button class="badge primary" id="quickFill" type="button" data-ripple>‚ö° Quick-fill earliest slot</button>
          <small class="muted">Applies your profile, nearest lab distance, and next available time.</small>
        </div>
        <div class="booking-grid">
          <div>
            <label>Visit mode
              <div>
                <label class="pill"><input type="radio" name="visitMode" value="home" checked> Home visit</label>
                <label class="pill"><input type="radio" name="visitMode" value="lab"> Visit lab</label>
              </div>
            </label>
            <label>Date & time
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <input id="bookDate" type="date">
                <input id="bookTime" type="time">
              </div>
            </label>
            <label>Name
              <input id="bookName" type="text" placeholder="Your name">
            </label>
            <label>Phone
              <input id="bookPhone" type="tel" placeholder="10-digit mobile">
            </label>
          </div>
          <div>
            <label>City
              <select id="bookCity">
                <option>Mumbai</option>
                <option>Delhi</option>
                <option>Bengaluru</option>
                <option>Hyderabad</option>
                <option>Chennai</option>
              </select>
            </label>
            <details class="profile">
              <summary>Default profile</summary>
              <label>Default name<input id="profileName" type="text"></label>
              <label>Default phone<input id="profilePhone" type="tel"></label>
              <label>Default city<input id="profileCity" type="text"></label>
              <label>Default sort
                <select id="profileSort">
                  <option value="nearest">Nearest</option>
                  <option value="az">A‚ÄìZ</option>
                </select>
              </label>
              <div class="actions">
                <button class="badge" id="saveProfile" type="button" data-ripple>Save profile</button>
                <button class="badge ghost" id="clearProfile" type="button" data-ripple>Clear</button>
                <button class="badge primary" id="useProfile" type="button" data-ripple>Use profile</button>
              </div>
            </details>
            <div class="card" style="padding:12px;">
              <p class="muted">Selected tests & total</p>
              <div id="bookSummary">No tests selected yet.</div>
              <strong id="bookTotal">‚Çπ0</strong>
            </div>
            <button class="badge primary" id="bookConfirm" type="button" data-ripple>Confirm & WhatsApp</button>
          </div>
        </div>
      </div>
      <div class="panel" data-panel="about">
        <h3 id="aboutTitle">About</h3>
        <p id="aboutDesc" class="muted"></p>
        <p><strong>Contact:</strong> <span id="aboutContact"></span></p>
      </div>
    </div>
  </div>

  <template id="labCardTpl">
    <div class="card lab-card" data-ripple>
      <img class="lab-img" alt="Lab image">
      <div>
        <h3 class="lab-name"></h3>
        <p class="muted lab-loc"></p>
      </div>
      <div class="label-row badges"></div>
      <div class="label-row distance-row"></div>
      <div class="actions">
        <button class="tiny badge" data-action="view" type="button">View</button>
        <a class="tiny badge ghost" data-action="directions" target="_blank" rel="noopener">Directions</a>
        <a class="tiny badge ghost" data-action="call">Call</a>
      </div>
    </div>
  </template>

  <template id="testRowTpl">
    <div class="test-row">
      <label>
        <input type="checkbox">
        <div>
          <span class="test-name"></span>
          <p class="test-why"></p>
        </div>
      </label>
      <div class="test-price-wrap">
        <strong class="test-price"></strong>
        <small class="muted test-range"></small>
      </div>
    </div>
  </template>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <audio id="clickSound" preload="auto" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA/////wAAA1cAABF4AAD///8ATGF2ZjU2LjQxLjEwNAAAAAAAAAAAAAAA//uQxAADB6gAhR0AAAiCAAAIhYAQBEdAAAEQxAADL0AAAL0AAAQW5n//sQxAAD//8AAAAAAAAAAAAAAA=="></audio>

  <script>
    const el = id => document.getElementById(id);
    const fmt = n => `‚Çπ${Math.round(n).toLocaleString('en-IN')}`;
    const rand = (min,max) => Math.random()*(max-min)+min;

    const themeToggle = el('themeToggle');
    const labsGrid = el('labsGrid');
    const labCardTpl = el('labCardTpl');
    const testRowTpl = el('testRowTpl');
    const toast = el('toast');
    const clickSound = el('clickSound');

    const searchInput = el('searchInput');
    const cityFilter = el('cityFilter');
    const facilityFilter = el('facilityFilter');
    const typeFilter = el('typeFilter');
    const homeToggle = el('homeToggle');
    const nearestToggle = el('nearestToggle');
    const locateBtn = el('locateBtn');
    const sortStatus = el('sortStatus');

    const visibleCount = el('visibleCount');
    const homeCount = el('homeCount');
    const radCount = el('radCount');
    const avgPrice = el('avgPrice');
    const sortMeta = el('sortMeta');
    const locationMeta = el('locationMeta');
    const homeFeeMeta = el('homeFeeMeta');
    const explainerList = el('explainerList');
    const dashboardStatus = el('dashboardStatus');
    const dashboardSummary = el('dashboardSummary');
    const dashboardList = el('dashboardList');

    const modal = el('labModal');
    const modalTitle = el('modalTitle');
    const modalLocation = el('modalLocation');
    const modalHome = el('modalHome');
    const modalDistance = el('modalDistance');
    const modalCounts = el('modalCounts');
    const modalLogo = el('modalLogo');
    const modalDirections = el('modalDirections');
    const modalCall = el('modalCall');
    const modalWA = el('modalWA');
    const modalClose = el('modalClose');
    const tabs = Array.from(document.querySelectorAll('.tabs button'));
    const panels = Array.from(document.querySelectorAll('.panel'));

    const bloodList = el('bloodList');
    const radList = el('radList');
    const bloodSearch = el('bloodSearch');
    const radSearch = el('radSearch');
    const bloodHomeToggle = el('bloodHomeToggle');
    const homeFeeText = el('homeFeeText');
    const bloodClear = el('bloodClear');
    const radClear = el('radClear');
    const bloodWA = el('bloodWA');
    const radWA = el('radWA');
    const bloodCount = el('bloodCount');
    const radCountEl = el('radCount');
    const bloodTotal = el('bloodTotal');
    const radTotal = el('radTotal');
    const bookSummary = el('bookSummary');
    const bookTotal = el('bookTotal');

    const bookDate = el('bookDate');
    const bookTime = el('bookTime');
    const bookName = el('bookName');
    const bookPhone = el('bookPhone');
    const bookCity = el('bookCity');
    const quickFill = el('quickFill');
    const saveProfile = el('saveProfile');
    const clearProfile = el('clearProfile');
    const useProfile = el('useProfile');
    const profileName = el('profileName');
    const profilePhone = el('profilePhone');
    const profileCity = el('profileCity');
    const profileSort = el('profileSort');
    const bookConfirm = el('bookConfirm');

    const aboutTitle = el('aboutTitle');
    const aboutDesc = el('aboutDesc');
    const aboutContact = el('aboutContact');
    const reportBloodEl = el('reportBlood');
    const reportImagingEl = el('reportImaging');
    const reportTimeline = el('reportTimeline');
    const syncDashboard = el('syncDashboard');
    const reportMeta = el('reportMeta');

    let labs = [];
    let selections = new Map();
    let currentLab = null;
    let userLocation = null;
    let lastBaseLocation = null;

    const baseBlood = [
      { name: 'Complete Blood Count', price: 480, why: 'Screens anemia, infection and platelet issues in one sweep.', unit:'g/dL', range:[12,16] },
      { name: 'Lipid Profile', price: 650, why: 'Maps cholesterol fractions to quantify heart risk.', unit:'mg/dL', range:[120,200] },
      { name: 'Liver Function Test', price: 720, why: 'Checks bilirubin and enzymes to flag liver stress early.', unit:'IU/L', range:[5,45] },
      { name: 'Kidney Function Test', price: 700, why: 'Creatinine + urea tell you how well the kidneys filter.', unit:'mg/dL', range:[0.6,1.2] },
      { name: 'HbA1c', price: 540, why: 'Average sugar of past 3 months, cornerstone for diabetes control.', unit:'%', range:[4.5,5.6] },
      { name: 'Thyroid Panel', price: 820, why: 'TSH/T3/T4 balance that controls energy, mood, and weight.', unit:'¬µIU/mL', range:[0.3,4.5] },
      { name: 'Vitamin D', price: 1100, why: 'Bone health, immunity, and mood regulation booster.', unit:'ng/mL', range:[30,70] },
      { name: 'Iron Studies', price: 900, why: 'Ferritin/iron/TIBC to spot deficiency or overload.', unit:'¬µg/dL', range:[60,170] },
      { name: 'CRP', price: 580, why: 'Inflammation flag that correlates with infection or heart risk.', unit:'mg/L', range:[0,5] },
      { name: 'Ferritin', price: 750, why: 'Iron store that dips before hemoglobin drops.', unit:'ng/mL', range:[20,250] }
    ];
    const baseRad = [
      { name: 'Chest X-Ray', price: 600, why: 'Screens lungs and heart silhouette for infections or fluid.', impression:'No active consolidation. Heart size normal.' },
      { name: 'Ultrasound Abdomen', price: 1800, why: 'Looks at liver, gall bladder, kidneys for stones or swellings.', impression:'Liver smooth, no gall stones. Kidneys normal size.' },
      { name: 'CT Brain', price: 4200, why: 'Fast stroke/bleed screening when every minute counts.', impression:'No hemorrhage. Ventricles symmetrical.' },
      { name: 'MRI Spine', price: 5500, why: 'Disc, nerve and soft-tissue clarity for back or neck pain.', impression:'Mild L4-L5 disc bulge without nerve compression.' },
      { name: 'Mammography', price: 2500, why: 'Detects early calcifications and lumps in breast tissue.', impression:'BI-RADS 2: benign-appearing calcifications.' },
      { name: 'DEXA Scan', price: 3000, why: 'Bone density score to understand fracture risk.', impression:'T-score -1.1 : Mild osteopenia, start supplements.' },
      { name: 'PET-CT', price: 11000, why: 'Whole-body metabolic scan to stage or monitor cancers.', impression:'No avid lesions beyond baseline.' },
      { name: 'USG Pelvis', price: 1600, why: 'Evaluates uterus/ovaries/prostate for structural changes.', impression:'Uterus normal size, no adnexal masses.' }
    ];

    const rand = (min, max) => Math.random() * (max - min) + min;

    const cityAnchors = {
      Mumbai: { lat: 19.076, lng: 72.8777, label: 'Mumbai anchor' },
      Delhi: { lat: 28.6139, lng: 77.209, label: 'Delhi anchor' },
      Bengaluru: { lat: 12.9716, lng: 77.5946, label: 'Bengaluru anchor' },
      Hyderabad: { lat: 17.385, lng: 78.4867, label: 'Hyderabad anchor' },
      Chennai: { lat: 13.0827, lng: 80.2707, label: 'Chennai anchor' }
    };

    const labSeed = [
      { name:'Lotus Diagnostics', city:'Mumbai', area:'Bandra', facility:'Private', img:'https://images.unsplash.com/photo-1582719478173-2f2df4b95831?auto=format&fit=crop&w=900&q=80&sat=-15&sig=101' },
      { name:'Fortis Care Lab', city:'Mumbai', area:'Andheri', facility:'Hospital', img:'https://images.unsplash.com/photo-1581093588401-22da8ca941c6?auto=format&fit=crop&w=900&q=80&sig=102' },
      { name:'Kokilaben Imaging Hub', city:'Mumbai', area:'Juhu', facility:'Hospital', img:'https://images.unsplash.com/photo-1584515933487-779824d29309?auto=format&fit=crop&w=900&q=80&sig=103' },
      { name:'CityLine Path Labs', city:'Mumbai', area:'Powai', facility:'Private', img:'https://images.unsplash.com/photo-1504439468489-c8920d796a29?auto=format&fit=crop&w=900&q=80&sig=104' },
      { name:'TrustLab Prime', city:'Mumbai', area:'Thane', facility:'Private', img:'https://images.unsplash.com/photo-1506126613408-eca07ce68773?auto=format&fit=crop&w=900&q=80&sig=105' },

      { name:'Apollo Diagnostics', city:'Delhi', area:'Saket', facility:'Hospital', img:'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&w=900&q=80&sig=106' },
      { name:'BLK Precision Lab', city:'Delhi', area:'Rajouri Garden', facility:'Hospital', img:'https://images.unsplash.com/photo-1505751172876-fa1923c5c528?auto=format&fit=crop&w=900&q=80&sig=107' },
      { name:'Thyroplus Express', city:'Delhi', area:'Lajpat Nagar', facility:'Private', img:'https://images.unsplash.com/photo-1504814532849-92767b4e1c02?auto=format&fit=crop&w=900&q=80&sig=108' },
      { name:'MedLife Central', city:'Delhi', area:'Dwarka', facility:'Private', img:'https://images.unsplash.com/photo-1505663912202-ac22d4cb370b?auto=format&fit=crop&w=900&q=80&sig=109' },
      { name:'NOVA Scan & Care', city:'Delhi', area:'Connaught Place', facility:'Private', img:'https://images.unsplash.com/photo-1581090700227-1e37b190418e?auto=format&fit=crop&w=900&q=80&sig=110' },

      { name:'Aster Medcity Lab', city:'Bengaluru', area:'Hebbal', facility:'Hospital', img:'https://images.unsplash.com/photo-1579154204601-01588f351e67?auto=format&fit=crop&w=900&q=80&sig=111' },
      { name:'Cloudnine Diagnostics', city:'Bengaluru', area:'Jayanagar', facility:'Hospital', img:'https://images.unsplash.com/photo-1530023367847-a683933f4177?auto=format&fit=crop&w=900&q=80&sig=112' },
      { name:'Prime Path Koramangala', city:'Bengaluru', area:'Koramangala', facility:'Private', img:'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&w=900&q=80&sig=113' },
      { name:'Orbit Labs', city:'Bengaluru', area:'Whitefield', facility:'Private', img:'https://images.unsplash.com/photo-1581092152835-30ab079f19b9?auto=format&fit=crop&w=900&q=80&sig=114' },
      { name:'Manipal Imaging Ring', city:'Bengaluru', area:'Old Airport', facility:'Hospital', img:'https://images.unsplash.com/photo-1460672985063-6764ac8b9c74?auto=format&fit=crop&w=900&q=80&sig=115' },

      { name:'Yashoda SmartLab', city:'Hyderabad', area:'Somajiguda', facility:'Hospital', img:'https://images.unsplash.com/photo-1583912086057-6b5530f2605f?auto=format&fit=crop&w=900&q=80&sig=116' },
      { name:'Rainbow Diagnostics', city:'Hyderabad', area:'Banjara Hills', facility:'Hospital', img:'https://images.unsplash.com/photo-1460672985063-6764ac8b9c74?auto=format&fit=crop&w=900&q=80&sig=117' },
      { name:'Neon Labs', city:'Hyderabad', area:'Gachibowli', facility:'Private', img:'https://images.unsplash.com/photo-1583912086096-8a27b40a97c3?auto=format&fit=crop&w=900&q=80&sig=118' },
      { name:'Orbit Scan Center', city:'Hyderabad', area:'Kondapur', facility:'Private', img:'https://images.unsplash.com/photo-1581092152835-30ab079f19b9?auto=format&fit=crop&w=900&q=80&sig=119' },
      { name:'Care Hospitals Lab', city:'Hyderabad', area:'Secunderabad', facility:'Hospital', img:'https://images.unsplash.com/photo-1582719478248-54e9f2e7f1e9?auto=format&fit=crop&w=900&q=80&sig=120' },

      { name:'Apollo Spectra Lab', city:'Chennai', area:'Teynampet', facility:'Hospital', img:'https://images.unsplash.com/photo-1581090700227-1e37b190418e?auto=format&fit=crop&w=900&q=80&sig=121' },
      { name:'Vijaya Diagnostic', city:'Chennai', area:'Vadapalani', facility:'Hospital', img:'https://images.unsplash.com/photo-1505751172876-fa1923c5c528?auto=format&fit=crop&w=900&q=80&sig=122' },
      { name:'Anderson Labs', city:'Chennai', area:'Velachery', facility:'Private', img:'https://images.unsplash.com/photo-1583912267550-51a3b0395e7c?auto=format&fit=crop&w=900&q=80&sig=123' },
      { name:'Aarthi Scans Plus', city:'Chennai', area:'Tambaram', facility:'Private', img:'https://images.unsplash.com/photo-1584515933487-779824d29309?auto=format&fit=crop&w=900&q=80&sig=124' },
      { name:'Medall Precision Hub', city:'Chennai', area:'OMR', facility:'Private', img:'https://images.unsplash.com/photo-1506126613408-eca07ce68773?auto=format&fit=crop&w=900&q=80&sig=125' },
    ];

    function initTheme() {
      const saved = localStorage.getItem('hf-theme') || 'matte';
      document.documentElement.dataset.theme = saved;
      themeToggle.addEventListener('click', () => {
        const next = document.documentElement.dataset.theme === 'matte' ? 'day' : 'matte';
        document.documentElement.dataset.theme = next;
        localStorage.setItem('hf-theme', next);
      });
    }

    function buildLabs() {
      labs = labSeed.map((item, idx) => {
        const anchor = cityAnchors[item.city];
        const multiplier = rand(0.9,1.35);
        const homeVisit = Math.random() > 0.25 || item.facility === 'Hospital';
        const homeFee = homeVisit ? Math.round(rand(120,320)) : 0;
        const blood = baseBlood.map(t => ({ ...t, price: Math.round(t.price * multiplier) }));
        const radiology = baseRad.map(t => ({ ...t, price: Math.round(t.price * (multiplier+0.05)) }));
        const description = `${item.name} (${item.facility === 'Hospital' ? 'hospital network' : 'private lab'}) keeps QA clocks running, shares WhatsApp confirmations, and colour-coded reports for dashboard mapping.`;
        const lat = anchor ? anchor.lat + rand(-0.08,0.08) : 20 + Math.random();
        const lng = anchor ? anchor.lng + rand(-0.08,0.08) : 78 + Math.random();
        const reports = buildLabReports(blood, radiology);
        return { id:`lab-${idx}`, name:item.name, city:item.city, area:item.area, facility:item.facility, lat, lng, phone:`+91-98765${10000+idx}`, homeVisit, homeFee, blood, radiology, description, img:item.img, reports };
      });
    }

    function buildLabReports(blood, radiology) {
      const bloodReports = blood.slice(0,4).map(test => {
        const baseline = test.range ? rand(test.range[0]*0.9, test.range[1]*1.2) : rand(10,90);
        const status = test.range ? (baseline < test.range[0] ? 'low' : baseline > test.range[1] ? 'high' : 'normal') : 'note';
        return { name: test.name, value: Number(baseline.toFixed(1)), unit: test.unit || '', range: test.range, why: test.why, status };
      });
      const imagingReports = radiology.slice(0,3).map(test => ({
        name: test.name,
        impression: test.impression,
        status: Math.random() > 0.72 ? 'follow-up' : 'clear',
        why: test.why
      }));
      return { updated: new Date().toISOString(), bloodReports, imagingReports };
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function getFallbackLocation() {
      const cityHint = profileCity.value || cityFilter.value || bookCity.value || 'Mumbai';
      const anchor = cityAnchors[cityHint] || { lat: 20.5937, lng: 78.9629, label: 'India midpoint' };
      return { ...anchor, label: anchor.label || `${cityHint} anchor` };
    }

    function getActiveBaseLocation() {
      if (userLocation) return { ...userLocation, label: userLocation.label || 'Live GPS' };
      return getFallbackLocation();
    }

    function computeDistances(base) {
      if (!base) return;
      labs.forEach(l => {
        l.distanceKm = haversine(base.lat, base.lng, l.lat, l.lng);
      });
    }

    function filterLabs() {
      const base = getActiveBaseLocation();
      lastBaseLocation = base;
      computeDistances(base);
      locationMeta.textContent = base.label;
      const query = (searchInput.value || '').toLowerCase();
      const city = cityFilter.value;
      const type = typeFilter.value;
      const homeOnly = homeToggle.checked;
      const facility = facilityFilter.value;
      let results = labs.filter(lab => {
        if (city && lab.city !== city) return false;
        if (facility && lab.facility !== facility) return false;
        if (homeOnly && !lab.homeVisit) return false;
        const haystack = [lab.name, lab.city, lab.area, ...lab.blood.map(t=>t.name), ...lab.radiology.map(t=>t.name)]
          .join(' ').toLowerCase();
        if (query && !haystack.includes(query)) return false;
        if (type === 'blood' && !lab.blood.length) return false;
        if (type === 'radiology' && !lab.radiology.length) return false;
        return true;
      });
      if (nearestToggle.checked) {
        results.sort((a,b) => (a.distanceKm||Infinity) - (b.distanceKm||Infinity));
        sortMeta.textContent = 'Nearest';
        sortStatus.textContent = base.label === 'Live GPS' ? 'Sorting by live distance.' : `Sorting by distance from ${base.label}. Tap üìç to update.`;
        locationMeta.textContent = base.label;
      } else {
        results.sort((a,b) => a.name.localeCompare(b.name));
        sortMeta.textContent = 'A‚ÄìZ';
        sortStatus.textContent = 'Sorting alphabetically; enable nearest for live distance.';
      }
      renderLabs(results);
    }

    function renderLabs(list) {
      labsGrid.innerHTML = '';
      const homeLabs = list.filter(l=>l.homeVisit).length;
      const radLabs = list.filter(l=>l.radiology.length).length;
      const avg = list.length ? list.reduce((a,l)=>a+l.blood[0].price,0)/list.length : 0;
      visibleCount.textContent = list.length;
      homeCount.textContent = homeLabs;
      radCount.textContent = radLabs;
      avgPrice.textContent = list.length ? fmt(avg) : '‚Çπ0';
      homeFeeMeta.textContent = homeLabs ? fmt(list.filter(l=>l.homeVisit).reduce((a,l)=>a+l.homeFee,0)/homeLabs) : '‚Çπ0';
      [visibleCount, homeCount, radCount, avgPrice, homeFeeMeta].forEach(node => {
        const metric = node.closest('.metric');
        if (!metric) return;
        metric.classList.remove('animate'); metric.offsetWidth; metric.classList.add('animate');
      });
      list.forEach(lab => {
        const node = labCardTpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.lab-img').src = lab.img;
        node.querySelector('.lab-img').alt = lab.name;
        node.querySelector('.lab-name').textContent = lab.name;
        node.querySelector('.lab-loc').textContent = `${lab.city} ¬∑ ${lab.area}`;
        const badges = node.querySelector('.badges');
        badges.innerHTML = '';
        const facilityBadge = document.createElement('span');
        facilityBadge.className = 'pill badge';
        facilityBadge.textContent = lab.facility === 'Hospital' ? 'üè• Hospital' : 'üß™ Private lab';
        badges.appendChild(facilityBadge);
        const homeBadge = document.createElement('span');
        homeBadge.className = 'pill ' + (lab.homeVisit ? 'good' : '');
        homeBadge.textContent = lab.homeVisit ? `Home visit ‚Ä¢ ${fmt(lab.homeFee)}` : 'In-lab only';
        badges.appendChild(homeBadge);
        badges.insertAdjacentHTML('beforeend', `<span class="pill">${lab.blood.length} blood</span><span class="pill">${lab.radiology.length} radiology</span>`);
        const distRow = node.querySelector('.distance-row');
        distRow.textContent = lab.distanceKm ? `${lab.distanceKm.toFixed(1)} km from ${lastBaseLocation ? lastBaseLocation.label : 'anchor'}` : 'Distance pending location';
        const viewBtn = node.querySelector('[data-action="view"]');
        const dirBtn = node.querySelector('[data-action="directions"]');
        const callBtn = node.querySelector('[data-action="call"]');
        dirBtn.href = `https://www.google.com/maps?q=${encodeURIComponent(lab.name)}@${lab.lat},${lab.lng}`;
        callBtn.href = `tel:${lab.phone}`;
        viewBtn.addEventListener('click', e => { e.stopPropagation(); openModal(lab); });
        dirBtn.addEventListener('click', e => e.stopPropagation());
        callBtn.addEventListener('click', e => e.stopPropagation());
        node.addEventListener('click', () => openModal(lab));
        labsGrid.appendChild(node);
      });
    }

    function renderExplainers() {
      explainerList.innerHTML = '';
      const picked = [...baseBlood.slice(0,3), ...baseRad.slice(0,2)];
      picked.forEach(item => {
        const row = document.createElement('div');
        row.className = 'insight-row shine';
        row.innerHTML = `<div><strong>${item.name}</strong><small>${item.why}</small></div><span class="status-badge neutral">Why it's done</span>`;
        explainerList.appendChild(row);
      });
    }

    function renderDashboardSnapshot() {
      const saved = JSON.parse(localStorage.getItem('lab-dashboard-latest') || 'null');
      dashboardList.innerHTML = '';
      if (!saved) {
        dashboardStatus.textContent = 'No reports synced yet';
        dashboardStatus.className = 'status-badge neutral';
        dashboardSummary.textContent = 'Sync any lab report to see friendly explanations and health status mapping here.';
        return;
      }
      dashboardStatus.textContent = `Synced ${new Date(saved.updated).toLocaleString()}`;
      dashboardStatus.className = 'status-badge good';
      dashboardSummary.textContent = `From ${saved.lab} ‚Ä¢ ${saved.city}`;
      saved.bloodReports.forEach(rep => {
        const badgeClass = rep.status === 'normal' ? 'good' : rep.status === 'high' || rep.status === 'low' ? 'warn' : 'neutral';
        const row = document.createElement('div');
        row.className = 'insight-row';
        row.innerHTML = `<div><strong>${rep.name}</strong><small>${rep.why}</small><small>Result: ${rep.value} ${rep.unit || ''}${rep.range?` (target ${rep.range[0]}-${rep.range[1]})`:''}</small></div><span class="status-badge ${badgeClass}">${rep.status}</span>`;
        dashboardList.appendChild(row);
      });
    }

    function getSel(id) {
      if (!selections.has(id)) selections.set(id, { blood:new Set(), rad:new Set(), home:false });
      return selections.get(id);
    }

    function renderTests(listEl, tests, selSet, query='') {
      listEl.innerHTML='';
      tests.filter(t => !query || t.name.toLowerCase().includes(query.toLowerCase()))
        .forEach(test => {
          const row = testRowTpl.content.firstElementChild.cloneNode(true);
          const cb = row.querySelector('input');
          row.querySelector('.test-name').textContent = test.name;
          row.querySelector('.test-price').textContent = fmt(test.price);
          row.querySelector('.test-why').textContent = test.why || 'Investigation added for clinical context.';
          row.querySelector('.test-range').textContent = test.range ? `Target ${test.range[0]}‚Äì${test.range[1]} ${test.unit||''}` : '';
          cb.checked = selSet.has(test.name);
          cb.addEventListener('change', () => {
            cb.checked ? selSet.add(test.name) : selSet.delete(test.name);
            updateTotals();
          });
          listEl.appendChild(row);
        });
      if (!listEl.children.length) {
        const empty = document.createElement('div');
        empty.className='card';
        empty.textContent='No tests match this search.';
        listEl.appendChild(empty);
      }
    }

    function updateTotals() {
      if (!currentLab) return;
      const sel = getSel(currentLab.id);
      const bloodSel = currentLab.blood.filter(t => sel.blood.has(t.name));
      const radSel = currentLab.radiology.filter(t => sel.rad.has(t.name));
      const bloodFee = sel.home && currentLab.homeVisit ? currentLab.homeFee : 0;
      const bloodSum = bloodSel.reduce((a,t)=>a+t.price,0) + bloodFee;
      const radSum = radSel.reduce((a,t)=>a+t.price,0);
      bloodCount.textContent = bloodSel.length;
      radCountEl.textContent = radSel.length;
      bloodTotal.textContent = fmt(bloodSum);
      radTotal.textContent = fmt(radSum);
      const lines = [];
      if (bloodSel.length) {
        lines.push('Blood tests:');
        bloodSel.forEach(t => lines.push(`‚Ä¢ ${t.name} ‚Äî ${fmt(t.price)}`));
        if (bloodFee) lines.push(`‚Ä¢ Home fee ‚Äî ${fmt(bloodFee)}`);
      }
      if (radSel.length) {
        lines.push('Radiology:');
        radSel.forEach(t => lines.push(`‚Ä¢ ${t.name} ‚Äî ${fmt(t.price)}`));
      }
      bookSummary.textContent = lines.length ? lines.join('\n') : 'No tests selected yet.';
      bookTotal.textContent = fmt(bloodSum + radSum);
    }

    function renderReports(lab) {
      reportBloodEl.innerHTML = '';
      reportImagingEl.innerHTML = '';
      reportTimeline.innerHTML = '';
      reportMeta.textContent = `Generated from ${new Date(lab.reports.updated).toLocaleString()}. Sync below to push into your dashboard timeline.`;
      lab.reports.bloodReports.forEach(rep => {
        const badgeClass = rep.status === 'normal' ? 'good' : rep.status === 'high' || rep.status === 'low' ? 'warn' : 'neutral';
        const row = document.createElement('div');
        row.className = 'insight-row';
        row.innerHTML = `<div><strong>${rep.name}</strong><small>${rep.why}</small><small>Result: ${rep.value} ${rep.unit || ''}${rep.range?` (target ${rep.range[0]}-${rep.range[1]})`:''}</small></div><span class="status-badge ${badgeClass}">${rep.status}</span>`;
        reportBloodEl.appendChild(row);
      });
      lab.reports.imagingReports.forEach(rep => {
        const badgeClass = rep.status === 'clear' ? 'good' : rep.status === 'follow-up' ? 'warn' : 'neutral';
        const row = document.createElement('div');
        row.className = 'insight-row';
        row.innerHTML = `<div><strong>${rep.name}</strong><small>${rep.why}</small><small>${rep.impression}</small></div><span class="status-badge ${badgeClass}">${rep.status}</span>`;
        reportImagingEl.appendChild(row);
      });
      ['Select tests you care about', 'Sync to dashboard to track streaks', 'Use nearest-first to tighten logistics'].forEach(text => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = text;
        reportTimeline.appendChild(chip);
      });
    }

    function openModal(lab) {
      currentLab = lab;
      const sel = getSel(lab.id);
      setTab('blood');
      modalTitle.textContent = lab.name;
      modalLocation.textContent = `${lab.city}, ${lab.area} ¬∑ ${lab.facility}`;
      modalHome.textContent = lab.homeVisit ? `Home visit ‚Ä¢ ${fmt(lab.homeFee)}` : 'In-lab only';
      modalDistance.textContent = lab.distanceKm ? `${lab.distanceKm.toFixed(1)} km` : 'Location pending';
      modalCounts.textContent = `${lab.blood.length} blood ‚Ä¢ ${lab.radiology.length} radiology`;
      modalLogo.textContent = lab.name.slice(0,2).toUpperCase();
      modalDirections.href = `https://www.google.com/maps?q=${encodeURIComponent(lab.name)}@${lab.lat},${lab.lng}`;
      modalCall.href = `tel:${lab.phone}`;
      modalWA.href = buildWhatsAppLink(lab, 'quick');
      homeFeeText.textContent = lab.homeVisit ? `Home fee: ${fmt(lab.homeFee)}` : 'Home collection not available';
      bloodHomeToggle.disabled = !lab.homeVisit;
      bloodHomeToggle.checked = sel.home && lab.homeVisit;
      renderTests(bloodList, lab.blood, sel.blood, bloodSearch.value);
      renderTests(radList, lab.radiology, sel.rad, radSearch.value);
      renderReports(lab);
      updateTotals();
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
    }

    function closeModal() {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
    }

    function setTab(tabName) {
      tabs.forEach(b => b.setAttribute('aria-selected', b.dataset.tab === tabName ? 'true':'false'));
      panels.forEach(p => p.classList.toggle('active', p.dataset.panel === tabName));
    }

    tabs.forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));
    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    bloodSearch.addEventListener('input', () => renderTests(bloodList, currentLab.blood, getSel(currentLab.id).blood, bloodSearch.value));
    radSearch.addEventListener('input', () => renderTests(radList, currentLab.radiology, getSel(currentLab.id).rad, radSearch.value));
    bloodHomeToggle.addEventListener('change', () => { const sel = getSel(currentLab.id); sel.home = bloodHomeToggle.checked; updateTotals(); });
    bloodClear.addEventListener('click', () => { const sel = getSel(currentLab.id); sel.blood.clear(); sel.home=false; bloodHomeToggle.checked=false; updateTotals(); renderTests(bloodList, currentLab.blood, sel.blood, bloodSearch.value); });
    radClear.addEventListener('click', () => { const sel = getSel(currentLab.id); sel.rad.clear(); updateTotals(); renderTests(radList, currentLab.radiology, sel.rad, radSearch.value); });

    function buildWhatsAppLink(lab, context) {
      const sel = getSel(lab.id);
      const bloodSel = lab.blood.filter(t => sel.blood.has(t.name));
      const radSel = lab.radiology.filter(t => sel.rad.has(t.name));
      const bloodFee = sel.home && lab.homeVisit ? lab.homeFee : 0;
      let msg = `Lab: ${lab.name} (${lab.city}, ${lab.area})\n`;
      if (context === 'booking') {
        const mode = document.querySelector('input[name="visitMode"]:checked').value;
        msg += `Mode: ${mode === 'home' ? 'Home visit' : 'Visit lab'}\nDate: ${bookDate.value||'-'} Time: ${bookTime.value||'-'}\nName: ${bookName.value||'-'}\nPhone: ${bookPhone.value||'-'}\nCity: ${bookCity.value}\n`;
      }
      if (bloodSel.length) {
        msg += `Blood tests:\n`;
        bloodSel.forEach(t => msg += `‚Ä¢ ${t.name} ‚Äî ${fmt(t.price)}\n`);
        if (bloodFee) msg += `‚Ä¢ Home collection fee ‚Äî ${fmt(bloodFee)}\n`;
      }
      if (radSel.length) {
        msg += `Radiology:\n`;
        radSel.forEach(t => msg += `‚Ä¢ ${t.name} ‚Äî ${fmt(t.price)}\n`);
      }
      const total = bloodSel.reduce((a,t)=>a+t.price,0) + radSel.reduce((a,t)=>a+t.price,0) + bloodFee;
      msg += `Total: ${fmt(total)}`;
      return `https://wa.me/?text=${encodeURIComponent(msg)}`;
    }

    bloodWA.addEventListener('click', () => { if (!currentLab) return; window.open(buildWhatsAppLink(currentLab,'blood'),'_blank'); showToast('Opened WhatsApp with blood tests'); });
    radWA.addEventListener('click', () => { if (!currentLab) return; window.open(buildWhatsAppLink(currentLab,'radiology'),'_blank'); showToast('Opened WhatsApp with radiology tests'); });
    bookConfirm.addEventListener('click', () => {
      if (!currentLab) return; window.open(buildWhatsAppLink(currentLab,'booking'),'_blank'); showToast('Booking sent via WhatsApp');
    });

    quickFill.addEventListener('click', () => {
      const now = new Date();
      const next = new Date(now.getTime() + 90*60000);
      bookDate.value = next.toISOString().slice(0,10);
      bookTime.value = `${String(next.getHours()).padStart(2,'0')}:${String(next.getMinutes()).padStart(2,'0')}`;
      const saved = JSON.parse(localStorage.getItem('lab-profile') || '{}');
      if (saved.name) bookName.value = saved.name;
      if (saved.phone) bookPhone.value = saved.phone;
      if (saved.city) { bookCity.value = saved.city; cityFilter.value = saved.city; }
      const mode = currentLab && currentLab.homeVisit ? 'home' : 'lab';
      const modeInput = document.querySelector(`input[name="visitMode"][value="${mode}"]`);
      if (modeInput) modeInput.checked = true;
      showToast('Prefilled with your quickest option');
      filterLabs();
    });

    function syncReportsToDashboard(lab) {
      const payload = { ...lab.reports, lab: lab.name, city: lab.city, area: lab.area };
      localStorage.setItem('lab-dashboard-latest', JSON.stringify(payload));
      renderDashboardSnapshot();
      showToast('Report synced to dashboard');
    }
    syncDashboard.addEventListener('click', () => { if (currentLab) syncReportsToDashboard(currentLab); });

    function loadProfile() {
      const saved = JSON.parse(localStorage.getItem('lab-profile') || '{}');
      profileName.value = saved.name || '';
      profilePhone.value = saved.phone || '';
      profileCity.value = saved.city || '';
      profileSort.value = saved.sort || 'nearest';
    }
    function applyProfile() {
      const saved = JSON.parse(localStorage.getItem('lab-profile') || '{}');
      bookName.value = saved.name || '';
      bookPhone.value = saved.phone || '';
      if (saved.city) bookCity.value = saved.city;
      nearestToggle.checked = saved.sort !== 'az';
      filterLabs();
    }
    saveProfile.addEventListener('click', () => {
      const data = { name: profileName.value, phone: profilePhone.value, city: profileCity.value, sort: profileSort.value };
      localStorage.setItem('lab-profile', JSON.stringify(data));
      showToast('Profile saved');
    });
    clearProfile.addEventListener('click', () => { localStorage.removeItem('lab-profile'); loadProfile(); showToast('Profile cleared'); });
    useProfile.addEventListener('click', () => { applyProfile(); showToast('Profile applied to booking'); });

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function requestLocation(auto = false) {
      if (!navigator.geolocation) { if (!auto) showToast('Geolocation not supported'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, label: 'Live GPS' };
        localStorage.setItem('lab-location', JSON.stringify(userLocation));
        locationMeta.textContent = 'Live GPS';
        showToast(auto ? 'Locked to live location' : 'Location updated');
        filterLabs();
      }, () => {
        if (!auto) showToast('Unable to fetch location');
        if (!userLocation) { filterLabs(); }
      });
    }

    locateBtn.addEventListener('click', () => requestLocation(false));
    nearestToggle.addEventListener('change', filterLabs);
    searchInput.addEventListener('input', filterLabs);
    cityFilter.addEventListener('change', filterLabs);
    facilityFilter.addEventListener('change', filterLabs);
    typeFilter.addEventListener('change', filterLabs);
    homeToggle.addEventListener('change', filterLabs);

    modalCall.addEventListener('click', e => { if (modalCall.href.startsWith('tel:')) return; e.preventDefault(); window.location.href = modalCall.href; });

    function initRipple() {
      document.body.addEventListener('click', e => {
        const target = e.target.closest('[data-ripple]');
        if (!target) return;
        const rect = target.getBoundingClientRect();
        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        ripple.style.left = `${e.clientX - rect.left}px`;
        ripple.style.top = `${e.clientY - rect.top}px`;
        target.appendChild(ripple);
        setTimeout(() => ripple.remove(), 500);
        clickSound.currentTime = 0; clickSound.play();
      });
    }

    function init() {
      initTheme();
      loadProfile();
      const savedLoc = localStorage.getItem('lab-location');
      if (savedLoc) { userLocation = { ...JSON.parse(savedLoc), label: 'Saved GPS' }; locationMeta.textContent = 'Saved GPS'; }
      buildLabs();
      renderExplainers();
      renderDashboardSnapshot();
      requestLocation(true);
      filterLabs();
      initRipple();
    }

    init();
  </script>
</body>
</html>
