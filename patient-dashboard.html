<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health flo OS - NEO 2.0 (Pro)</title>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Three.js Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Three.js OrbitControls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        :root {
            /* Theme Variables */
            --bg-radial: radial-gradient(circle at 20% 30%, #506176 0%, #1a1f2b 55%, #0E121B 100%);
            
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(24px);
            
            --text-white: #ffffff;
            --text-muted: #94a3b8;

            /* Component Specifics */
            --sidebar-bg: rgba(255, 255, 255, 0.02);
            --card-hover-bg: rgba(30, 35, 45, 0.9);
            --pill-active-text: #ffffff;

            /* Status Colors */
            --color-blue: #3b82f6;
            --color-cyan: #06b6d4;
            --color-yellow: #f59e0b;
            --color-red: #ef4444;
            
            --accent-blue: #3b82f6;
            --card-bg: rgba(22, 28, 38, 0.6);
            --card-border: rgba(255, 255, 255, 0.05);
            --card-active-bg: linear-gradient(135deg, rgba(30, 58, 138, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
        }

        body.theme-white {
            /* High Contrast Light Theme */
            --bg-radial: radial-gradient(circle at 20% 30%, #f0f4f8 0%, #e2e8f0 55%, #cbd5e1 100%);
            
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(51, 65, 85, 0.15);
            --glass-blur: blur(24px);
            
            --text-white: #0f172a;
            --text-muted: #475569;

            --sidebar-bg: rgba(255, 255, 255, 0.5);
            --card-hover-bg: #ffffff;
            --pill-active-text: #1e3a8a;

            --card-bg: rgba(255, 255, 255, 0.85);
            --card-border: rgba(51, 65, 85, 0.1);
            --card-active-bg: linear-gradient(135deg, #dbeafe 0%, #ffffff 100%);
        }

        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* CUSTOM SCROLLBARS */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-blue); }
        
        body.theme-white ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); }

        body {
            height: 100vh; width: 100vw;
            background: var(--bg-radial);
            overflow: hidden; user-select: none;
            color: var(--text-white);
            transition: color 0.3s, background 0.3s;
        }

        /* BOOT SCREEN */
        .boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--color-blue); font-family: 'Courier New', monospace;
            transition: opacity 0.8s ease-out;
        }
        .boot-loader {
            width: 200px; height: 2px; background: rgba(59, 130, 246, 0.3); margin-top: 20px;
            position: relative; overflow: hidden;
        }
        .boot-bar {
            position: absolute; left: 0; top: 0; height: 100%; width: 0%;
            background: var(--color-blue); box-shadow: 0 0 10px var(--color-blue);
            animation: loadBar 2.5s ease-in-out forwards;
        }
        .boot-text { font-size: 12px; margin-top: 10px; letter-spacing: 2px; opacity: 0.8; }
        @keyframes loadBar { 0% { width: 0%; } 40% { width: 30%; } 80% { width: 90%; } 100% { width: 100%; } }

        /* LAYOUT CONTAINER */
        .app-container {
            width: 100vw; height: 100vh;
            background: transparent;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
            opacity: 0; transition: opacity 1s;
        }

        /* BROWSER BAR */
        .browser-bar {
            height: 60px; display: flex; align-items: center; padding: 0 32px; gap: 24px;
            border-bottom: 1px solid var(--glass-border); 
            background: rgba(0,0,0,0.2); 
            backdrop-filter: blur(10px);
            z-index: 20;
            flex-shrink: 0;
        }
        .window-controls { display: flex; gap: 8px; margin-right: 12px; }
        .window-dot { width: 12px; height: 12px; border-radius: 50%; opacity: 0.8; }
        .branding-right { margin-left: auto; font-weight: 700; color: var(--text-white); letter-spacing: 1px; font-size: 14px; opacity: 0.8; display: flex; align-items: center; gap: 10px; }
        .branding-right span { color: var(--color-blue); text-shadow: 0 0 15px rgba(59, 130, 246, 0.6); }

        /* DASHBOARD BODY */
        .dashboard-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* SIDEBAR */
        .sidebar {
            width: 90px; display: flex; flex-direction: column; align-items: center; padding: 40px 0; gap: 36px;
            border-right: 1px solid var(--glass-border);
            z-index: 10;
            background: var(--sidebar-bg);
            backdrop-filter: var(--glass-blur);
            flex-shrink: 0;
        }
        .bottom-nav {
            display: none;
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--glass-border);
            padding: 10px 18px;
            z-index: 50;
        }
        .bottom-nav .nav-items { display: flex; justify-content: space-between; align-items: center; }
        .bottom-nav button {
            background: transparent; border: none; color: var(--text-white); font-size: 22px; width: 20%; padding: 10px 0;
        }
        .mobile-link-strip {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid var(--glass-border);
        }
        .mobile-link-strip a {
            white-space: nowrap;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.05);
            color: var(--text-white);
            font-size: 12px;
            text-decoration: none;
        }
        .logo { font-weight: 800; color: var(--text-white); font-size: 24px; letter-spacing: -1px; margin-bottom: 12px; }
        .logo span { color: var(--color-blue); }
        .menu-item {
            width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center;
            color: var(--text-muted); font-size: 22px; cursor: pointer; transition: 0.3s; border: 1px solid transparent;
        }
        .menu-item:hover { color: var(--text-white); background: rgba(125, 125, 125, 0.1); }
        .menu-item.active { 
            background: rgba(59, 130, 246, 0.1); 
            color: var(--color-blue); 
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); 
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* MAIN GRID */
        .main-content {
            flex: 1; padding: 30px 40px;
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 30px; overflow-y: auto; position: relative;
        }

        /* HEADER */
        .header-section {
            grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 10px; z-index: 5;
        }
        .header-left { display: flex; flex-direction: column; gap: 15px; }
        .top-toggles { display: flex; gap: 10px; }
        .toggle-pill {
            padding: 8px 24px; border-radius: 100px; font-size: 13px; font-weight: 500;
            color: var(--text-muted); background: rgba(125, 125, 125, 0.1); border: 1px solid var(--glass-border);
            cursor: pointer; transition: 0.3s; backdrop-filter: blur(10px);
        }
        .page-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 6px;
        }
        .page-nav a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.04);
            color: var(--text-white);
            font-size: 12px;
            text-decoration: none;
            transition: 0.2s;
            backdrop-filter: blur(10px);
        }
        .page-nav a:hover {
            border-color: rgba(59, 130, 246, 0.4);
            color: var(--color-blue);
        }
        .page-nav a .ph {
            font-size: 16px;
        }
        .toggle-pill.active {
            background: rgba(59, 130, 246, 0.2); color: var(--pill-active-text); border-color: rgba(59, 130, 246, 0.5);
            display: flex; align-items: center; gap: 8px; box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
        }
        .active-dot { width: 6px; height: 6px; background: var(--color-blue); border-radius: 50%; box-shadow: 0 0 10px var(--color-blue); }

        .page-title h2 { font-size: 18px; color: var(--color-blue); margin-bottom: 5px; font-weight: 600; letter-spacing: 0.5px; }
        .page-title h1 { font-size: 56px; font-weight: 700; color: var(--text-white); line-height: 1; letter-spacing: -2px; }
        .page-title h1 span { font-weight: 300; opacity: 0.8; }

        .theme-toggle {
            padding: 8px 14px; border-radius: 12px; border: 1px solid var(--glass-border);
            background: rgba(125, 125, 125, 0.1); color: var(--text-white); cursor: pointer; font-weight: 700; font-size: 12px;
        }

        /* LEFT PANEL (3D + ORGANS) */
        .left-panel-container {
            grid-column: 1; grid-row: 2;
            display: flex; flex-direction: column; gap: 20px;
            position: relative;
        }

        /* 3D STAGE */
        .heart-stage {
            flex: 1; min-height: 400px;
            position: relative;
            display: flex; justify-content: center; align-items: center;
            border-radius: 28px;
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.1);
        }
        #model-3d-container {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;
            opacity: 0; animation: fadeIn 1.5s ease-out forwards;
        }

        /* Animated Rings Background */
        .rings {
            position: absolute; width: 600px; height: 600px; border-radius: 50%;
            border: 1px solid var(--glass-border); 
            background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
            z-index: 0; animation: spin 60s linear infinite;
        }
        .rings::before {
            content: ''; position: absolute; top: 50px; left: 50px; right: 50px; bottom: 50px;
            border-radius: 50%; border: 1px dashed var(--glass-border);
            animation: spinReverse 40s linear infinite;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spinReverse { 100% { transform: rotate(-360deg); } }
        @keyframes fadeIn { to { opacity: 1; } }

        .scanner-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-cyan), transparent);
            box-shadow: 0 0 20px var(--color-cyan);
            animation: scan-down 3s ease-in-out infinite; z-index: 2; opacity: 0.3;
            pointer-events: none;
        }
        @keyframes scan-down { 0% { top: 5%; opacity: 0; } 50% { opacity: 0.6; } 100% { top: 95%; opacity: 0; } }

        /* ORGAN TRAY */
        .organ-tray-wrapper {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px;
            margin-top: -60px; /* Overlap nicely */
            z-index: 10;
            width: 100%;
        }
        .section-header.mini { font-size: 11px; margin-bottom: 10px; opacity: 0.7; }

        .organ-tray {
            display: flex;
            flex-wrap: wrap; 
            gap: 12px;
            justify-content: center;
        }

        .organ-item {
            width: 50px; height: 50px;
            background: rgba(125,125,125,0.05);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            border-radius: 14px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-shrink: 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        .premium-icon {
            position: absolute; top: 4px; right: 4px;
            width: 12px; height: 12px; border-radius: 6px;
            background: linear-gradient(135deg, #ffd166, #f97316);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.35);
        }
        .premium-icon i { font-size: 8px; color: #1f2937; }
        .organ-item:hover {
            background: rgba(125,125,125,0.1);
            transform: translateY(-3px);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .organ-item i, .organ-item svg { font-size: 22px; color: var(--text-muted); transition: 0.3s; margin-bottom: 0; fill: none; stroke: currentColor; stroke-width: 1.5; }
        
        .organ-item.selected {
            background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(0,0,0,0));
            border: 1px solid var(--color-blue);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3), inset 0 0 20px rgba(59, 130, 246, 0.1);
        }
        .organ-item.selected i, .organ-item.selected svg {
            color: var(--text-white); stroke: var(--text-white); filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.8)); transform: scale(1.1);
        }
        
        .organ-name-mini { display: none; } 

        .organ-label {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: #ffffff; color: #000; font-size: 10px; font-weight: 800;
            padding: 2px 8px; border-radius: 100px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; white-space: nowrap; z-index: 20;
        }

        /* RIGHT PANEL (VITALS + SCHEDULE) */
        .right-panel-container {
            grid-column: 2; grid-row: 2;
            display: flex; flex-direction: column; gap: 20px;
            height: 100%;
        }

        .floating-stat {
            background: var(--card-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 18px;
            padding: 14px 16px; width: 100%; z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 8px;
        }
        .live-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: rgba(239, 68, 68, 0.15); color: #ef4444; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; }
        .live-dot { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* STATS GRID */
        .section-header { font-size: 13px; font-weight: 700; color: var(--color-blue); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .blue-dot { width: 6px; height: 6px; background: var(--color-blue); border-radius: 50%; box-shadow: 0 0 8px var(--color-blue); }

        .cards-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 12px; }
        
        .data-card {
            background: var(--card-bg); 
            backdrop-filter: blur(18px);
            border-radius: 18px; padding: 16px;
            display: flex; flex-direction: column; justify-content: space-between;
            border: 1px solid var(--card-border); position: relative; overflow: hidden; transition: 0.3s;
            min-height: 110px;
        }
        
        .data-card:hover { 
            border-color: rgba(59, 130, 246, 0.4); 
            background: var(--card-hover-bg); 
            transform: translateY(-4px);
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.15); 
        }

        /* SCANNING STATE CSS */
        .scanning-text {
            color: var(--color-blue);
            font-size: 14px; font-weight: 600; letter-spacing: 1px;
            animation: pulseText 1s infinite;
        }
        @keyframes pulseText { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        /* DYNAMIC CARD COLORS */
        .data-card.state-blue .card-icon { color: var(--color-blue); }
        .data-card.active-blue {
            background: var(--card-active-bg); 
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 20px 50px -20px rgba(30, 58, 138, 0.15);
        }
        .data-card.state-yellow {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(125, 125, 125, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        .data-card.state-yellow .card-icon { color: var(--color-yellow); }
        
        .data-card.state-red {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(125, 125, 125, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.4);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.1);
        }
        .data-card.state-red .card-icon { color: var(--color-red); }

        .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; z-index: 2; }
        .card-icon { font-size: 18px; transition: color 0.3s; }
        .card-title { font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 2px; font-weight: 600; }
        .card-val { font-size: 20px; font-weight: 700; color: var(--text-white); letter-spacing: -0.5px; transition: 0.3s; }
        
        .bar-chart { display: flex; align-items: flex-end; gap: 4px; height: 35px; margin-top: auto; z-index: 2; }
        .bar { flex: 1; background: rgba(125,125,125,0.15); border-radius: 3px; transition: height 0.5s ease-in-out, background 0.3s; }
        .bar.act { background: currentColor; }
        
        .blue-square-val {
            position: absolute; right: 16px; bottom: 16px; width: 40px; height: 40px;
            background: var(--accent-blue); border-radius: 12px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4); z-index: 2;
        }
        
        /* SCHEDULE AREA */
        .schedule-area {
            flex: 1; /* Fill remaining height */
            background: var(--card-bg);
            backdrop-filter: blur(24px);
            border-radius: 20px; padding: 20px;
            border: 1px solid var(--glass-border); display: flex; flex-direction: column;
        }
        .ai-panel {
            margin-top: 0; padding: 16px; background: rgba(59, 130, 246, 0.08);
            border-radius: 16px; border: 1px solid rgba(59, 130, 246, 0.2); transition: 0.3s;
            margin-bottom: 12px;
        }
        .ai-panel .typing { font-style: italic; color: var(--text-muted); font-size: 12px; margin-top: 6px; display: none; }
        .ai-panel.warn { background: rgba(239, 68, 68, 0.1); border-color: var(--color-red); }
        .ai-title { font-size: 11px; font-weight: 800; color: var(--color-blue); margin-bottom: 6px; display: block; letter-spacing: 1px; }
        .ai-text { font-size: 12px; line-height: 1.5; color: var(--text-muted); }

        .next-checkup {
            background: rgba(125,125,125,0.05); border-radius: 16px; padding: 12px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 16px; color: var(--text-white); border: 1px solid var(--glass-border);
        }
        .date-nav {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
            background: rgba(0,0,0,0.05); padding: 4px; border-radius: 100px; border: 1px solid var(--glass-border);
        }
        .nav-arrow { 
            width: 24px; height: 24px; border-radius: 50%; background: rgba(125,125,125,0.1); 
            display: flex; justify-content: center; align-items: center; font-size: 12px; color: #9ca3af; cursor: pointer; transition: 0.2s;
        }
        .doc-list { display: flex; flex-direction: column; gap: 8px; flex: 1; overflow-y: auto; max-height: 150px; }
        .doc-row { 
            display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 12px; 
            transition: 0.2s; cursor: pointer; border: 1px solid transparent;
        }
        .doc-row:hover { background: rgba(125,125,125,0.08); border-color: var(--glass-border); }
        .doc-img { width: 36px; height: 36px; border-radius: 10px; object-fit: cover; }
        .consult-btn {
            margin-top: 16px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; padding: 12px;
            border-radius: 100px; font-weight: 700; font-size: 13px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px -5px rgba(59, 130, 246, 0.4); transition: 0.3s;
        }

        /* Sound Button */
        .sound-btn {
            position: absolute; top: 20px; left: 20px;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(125,125,125,0.1); border: 1px solid var(--glass-border);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 100; color: var(--text-white); transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .sound-btn:hover { background: rgba(125,125,125,0.2); transform: scale(1.05); }
        
        .sound-btn.active {
            color: var(--color-blue);
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--color-blue);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }
        .sound-btn.active i {
            animation: pulseIcon 1.5s infinite;
        }
        @keyframes pulseIcon { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .chat-drawer {
            position: fixed; right: 24px; bottom: 80px; width: 320px; max-width: 90vw;
            background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 18px; padding: 12px;
            backdrop-filter: blur(18px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); z-index: 40;
        }
        .chat-drawer h4 { margin-bottom: 8px; color: var(--text-white); display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .chat-messages { max-height: 220px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .chat-bubble { padding: 10px 12px; border-radius: 14px; font-size: 12px; line-height: 1.4; color: var(--text-white); }
        .chat-bubble.user { background: rgba(125,125,125,0.1); align-self: flex-end; }
        .chat-bubble.bot { background: rgba(37, 99, 235, 0.15); border: 1px solid rgba(37,99,235,0.3); }
        .chat-input-row { display: flex; gap: 8px; margin-top: 8px; }
        .chat-input-row input { flex: 1; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(125,125,125,0.05); color: var(--text-white); }
        .chat-input-row button { padding: 10px 12px; border-radius: 12px; border: none; background: var(--accent-blue); color: white; font-weight: 700; cursor: pointer; }

        .utility-launchers { position: fixed; left: 24px; bottom: 80px; display: flex; gap: 10px; z-index: 40; }
        .utility-launchers button { padding: 10px 12px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(125,125,125,0.1); color: var(--text-white); cursor: pointer; font-size: 12px; }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: none;
            align-items: center; justify-content: center; z-index: 60;
        }
        .modal-box {
            width: min(520px, 90vw); background: var(--card-bg); border-radius: 20px; border: 1px solid var(--card-border);
            padding: 20px; color: var(--text-white); box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .modal-header h3 { font-size: 16px; }
        .modal-body { font-size: 13px; color: var(--text-muted); display: flex; flex-direction: column; gap: 10px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 14px; }
        .ghost-btn { background: transparent; color: var(--text-white); border: 1px solid var(--glass-border); padding: 10px 12px; border-radius: 12px; cursor: pointer; }
        .primary-btn { background: var(--accent-blue); color: white; border: none; padding: 10px 12px; border-radius: 12px; cursor: pointer; }

        .sos-btn { position: fixed; right: 24px; bottom: 24px; width: 140px; height: 50px; border-radius: 16px; border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.12); color: var(--text-white); font-weight: 800; cursor: pointer; box-shadow: 0 10px 30px rgba(239,68,68,0.3); }
        .sos-btn.holding { background: rgba(239,68,68,0.25); }

        .file-list { display: flex; flex-direction: column; gap: 8px; }
        .file-item { padding: 10px 12px; border: 1px solid var(--glass-border); border-radius: 10px; display: flex; justify-content: space-between; align-items: center; background: rgba(125,125,125,0.05); }

        .toast { position: fixed; top: 80px; right: 24px; background: rgba(16,185,129,0.2); color: var(--text-white); padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(16,185,129,0.4); display: none; z-index: 80; }

        .faceid-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index: 70; }
        .faceid-box { width: 320px; height: 380px; border: 2px solid #0A84FF; border-radius: 24px; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .faceid-scan { position: absolute; left: 20px; right: 20px; height: 3px; background: linear-gradient(90deg, transparent, #0A84FF, transparent); animation: scan-down 2.4s linear infinite; }
        .faceid-cam { position: absolute; inset: 16px; border: 1px dashed rgba(255,255,255,0.2); border-radius: 18px; }
        .faceid-text { position: absolute; bottom: 18px; width: 100%; text-align: center; color: white; font-weight: 700; letter-spacing: 1px; }

        /* --- RESPONSIVE OPTIMIZATION --- */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 450px auto auto;
                padding: 20px;
                overflow-y: scroll;
            }
            .left-panel-container { grid-row: 2; }
            .right-panel-container { grid-row: 3; }
            .sidebar { display: none; }
            .logo { display: none; }
        }

        @media (max-width: 768px) {
            .browser-bar { padding: 0 16px; justify-content: space-between; }
            .url-bar { display: none; }
            .nav-icons { display: none; }
            .main-content { padding: 16px; gap: 20px; display: flex; flex-direction: column; }
            .page-title h1 { font-size: 36px; }
            .heart-stage { height: 320px; flex-shrink: 0; }
            .cards-grid { grid-template-columns: 1fr; }
            .organ-tray { justify-content: center; } /* Stack on mobile */
            .organ-item { width: 50px; height: 50px; }
            .organ-item i, .organ-item svg { font-size: 20px; }
        }

        @media (max-width: 1080px) {
            .sidebar { display: none; }
            .main-content { grid-template-columns: 1fr; grid-template-rows: auto auto auto; padding-bottom: 120px; }
            .left-panel-container { grid-column: 1; grid-row: 2; }
            .right-panel-container { grid-column: 1; grid-row: 3; }
            .bottom-nav { display: block; }
        }
    </style>
</head>
<body>

    <!-- BOOT SCREEN -->
    <div class="boot-screen" id="boot-screen">
        <div class="logo" style="font-size:32px;">H<span>+</span> OS</div>
        <div class="boot-loader"><div class="boot-bar"></div></div>
        <div class="boot-text">INITIALIZING BIO-SYNC PROTOCOLS...</div>
    </div>

    <div class="app-container" id="app-container">
        <div class="browser-bar">
            <div class="window-controls">
                <div class="window-dot" style="background: #ef4444;"></div>
                <div class="window-dot" style="background: #f59e0b;"></div>
                <div class="window-dot" style="background: #10b981;"></div>
            </div>
            <div class="nav-icons"><i class="ph ph-caret-left"></i><i class="ph ph-caret-right"></i></div>
            <div class="url-bar"><i class="ph-fill ph-lock-key"></i><span>Healthflo.com</span><i class="ph ph-arrow-clockwise" style="margin-left: auto;"></i></div>
            <div class="branding-right">Health flo <span>OS NEO 2.0</span></div>
        </div>

        <div class="dashboard-body">
            <div class="sidebar">
                <div class="logo">H<span>+</span></div>
                <div class="menu-item active"><i class="ph-fill ph-heartbeat"></i></div>
                <div class="menu-item"><i class="ph ph-chat-circle-dots"></i></div>
                <div class="menu-item"><i class="ph ph-file-text"></i></div>
                <div class="menu-item"><i class="ph ph-user"></i></div>
                <div class="menu-item"><i class="ph ph-squares-four"></i></div>
                <div class="menu-item" style="margin-top: auto; color: #ef4444;"><i class="ph ph-power"></i></div>
            </div>

            <div class="main-content">
                
                <div class="header-section">
                    <div class="header-left">
                        <div class="top-toggles">
                            <div class="toggle-pill">Diagnose</div>
                            <div class="toggle-pill active" id="mode-pill"><div class="active-dot"></div> My Heart</div>
                        </div>
                        <div class="page-title">
                            <h2>Hi Dhivakaran,</h2>
                            <h1>Overview <span>Conditions</span></h1>
                        </div>
                        <div class="page-nav" id="page-nav"></div>
                    </div>
                    <button class="theme-toggle" id="theme-toggle">White Theme</button>
                </div>

                <!-- LEFT PANEL: 3D HERO + ORGAN DOCK -->
                <div class="left-panel-container">
                    <div class="heart-stage">
                        <div class="sound-btn" id="sound-toggle"><i class="ph-fill ph-speaker-simple-high"></i></div>
                        <div class="rings"></div>
                        <div class="scanner-line"></div>
                        <div id="model-3d-container"></div>
                    </div>
                    
                    <div class="organ-tray-wrapper">
                        <div class="section-header mini">Select Organ System</div>
                        <div class="organ-tray"></div>
                    </div>
                </div>

                <!-- RIGHT PANEL: DATA + SCHEDULE -->
                <div class="right-panel-container">
                    <div class="floating-stat" id="float-card">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div class="live-badge"><div class="live-dot"></div> LIVE</div>
                            <span style="font-size:12px; color:#9ca3af; font-weight:700;">Real-time telemetry</span>
                        </div>
                        <div style="font-size:26px; font-weight:800; margin-bottom:4px; color: var(--text-white);" id="main-stat">120 <span style="font-size:12px; font-weight:500;">bpm</span></div>
                        <!-- Animated SVG Graph -->
                        <svg width="100%" height="30" viewBox="0 0 200 30" id="live-ecg-svg" preserveAspectRatio="none">
                            <path id="live-ecg-path" d="" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>

                    <div class="ai-panel" id="ai-panel">
                        <span class="ai-title" id="ai-title">AI ANALYSIS</span>
                        <p class="ai-text" id="ai-text">Patient vitals are stable. All organ functions within normal range. Monitoring active.</p>
                        <div class="typing" id="ai-typing">AI is typing...</div>
                    </div>
                    
                    <div class="ai-panel" id="diagnosis-panel" style="display: none;"> <!-- Hidden by default, shown by logic -->
                        <span class="ai-title">DIAGNOSIS PANEL</span>
                        <p class="ai-text" id="diagnosis-text">No critical keywords detected. Keep monitoring.</p>
                    </div>

                    <div class="section-header"><div class="blue-dot"></div> <span id="section-title">My Heart Condition</span></div>
                    
                    <div class="cards-grid">
                        <div class="data-card state-blue" id="card-1">
                            <div class="card-head">
                                <div><span class="card-title" id="c1-title">Blood Status</span><span class="card-val" id="c1-val">116/70</span></div>
                                <i class="ph-fill ph-drop card-icon" id="c1-icon"></i>
                            </div>
                            <div class="bar-chart" id="blood-chart">
                                <div class="bar" style="height:40%"></div><div class="bar" style="height:70%"></div><div class="bar" style="height:50%"></div><div class="bar act" style="height:90%"></div><div class="bar act" style="height:60%"></div><div class="bar" style="height:40%"></div>
                            </div>
                        </div>
                        <div class="data-card active-blue" id="card-2">
                            <div class="card-head">
                                <div><span class="card-title" id="c2-title">Heart Rate</span><span class="card-val" id="c2-val">120 <span style="font-size:14px; font-weight:500;">bpm</span></span></div>
                                <i class="ph ph-heartbeat card-icon" style="color:white;" id="c2-icon"></i>
                            </div>
                            <svg width="100%" height="50" style="margin-top:auto; opacity:0.8; overflow:visible;"><path id="card-wave-path" d="M0,25 Q10,25 15,10 T30,25 T45,40 T60,10 T75,25 T100,25" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round"/></svg>
                            <div class="blue-square-val"><span style="font-size:16px; font-weight:800;" id="box-bpm">120</span></div>
                        </div>
                        <div class="data-card state-blue" id="card-3">
                            <div class="card-head">
                                <div><span class="card-title" id="c3-title">Blood Count</span><span class="card-val" id="c3-val">80-90</span></div>
                                <i class="ph-fill ph-chart-bar card-icon" id="c3-icon"></i>
                            </div>
                            <svg width="100%" height="40" style="margin-top:auto;"><path d="M0,20 Q25,5 50,20 T100,20" fill="none" stroke="#6b7280" stroke-width="2.5" stroke-linecap="round"/><circle cx="80" cy="20" r="4" fill="#3b82f6" /></svg>
                        </div>
                        <div class="data-card state-blue" id="card-4">
                            <div class="card-head">
                                <div><span class="card-title" id="c4-title">Glucose Level</span><span class="card-val" id="c4-val">230<small style="font-size:12px; color:#6b7280;">/ml</small></span></div>
                                <i class="ph-fill ph-dna card-icon" id="c4-icon"></i>
                            </div>
                            <svg width="100%" height="40" style="margin-top:auto;"><path d="M0,20 L10,25 L20,15 L30,25 L40,15 L50,25 L60,15 L100,20" fill="none" stroke="#6b7280" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/></svg>
                        </div>
                    </div>

                    <div class="schedule-area" style="margin-top: 10px;">
                        <div class="section-header" style="margin-bottom:10px;"><div class="blue-dot"></div> Care Schedule</div>
                        <div class="next-checkup">
                            <div><div style="font-size:11px; color:#9ca3af; margin-bottom:4px; font-weight: 600;">NEXT CHECKUP</div><div style="font-weight:700; font-size: 15px;">Fri, 24 Mar</div></div>
                            <i class="ph-fill ph-calendar-check" style="font-size:24px; color: var(--color-blue);"></i>
                        </div>
                        <div class="date-nav">
                            <div class="nav-arrow"><i class="ph-bold ph-caret-left"></i></div><span style="font-size:13px; color:var(--text-white); font-weight:600;">20 March 2023</span><div class="nav-arrow"><i class="ph-bold ph-caret-right"></i></div>
                        </div>
                        <div class="doc-list">
                            <div class="doc-row"><img src="https://randomuser.me/api/portraits/men/32.jpg" class="doc-img" alt=""><div><div style="font-size:13px; font-weight:700; color:var(--text-white);">Dr. Hanzer Jon</div><div style="font-size:11px; color:#9ca3af;">Cardiologist</div></div></div>
                            <div class="doc-row"><img src="https://randomuser.me/api/portraits/women/45.jpg" class="doc-img" alt=""><div><div style="font-size:13px; font-weight:700; color:var(--text-white);">Dr. Sarah Lee</div><div style="font-size:11px; color:#9ca3af;">Neurologist</div></div></div>
                        </div>
                        <button class="consult-btn">Consult Now <i class="ph-bold ph-arrow-right"></i></button>
                    </div>
                </div>

            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-items">
                <button><i class="ph-fill ph-heartbeat"></i></button>
                <button><i class="ph ph-brain"></i></button>
                <button id="open-video"><i class="ph ph-video-camera"></i></button>
                <button id="open-pharmacy"><i class="ph ph-pill"></i></button>
                <button id="open-files"><i class="ph ph-folder"></i></button>
            </div>
        <div class="mobile-link-strip" id="mobile-nav-links"></div>
        </div>

        <div class="utility-launchers">
            <button id="launch-video">Video Call</button>
            <button id="launch-pharmacy">Refill Rx</button>
            <button id="launch-files">Files</button>
            <button id="launch-faceid">Secure</button>
        </div>

        <div class="chat-drawer" id="chat-drawer">
            <h4><i class="ph ph-robot"></i> AI Assistant</h4>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-row">
                <input type="text" id="chat-input" placeholder="Describe symptoms e.g. pain, bleeding" />
                <button id="chat-send"><i class="ph ph-paper-plane-tilt"></i></button>
            </div>
        </div>

        <button class="sos-btn" id="sos-btn">Hold for SOS</button>

        <div class="modal-overlay" id="video-modal">
            <div class="modal-box">
                <div class="modal-header"><h3>Telemedicine Call</h3><button class="ghost-btn" data-close="video-modal">Close</button></div>
                <div class="modal-body">
                    <p>Connecting to Dr. Lee... camera <strong id="cam-state">ON</strong></p>
                    <div style="display:flex; gap:10px;">
                        <button class="ghost-btn" id="toggle-cam">Toggle Camera</button>
                        <button class="primary-btn" id="end-call">End Call</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="pharmacy-modal">
            <div class="modal-box">
                <div class="modal-header"><h3>Pharmacy Refill</h3><button class="ghost-btn" data-close="pharmacy-modal">Close</button></div>
                <div class="modal-body">
                    <p>Select prescription to refill:</p>
                    <select id="rx-select" style="padding:10px; border-radius:10px; border:1px solid var(--glass-border); background: rgba(255,255,255,0.05); color:var(--text-white);">
                        <option>Atenolol 25mg</option>
                        <option>Losartan 50mg</option>
                        <option>Metformin 500mg</option>
                    </select>
                    <div class="modal-actions"><button class="primary-btn" id="submit-rx">Submit Refill</button></div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="files-modal">
            <div class="modal-box">
                <div class="modal-header"><h3>Medical Files</h3><button class="ghost-btn" data-close="files-modal">Close</button></div>
                <div class="modal-body">
                    <div class="file-list">
                        <div class="file-item">MRI_Report.pdf <button class="primary-btn" data-file="MRI_Report.pdf">Download</button></div>
                        <div class="file-item">Bloodwork_Results.png <button class="primary-btn" data-file="Bloodwork_Results.png">Download</button></div>
                        <div class="file-item">Prescription_List.pdf <button class="primary-btn" data-file="Prescription_List.pdf">Download</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="faceid-overlay" id="faceid-overlay">
            <div class="faceid-box">
                <div class="faceid-cam"></div>
                <div class="faceid-scan"></div>
                <div class="faceid-text" id="faceid-text">Scanning Face ID...</div>
            </div>
        </div>

        <div class="toast" id="toast">Download started</div>

    </div>
    
    <script>
        // --- CUSTOM SVG ICONS FOR ORGANS ---
        const ORGAN_SVGS = {
            liver: `<svg viewBox="0 0 24 24"><path d="M20.5 13.5c-.5-3.5-3.5-6.5-8.5-6.5s-8 3-8 6.5c0 3.5 3 6.5 6 6.5 1.5 0 3-.5 4.5-1.5 3.5-2.5 5.5-3.5 6-5z" /><path d="M8 8.5v3" /></svg>`,
            lungs: `<svg viewBox="0 0 24 24"><path d="M12 2v20M6 5c-2.2 0-4 2.2-4 5.5S4 19 6.5 19 11 17 11 12 8.2 5 6 5zM18 5c2.2 0 4 2.2 4 5.5S20 19 17.5 19 13 17 13 12 15.8 5 18 5z" /></svg>`,
            kidneys: `<svg viewBox="0 0 24 24"><path d="M7.5 6c-2.5 0-4.5 2-4.5 5.5s3 7.5 6 7.5c2 0 3-1.5 3-4-1 1-3 0-3-2s2-3.5 4.5-3.5c-1-2.5-3.5-3.5-6-3.5z" /><path d="M16.5 6c2.5 0 4.5 2 4.5 5.5s-3 7.5-6 7.5c-2 0-3-1.5-3-4 1 1 3 0 3-2s-2-3.5-4.5-3.5c1-2.5 3.5-3.5 6-3.5z" /></svg>`,
            stomach: `<svg viewBox="0 0 24 24"><path d="M7 5c2-2 7-2 9 0 2 2 2 6 0 9-1 1.5-3 5-3 5-2 1-5 1-7-1s-3-5-2-8c1-3 3-5 3-5z" /><path d="M10 8h4" /></svg>`,
            intestines: `<svg viewBox="0 0 24 24"><path d="M6 5c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v1c0 1.1-.9 2-2 2H8c-1.1 0-2 .9-2 2v1c0 1.1.9 2 2 2h8c1.1 0 2 .9 2 2v1c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2V5z" /></svg>`,
            pancreas: `<svg viewBox="0 0 24 24"><path d="M21 9c-1-2-4-2-6 0l-9 9c-2 2-2 4 0 4s2 2 4 0l11-11c.5-.5 1-1.5 0-2z" /><path d="M12 12l2 2" /></svg>`,
            gallbladder: `<svg viewBox="0 0 24 24"><path d="M12 3c-1.5 0-3 1.5-3 3v2c0 3.5 2 8 3 8s3-4.5 3-8V6c0-1.5-1.5-3-3-3z" /></svg>`,
            urinary: `<svg viewBox="0 0 24 24"><path d="M12 4v4M8 10c0 4 1.5 8 4 8s4-4 4-8H8zM12 18v3" /></svg>`
        };

        // --- COMPREHENSIVE ORGAN DATA ---
        const ORGAN_DATA = {
            heart: {
                title: "My Heart Condition",
                mainStat: "BPM",
                animKey: "bpm", 
                simValue: 80,
                icon: "ph-heart",
                stats: [
                    { id: "c1", title: "Blood Pressure", base: 116, unit: "/70", icon: "ph-drop", type: "bp" },
                    { id: "c2", title: "Heart Rate", base: 80, unit: "bpm", icon: "ph-heartbeat", type: "bpm" },
                    { id: "c3", title: "O2 Saturation", base: 98, unit: "%", icon: "ph-activity", type: "norm" },
                    { id: "c4", title: "Cardiac Output", base: 5.2, unit: "L/min", icon: "ph-waves", type: "norm" }
                ],
                abnormal: { msg: "Arrhythmia Detected.", action: "Recommend immediate ECG." }
            },
            brain: {
                title: "Brain & Nervous System",
                mainStat: "Hz",
                animKey: "hz",
                simValue: 14,
                icon: "ph-brain",
                stats: [
                    { id: "c1", title: "Brain Waves", base: 14, unit: "Hz", icon: "ph-wave-sine", type: "hz" },
                    { id: "c2", title: "Cognitive Load", base: 45, unit: "%", icon: "ph-lightning", type: "perc" },
                    { id: "c3", title: "Oxygenation", base: 99, unit: "%", icon: "ph-wind", type: "perc" },
                    { id: "c4", title: "ICP", base: 11, unit: "mmHg", icon: "ph-gauge", type: "norm" }
                ],
                abnormal: { msg: "High Cortisol Levels.", action: "Stress reduction advised." }
            },
            liver: {
                title: "Liver Function",
                mainStat: "Tox",
                animKey: "tox",
                simValue: 5,
                icon: "svg-liver",
                stats: [
                    { id: "c1", title: "ALT Enzymes", base: 29, unit: "U/L", icon: "ph-flask", type: "norm" },
                    { id: "c2", title: "Toxicity Filter", base: 95, unit: "%", icon: "ph-shield-check", type: "perc" },
                    { id: "c3", title: "Bilirubin", base: 0.8, unit: "mg", icon: "ph-test-tube", type: "norm" },
                    { id: "c4", title: "Albumin", base: 4.2, unit: "g/dL", icon: "ph-egg", type: "norm" }
                ],
                abnormal: { msg: "Elevated Enzymes.", action: "Dietary review needed." }
            },
            lungs: {
                title: "Respiratory System",
                mainStat: "RPM",
                animKey: "rpm",
                simValue: 16,
                icon: "svg-lungs",
                stats: [
                    { id: "c1", title: "Resp Rate", base: 16, unit: "rpm", icon: "ph-wind", type: "rpm" },
                    { id: "c2", title: "SpO2 Level", base: 98, unit: "%", icon: "ph-drop", type: "perc" },
                    { id: "c3", title: "Lung Capacity", base: 4.8, unit: "L", icon: "ph-chart-bar", type: "norm" },
                    { id: "c4", title: "EtCO2", base: 38, unit: "mmHg", icon: "ph-cloud", type: "norm" }
                ],
                abnormal: { msg: "Reduced Capacity.", action: "Spirometry test advised." }
            },
            kidneys: {
                title: "Renal Function",
                mainStat: "GFR",
                animKey: "gfr",
                simValue: 90,
                icon: "svg-kidneys",
                stats: [
                    { id: "c1", title: "GFR", base: 95, unit: "mL", icon: "ph-activity", type: "norm" },
                    { id: "c2", title: "Creatinine", base: 0.9, unit: "mg", icon: "ph-flask", type: "norm" },
                    { id: "c3", title: "Urea (BUN)", base: 14, unit: "mg", icon: "ph-test-tube", type: "norm" },
                    { id: "c4", title: "Hydration", base: 92, unit: "%", icon: "ph-drop-half", type: "perc" }
                ],
                abnormal: { msg: "Low Filtration.", action: "Increase fluid intake." }
            },
            stomach: {
                title: "Gastric Health",
                mainStat: "pH",
                animKey: "ph",
                simValue: 2,
                icon: "svg-stomach",
                stats: [
                    { id: "c1", title: "Acidity (pH)", base: 2.1, unit: "pH", icon: "ph-drop", type: "norm" },
                    { id: "c2", title: "Motility", base: 3, unit: "cpm", icon: "ph-waves", type: "norm" },
                    { id: "c3", title: "Digestion", base: 94, unit: "%", icon: "ph-percent", type: "perc" },
                    { id: "c4", title: "Microbiome", base: 90, unit: "Sc", icon: "ph-plant", type: "norm" }
                ],
                abnormal: { msg: "High Acidity.", action: "Antacid recommended." }
            },
            intestines: {
                title: "Intestinal Tract",
                mainStat: "Absorp",
                animKey: "mot",
                simValue: 95,
                icon: "svg-intestines", 
                stats: [
                    { id: "c1", title: "Peristalsis", base: 8, unit: "/min", icon: "ph-arrows-left-right", type: "norm" },
                    { id: "c2", title: "Absorption", base: 95, unit: "%", icon: "ph-arrow-fat-lines-in", type: "perc" },
                    { id: "c3", title: "Flora", base: 92, unit: "%", icon: "ph-plant", type: "norm" },
                    { id: "c4", title: "Fiber Intake", base: 25, unit: "g", icon: "ph-carrot", type: "norm" }
                ],
                abnormal: { msg: "Slow Transit.", action: "Increase fiber intake." }
            },
            eyes: {
                title: "Ocular Health",
                mainStat: "Vision",
                animKey: "vis",
                simValue: 20,
                icon: "ph-eye",
                stats: [
                    { id: "c1", title: "Acuity (R)", base: 20, unit: "/20", icon: "ph-eye", type: "norm" },
                    { id: "c2", title: "Acuity (L)", base: 20, unit: "/20", icon: "ph-eye", type: "norm" },
                    { id: "c3", title: "Pressure", base: 16, unit: "mmHg", icon: "ph-gauge", type: "norm" },
                    { id: "c4", title: "Response", base: 150, unit: "ms", icon: "ph-timer", type: "norm" }
                ],
                abnormal: { msg: "Elevated IOP.", action: "Glaucoma screening." }
            },
            pancreas: {
                title: "Pancreatic System",
                mainStat: "Insulin",
                animKey: "ins",
                simValue: 12,
                icon: "svg-pancreas",
                stats: [
                    { id: "c1", title: "Insulin", base: 12, unit: "uIU", icon: "ph-drop", type: "norm" },
                    { id: "c2", title: "Glucose", base: 92, unit: "mg", icon: "ph-cube", type: "norm" },
                    { id: "c3", title: "Lipase", base: 45, unit: "U/L", icon: "ph-flask", type: "norm" },
                    { id: "c4", title: "Amylase", base: 55, unit: "U/L", icon: "ph-test-tube", type: "norm" }
                ],
                abnormal: { msg: "Sugar Spike.", action: "Monitor carbohydrate intake." }
            },
            gallbladder: {
                title: "Gallbladder",
                mainStat: "Bile",
                animKey: "bile",
                simValue: 100,
                icon: "svg-gallbladder",
                stats: [
                    { id: "c1", title: "Bile Flow", base: 100, unit: "%", icon: "ph-waves", type: "norm" },
                    { id: "c2", title: "Calculi", base: 0, unit: "cnt", icon: "ph-prohibit", type: "norm" },
                    { id: "c3", title: "Wall Thick", base: 2, unit: "mm", icon: "ph-ruler", type: "norm" },
                    { id: "c4", title: "Ejection", base: 65, unit: "%", icon: "ph-arrow-fat-up", type: "norm" }
                ],
                abnormal: { msg: "Flow Reduced.", action: "Ultrasound advised." }
            },
            urinary: {
                title: "Urinary Tract",
                mainStat: "Output",
                animKey: "out",
                simValue: 1500,
                icon: "svg-urinary",
                stats: [
                    { id: "c1", title: "24h Output", base: 1.5, unit: "L", icon: "ph-drop", type: "norm" },
                    { id: "c2", title: "pH Level", base: 6.0, unit: "pH", icon: "ph-test-tube", type: "norm" },
                    { id: "c3", title: "Specific Grav", base: 1.01, unit: "sg", icon: "ph-flask", type: "norm" },
                    { id: "c4", title: "Leukocytes", base: 0, unit: "neg", icon: "ph-shield", type: "norm" }
                ],
                abnormal: { msg: "Trace Protein.", action: "Retest in 24 hours." }
            },
            skeletal: {
                title: "Skeletal System",
                mainStat: "Density",
                animKey: "den",
                simValue: 0,
                icon: "ph-bone",
                stats: [
                    { id: "c1", title: "Bone Density", base: 0.5, unit: "T", icon: "ph-chart-bar", type: "norm" },
                    { id: "c2", title: "Calcium", base: 9.4, unit: "mg", icon: "ph-drop", type: "norm" },
                    { id: "c3", title: "Vit D3", base: 45, unit: "ng", icon: "ph-sun", type: "norm" },
                    { id: "c4", title: "Marrow Act", base: 98, unit: "%", icon: "ph-activity", type: "perc" }
                ],
                abnormal: { msg: "Mild Osteopenia.", action: "Increase Calcium/D3." }
            },
            cells: {
                title: "Cellular Health",
                mainStat: "Count",
                animKey: "wbc",
                simValue: 6.5,
                icon: "ph-dna",
                stats: [
                    { id: "c1", title: "WBC Count", base: 6.5, unit: "k", icon: "ph-shield-check", type: "norm" },
                    { id: "c2", title: "RBC Count", base: 5.1, unit: "M", icon: "ph-drop", type: "norm" },
                    { id: "c3", title: "Platelets", base: 250, unit: "k", icon: "ph-bandaids", type: "norm" },
                    { id: "c4", title: "Regen Rate", base: 95, unit: "%", icon: "ph-arrows-clockwise", type: "perc" }
                ],
                abnormal: { msg: "Low Platelets.", action: "Hematology consult." }
            },
            immune: {
                title: "Immune System",
                mainStat: "Resp",
                animKey: "imm",
                simValue: 98,
                icon: "ph-shield-star",
                stats: [
                    { id: "c1", title: "Response", base: 98, unit: "%", icon: "ph-lightning", type: "perc" },
                    { id: "c2", title: "Neutrophils", base: 60, unit: "%", icon: "ph-chart-pie", type: "norm" },
                    { id: "c3", title: "Lymphocytes", base: 30, unit: "%", icon: "ph-users", type: "norm" },
                    { id: "c4", title: "Inflammation", base: 0.3, unit: "CRP", icon: "ph-fire", type: "norm" }
                ],
                abnormal: { msg: "Elevated CRP.", action: "Check for infection." }
            },
            dental: {
                title: "Dental Health",
                mainStat: "Plaque",
                animKey: "den",
                simValue: 5,
                icon: "ph-smiley",
                stats: [
                    { id: "c1", title: "Plaque Idx", base: 5, unit: "%", icon: "ph-sparkle", type: "norm" },
                    { id: "c2", title: "Gum Health", base: 98, unit: "%", icon: "ph-heart", type: "perc" },
                    { id: "c3", title: "Enamel", base: 95, unit: "%", icon: "ph-shield", type: "perc" },
                    { id: "c4", title: "pH Balance", base: 7.0, unit: "pH", icon: "ph-drop", type: "norm" }
                ],
                abnormal: { msg: "Gingivitis Risk.", action: "Hygiene review." }
            },
            breast: {
                title: "Breast Tissue",
                mainStat: "Dense",
                animKey: "br",
                simValue: 2,
                icon: "ph-gender-female",
                stats: [
                    { id: "c1", title: "Density", base: 2, unit: "Cat", icon: "ph-squares-four", type: "norm" },
                    { id: "c2", title: "Vascularity", base: "Norm", unit: "", icon: "ph-waves", type: "norm" },
                    { id: "c3", title: "Lymph Nodes", base: "Clrv", unit: "", icon: "ph-check-circle", type: "norm" },
                    { id: "c4", title: "Asymmetry", base: 0, unit: "%", icon: "ph-scales", type: "norm" }
                ],
                abnormal: { msg: "Dense Tissue.", action: "Annual mammogram." }
            },
            ligaments: {
                title: "Joints & Ligaments",
                mainStat: "Flex",
                animKey: "flx",
                simValue: 85,
                icon: "ph-person-simple-run",
                stats: [
                    { id: "c1", title: "Flexibility", base: 85, unit: "%", icon: "ph-arrows-out", type: "perc" },
                    { id: "c2", title: "Synovial Fld", base: 100, unit: "%", icon: "ph-drop", type: "norm" },
                    { id: "c3", title: "Inflammation", base: 2, unit: "%", icon: "ph-fire", type: "norm" },
                    { id: "c4", title: "Cartilage", base: 90, unit: "%", icon: "ph-circle-notch", type: "norm" }
                ],
                abnormal: { msg: "Stiffness.", action: "Mobility exercises." }
            }
        };

        const KEYWORD_RISK = {
            bleeding: 'Critical',
            pain: 'Severe',
            dizzy: 'Severe',
            nausea: 'Mild',
            faint: 'Critical',
            fever: 'Mild'
        };

        const simulateGPS = () => {
            const baseLat = 37.7749, baseLng = -122.4194;
            return {
                lat: (baseLat + (Math.random() - 0.5) * 0.02).toFixed(5),
                lng: (baseLng + (Math.random() - 0.5) * 0.02).toFixed(5)
            };
        };

        let lastSnapshotTime = Date.now();
        let watchdogTimer = null;

        const getColorClass = (val, type) => {
            if (type === 'bpm') {
                if (val < 60 || val > 120) return 'state-red';
                if (val > 100) return 'state-yellow';
                return 'state-blue';
            }
            if (type === 'perc') {
                if (val < 80) return 'state-red';
                if (val < 90) return 'state-yellow';
                return 'state-blue';
            }
            const r = Math.random();
            if (r > 0.95) return 'state-red';
            if (r > 0.8) return 'state-yellow';
            return 'state-blue';
        };

        let activeOrgan = 'heart';
        let liveIntervals = [];

        const triggerSOS = (reason = 'Manual SOS triggered.') => {
            const sosBtn = document.getElementById('sos-btn');
            sosBtn.innerText = 'SOS SENT';
            sosBtn.classList.add('holding');
            const aiPanel = document.getElementById('ai-panel');
            aiPanel.classList.add('warn');
            document.getElementById('ai-title').innerText = 'EMERGENCY DISPATCHED';
            document.getElementById('ai-text').innerText = reason;
            updateDiagnosisPanel('sos', 'Critical');
            showToast('Emergency alert sent to guardian network');
        };

        // --- BIO-SYNC AUDIO ENGINE ---
        // Generates pleasant procedural heart sounds based on BPM
        const AudioEngine = {
            ctx: null,
            nextNoteTime: 0.0,
            timerID: null,
            bpm: 80,
            isPlaying: false,

            init: function() {
                if (!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
            },

            toggle: function() {
                this.init();
                // Resume context if suspended (common in browsers preventing autoplay)
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
                
                this.isPlaying = !this.isPlaying;
                
                // Visual feedback for audio button
                const btn = document.getElementById('sound-toggle');
                if(this.isPlaying) btn.classList.add('active');
                else btn.classList.remove('active');
                
                if (this.isPlaying) {
                    this.nextNoteTime = this.ctx.currentTime + 0.1;
                    this.scheduler();
                } else {
                    window.clearTimeout(this.timerID);
                }
                return this.isPlaying;
            },

            setBPM: function(newBpm) {
                this.bpm = newBpm;
            },

            scheduleHeartbeat: function(time) {
                // "LUB" Sound (Low, Thud)
                const osc1 = this.ctx.createOscillator();
                const gain1 = this.ctx.createGain();
                const filter1 = this.ctx.createBiquadFilter();

                osc1.type = 'triangle';
                osc1.frequency.setValueAtTime(60, time);
                osc1.frequency.exponentialRampToValueAtTime(40, time + 0.1);

                filter1.type = 'lowpass';
                filter1.frequency.value = 180;

                // Envelope
                gain1.gain.setValueAtTime(0, time);
                gain1.gain.linearRampToValueAtTime(0.8, time + 0.02);
                gain1.gain.exponentialRampToValueAtTime(0.001, time + 0.15);

                osc1.connect(filter1);
                filter1.connect(gain1);
                gain1.connect(this.ctx.destination);

                osc1.start(time);
                osc1.stop(time + 0.2);

                // "DUB" Sound (Slightly higher, sharper)
                const t2 = time + 0.25; // Delay for Dub
                const osc2 = this.ctx.createOscillator();
                const gain2 = this.ctx.createGain();
                const filter2 = this.ctx.createBiquadFilter();

                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(80, t2);
                osc2.frequency.exponentialRampToValueAtTime(50, t2 + 0.1);

                filter2.type = 'lowpass';
                filter2.frequency.value = 250;

                gain2.gain.setValueAtTime(0, t2);
                gain2.gain.linearRampToValueAtTime(0.6, t2 + 0.02);
                gain2.gain.exponentialRampToValueAtTime(0.001, t2 + 0.15);

                osc2.connect(filter2);
                filter2.connect(gain2);
                gain2.connect(this.ctx.destination);

                osc2.start(t2);
                osc2.stop(t2 + 0.2);
            },

            scheduler: function() {
                while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                    if(activeOrgan === 'heart') {
                        this.scheduleHeartbeat(this.nextNoteTime);
                    }
                    // Add logic for other organ sounds if needed
                    
                    const secondsPerBeat = 60.0 / this.bpm;
                    this.nextNoteTime += secondsPerBeat;
                }
                this.timerID = window.setTimeout(this.scheduler.bind(this), 25);
            }
        };

        // --- DASHBOARD LOGIC ---
        const chatMessages = [];

        const pushChatMessage = (role, text) => {
            chatMessages.push({ role, text });
            const container = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role}`;
            bubble.innerText = text;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        };

        const updateDiagnosisPanel = (keyword, risk) => {
            const diag = document.getElementById('diagnosis-panel');
            const text = document.getElementById('diagnosis-text');
            if(diag.style.display === 'none') diag.style.display = 'block'; // Ensure visible when active
            
            diag.className = 'ai-panel' + (risk === 'Critical' || risk === 'Severe' ? ' warn' : '');
            text.innerText = risk ? `${risk} risk symptom detected (${keyword}). Notify clinician.` : 'No critical keywords detected. Keep monitoring.';

            const aiPanel = document.getElementById('ai-panel');
            if (risk === 'Critical' || risk === 'Severe') {
                aiPanel.classList.add('warn');
                document.getElementById('ai-title').innerText = 'SYMPTOM ALERT';
                document.getElementById('ai-text').innerText = `Keyword "${keyword}" maps to ${risk} risk. Escalate if persists.`;
            }
        };

        const analyzeKeywords = (input) => {
            const lower = input.toLowerCase();
            let detected = null;
            let level = null;
            Object.keys(KEYWORD_RISK).forEach(k => {
                if (lower.includes(k)) {
                    detected = k;
                    level = KEYWORD_RISK[k];
                }
            });
            return { detected, level };
        };

        const persistVitalsSnapshot = () => {
            const snapshot = {
                ts: Date.now(),
                organ: activeOrgan,
                stats: Array.from({ length: 4 }).map((_, idx) => {
                    const val = document.getElementById(`c${idx + 1}-val`).innerText;
                    return { id: idx + 1, val };
                }),
                location: simulateGPS()
            };
            lastSnapshotTime = snapshot.ts;
            localStorage.setItem('dashboardVitals', JSON.stringify(snapshot));
        };

        const appendMedicalLog = () => {
            const snapshot = JSON.parse(localStorage.getItem('dashboardVitals') || '{}');
            if(!snapshot.ts) return;
            const existing = JSON.parse(localStorage.getItem('medicalLog') || '[]');
            existing.push({
                ts: snapshot.ts,
                organ: snapshot.organ,
                stats: snapshot.stats,
                location: snapshot.location,
                category: 'Vitals'
            });
            localStorage.setItem('medicalLog', JSON.stringify(existing.slice(-200)));
        };

        const showToast = (msg) => {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2500);
        }

        const startWatchdog = () => {
            if (watchdogTimer) clearInterval(watchdogTimer);
            watchdogTimer = setInterval(() => {
                const now = Date.now();
                if(now - lastSnapshotTime > 20 * 60 * 1000) {
                    triggerSOS('Data feed lost for over 20 minutes. Alerting guardian network.');
                }
            }, 60000);
        };

        const generateOrganButtons = () => {
            const tray = document.querySelector('.organ-tray'); 
            tray.innerHTML = '';
            
            Object.keys(ORGAN_DATA).forEach(key => {
                const data = ORGAN_DATA[key];
                const btn = document.createElement('div');
                btn.className = `organ-item ${key === 'heart' ? 'selected' : ''}`;
                btn.dataset.organ = key;
                
                // Logic to use custom SVG if available, else fallback to Phosphor icon class
                let iconHtml = '';
                if (data.icon.startsWith('svg-')) {
                    const svgKey = data.icon.split('-')[1];
                    iconHtml = ORGAN_SVGS[svgKey] || '<i class="ph ph-warning"></i>'; // Fallback
                } else {
                    iconHtml = `<i class="ph ${data.icon}"></i>`;
                }

                btn.innerHTML = `
                    <div class="premium-icon"><i class="ph-fill ph-seal-check"></i></div>
                    ${iconHtml}
                    <span class="organ-name-mini">${key.toUpperCase()}</span>
                    ${key === 'heart' ? '<div class="organ-label">My Heart</div>' : ''}
                `;
                tray.appendChild(btn);
            });
        };

        const updateUI = (organType) => {
            activeOrgan = organType;
            const data = ORGAN_DATA[organType];
            
            // Audio Sync
            AudioEngine.setBPM(data.simValue);

            // Text Updates
            document.getElementById('section-title').innerHTML = `<div class="blue-dot"></div> ${data.title}`;
            document.getElementById('mode-pill').innerHTML = `<div class="active-dot"></div> My ${organType.charAt(0).toUpperCase() + organType.slice(1)}`;
            
            // AI Panel Reset
            const aiPanel = document.getElementById('ai-panel');
            aiPanel.className = 'ai-panel';
            document.getElementById('ai-title').innerText = "AI ANALYSIS";
            document.getElementById('ai-text').innerText = "Analyzing recent biometrics. Systems operating within normal parameters.";

            // Show Scanning State briefly
            data.stats.forEach((s, i) => {
                const idx = i + 1;
                document.getElementById(`c${idx}-title`).innerText = s.title;
                document.getElementById(`c${idx}-icon`).className = `ph-fill ${s.icon} card-icon`;
                
                // Reset to scanning
                document.getElementById(`c${idx}-val`).innerHTML = `<span class="scanning-text">Scanning...</span>`;
                const card = document.getElementById(`card-${idx}`);
                card.className = `data-card state-blue`; // Reset color
            });

            // Simulate Scan Delay then reveal
            setTimeout(() => {
                data.stats.forEach((s, i) => {
                    const idx = i + 1;
                    updateCardValue(idx, s.base, s.unit, s.type);
                });
                startLiveSimulation(organType);
            }, 800);
        };

        const updateCardValue = (idx, val, unit, type) => {
            const card = document.getElementById(`card-${idx}`);
            const state = getColorClass(val, type);
            
            if(idx !== 2) {
                card.className = `data-card ${state}`;
            } else {
                if(state === 'state-red') card.className = `data-card state-red`;
                else card.className = `data-card active-blue`;
            }
            
            const el = document.getElementById(`c${idx}-val`);
            el.innerHTML = `${val} <span style="font-size:12px;opacity:0.6;">${unit}</span>`;

            const activeData = ORGAN_DATA[activeOrgan];
            const shouldDrivePulse = type === activeData.animKey;

            if (idx === 2 || shouldDrivePulse) {
                document.getElementById('main-stat').innerHTML = `${val} <span style="font-size:12px;font-weight:500;">${unit}</span>`;
                const boxBpm = document.getElementById('box-bpm');
                if(boxBpm) boxBpm.innerText = val;

                if(shouldDrivePulse) {
                    const bpmNumber = parseFloat(val) || activeData.simValue;
                    activeData.simValue = bpmNumber;
                    AudioEngine.setBPM(bpmNumber);
                }
            }
            persistVitalsSnapshot();
        };

        // --- ANIMATED ECG LOGIC ---
        let ecgPoints = [];
        const ecgMaxPoints = 100;
        let ecgPhase = 0;

        const updateECGGraph = () => {
            // Generate a simple ECG wave pattern
            ecgPhase += 0.15;
            
            // Basic baseline noise
            let y = 15 + (Math.random() - 0.5) * 2; 

            // Periodic heartbeat spikes
            const beat = ecgPhase % (Math.PI * 2);
            if (beat > 0 && beat < 0.2) y -= 5; // P wave
            if (beat > 0.3 && beat < 0.4) y += 5; // Q
            if (beat > 0.4 && beat < 0.6) y -= 25; // R (spike)
            if (beat > 0.6 && beat < 0.7) y += 8; // S
            if (beat > 0.9 && beat < 1.2) y -= 4; // T wave

            // Clamp
            y = Math.max(2, Math.min(28, y));

            ecgPoints.push(y);
            if (ecgPoints.length > ecgMaxPoints) ecgPoints.shift();

            // Construct SVG path string
            const width = 200;
            const step = width / ecgMaxPoints;
            let d = `M 0 ${ecgPoints[0] || 15}`;
            for (let i = 1; i < ecgPoints.length; i++) {
                d += ` L ${i * step} ${ecgPoints[i]}`;
            }
            document.getElementById('live-ecg-path').setAttribute('d', d);
        };

        const startLiveSimulation = (organ) => {
            liveIntervals.forEach(clearInterval);
            liveIntervals = [];
            const data = ORGAN_DATA[organ];

            // Slow update for cards
            const mainInt = setInterval(() => {
                let hasAlert = false;
                data.stats.forEach((s, i) => {
                    if (typeof s.base === 'string') return; // Skip text based stats

                    let val = parseFloat(s.base);
                    let flux = (Math.random() - 0.5) * (val * 0.15); 
                    if(Math.random() > 0.85) flux *= 2.5; 

                    let newVal = Math.floor(val + flux);
                    if(s.unit === 'M' || s.unit === 'L' || s.unit.includes('g')) newVal = (val + flux/10).toFixed(1);

                    const state = getColorClass(newVal, s.type);
                    if(state === 'state-red') hasAlert = true;

                    updateCardValue(i+1, newVal, s.unit, s.type);
                });
                
                // Added: Randomize Bar Chart for visual liveliness
                const bars = document.querySelectorAll('#blood-chart .bar');
                bars.forEach(bar => {
                     // Keep them moving slightly
                     const h = 30 + Math.random() * 60;
                     bar.style.height = `${h}%`;
                });

                const aiPanel = document.getElementById('ai-panel');
                if(hasAlert) {
                    aiPanel.className = 'ai-panel warn';
                    document.getElementById('ai-title').innerText = "ATTENTION REQUIRED";
                    document.getElementById('ai-text').innerText = data.abnormal.msg + " " + data.abnormal.action;
                } else {
                    aiPanel.className = 'ai-panel';
                    document.getElementById('ai-title').innerText = "AI ANALYSIS";
                    document.getElementById('ai-text').innerText = "Vital signs are stable. No immediate irregularities detected.";
                }

            }, 2000);
            liveIntervals.push(mainInt);

            // Fast update for ECG (approx 30fps)
            const ecgInt = setInterval(updateECGGraph, 33);
            liveIntervals.push(ecgInt);
        };

        // --- THREE.JS ENGINE ---
        let scene, camera, renderer, group, particles;
        let controls; // OrbitControls
        let spotLight;
        let brainEffectGroup = null;
        let liverLight = null;

        const clearOrganEffects = () => {
            if (brainEffectGroup) {
                scene.remove(brainEffectGroup);
                brainEffectGroup.children.forEach((child) => {
                    child.geometry?.dispose?.();
                    child.material?.dispose?.();
                });
                brainEffectGroup = null;
            }
            if (liverLight) {
                scene.remove(liverLight);
                liverLight = null;
            }
        };

        const applyOrganEffects = (type) => {
            clearOrganEffects();
            if (!scene) return;

            if (type === 'brain') {
                brainEffectGroup = new THREE.Group();
                for (let i = 0; i < 20; i++) {
                    const start = new THREE.Vector3((Math.random() - 0.5) * 3, (Math.random() - 0.5) * 3, (Math.random() - 0.5) * 3);
                    const end = start.clone().add(new THREE.Vector3((Math.random() - 0.5) * 2, (Math.random() - 0.5) * 2, (Math.random() - 0.5) * 2));
                    const geo = new THREE.BufferGeometry().setFromPoints([start, end]);
                    const mat = new THREE.LineBasicMaterial({ color: 0x0ae0ff, transparent: true, opacity: 0.4 });
                    const line = new THREE.Line(geo, mat);
                    brainEffectGroup.add(line);
                }
                scene.add(brainEffectGroup);
            }

            if (type === 'liver') {
                liverLight = new THREE.PointLight(0xd97757, 2.0, 50);
                liverLight.position.set(2, 2, 5);
                scene.add(liverLight);
            }
        };

        const initThree = () => {
            const container = document.getElementById('model-3d-container');
            if(!container) return;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 14);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.3;
            
            container.appendChild(renderer.domElement);

            // CONTROLS
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = false; 
            controls.autoRotate = true;
            controls.autoRotateSpeed = 2.0;

            // Particles
            const particlesGeo = new THREE.BufferGeometry();
            const pCount = 300; 
            const pArray = new Float32Array(pCount * 3);
            for (let i = 0; i < pCount * 3; i++) pArray[i] = (Math.random() - 0.5) * 25;

            particlesGeo.setAttribute("position", new THREE.BufferAttribute(pArray, 3));
            const particlesMat = new THREE.PointsMaterial({
                size: 0.04,
                color: 0x3b82f6,
                transparent: true,
                opacity: 0.4,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(particlesGeo, particlesMat);
            scene.add(particles);

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.1); 
            scene.add(ambient);
            
            spotLight = new THREE.SpotLight(0xffffff, 3); 
            spotLight.position.set(10, 10, 10); 
            spotLight.angle = 0.5; 
            spotLight.penumbra = 1; 
            scene.add(spotLight);
            
            const rimLight = new THREE.PointLight(0x3b82f6, 4, 50); 
            rimLight.position.set(-10, 5, -5); 
            scene.add(rimLight);

            loadOrganModel('heart');
            
            // --- ANIMATION LOOP ---
            const clock = new THREE.Clock();
            const animate = () => {
                requestAnimationFrame(animate);
                const t = clock.getElapsedTime();
                const simVal = ORGAN_DATA[activeOrgan].simValue || 1;

                controls.update(); // Required for damping

                if (group) {
                    const type = group.userData.type;
                    const baseScale = group.userData.baseScale || 1;

                    if (type === 'heart') {
                        // Heart Animation (Scaling for heartbeat effect)
                        const speed = simVal / 60;
                        const beat = Math.sin(t * speed * Math.PI * 2);
                        const scale = baseScale * (beat > 0.8 ? 1 + (beat-0.8)*0.3 : 1);
                        group.scale.set(scale, scale, scale);
                        
                        // Pulse Light
                        spotLight.intensity = 2.5 + (scale - baseScale) * 10;
                    } else {
                        // Gentle Float
                        const pulse = baseScale * (1 + Math.sin(t * 2) * 0.01);
                        group.scale.set(pulse, pulse, pulse);
                    }
                }

                if (brainEffectGroup) {
                    brainEffectGroup.rotation.y -= 0.005;
                    brainEffectGroup.children.forEach((line, idx) => {
                        line.material.opacity = 0.1 + Math.abs(Math.sin(t * 3 + idx)) * 0.3;
                    });
                }

                if (liverLight) {
                    liverLight.intensity = 2.0 + Math.sin(t * 2) * 0.5;
                }

                if(particles) particles.rotation.y += 0.001;
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        };

        // --- PROCEDURAL HELPERS ---
        const getOrganColor = (type) => {
            const colors = {
                heart: 0xff3b3b,
                brain: 0x0ae0ff,
                liver: 0xd97757,
                lungs: 0xffa8d9,
                kidneys: 0xc27e5c,
                stomach: 0xff9e9e,
                intestines: 0xffc4a3,
                pancreas: 0xffd670,
                gallbladder: 0x60d394,
                urinary: 0xffea00,
                skeletal: 0xffffff,
                cells: 0xcd93ff,
                immune: 0x50c878,
                dental: 0xfdfdfd,
                breast: 0xffb7b2,
                ligaments: 0xeeeeee
            };
            return colors[type] || 0x3b82f6;
        };

        const getOrganGeometry = (type) => {
            switch(type) {
                case 'heart': return new THREE.IcosahedronGeometry(3.2, 1);
                case 'brain': return new THREE.DodecahedronGeometry(3.0, 1);
                case 'liver': return new THREE.OctahedronGeometry(3.0, 2);
                case 'lungs': return new THREE.SphereGeometry(3.0, 16, 16);
                case 'cells': return new THREE.IcosahedronGeometry(2.5, 2);
                default: return new THREE.OctahedronGeometry(2.8, 0);
            }
        };

        const loadOrganModel = (type) => {
            if (group) {
                // Cleanup old geometry/materials
                group.children.forEach(child => {
                    if(child.geometry) child.geometry.dispose();
                    if(child.material) child.material.dispose();
                });
                scene.remove(group);
            }
            
            group = new THREE.Group();
            group.userData.type = type;
            group.userData.baseScale = 1;
            scene.add(group);

            applyOrganEffects(type);

            // PROCEDURAL HOLOGRAPHIC GENERATION
            const color = getOrganColor(type);
            const geometry = getOrganGeometry(type);
            
            // 1. Holographic Shell (Wireframe)
            const wireMat = new THREE.MeshBasicMaterial({
                color: color,
                wireframe: true,
                transparent: true,
                opacity: 0.15,
                blending: THREE.AdditiveBlending
            });
            const wireMesh = new THREE.Mesh(geometry, wireMat);
            group.add(wireMesh);

            // 2. Inner Glow Core
            const coreMat = new THREE.MeshPhongMaterial({
                color: color,
                transparent: true,
                opacity: 0.8,
                shininess: 80,
                emissive: color,
                emissiveIntensity: 0.2,
                flatShading: true 
            });
            const coreMesh = new THREE.Mesh(geometry.clone(), coreMat);
            coreMesh.scale.setScalar(0.85); // Slightly smaller
            group.add(coreMesh);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const PAGES = [
                { label: 'Dashboard', href: '#', icon: 'ph-fill ph-heartbeat' },
                { label: 'Organs', href: '#', icon: 'ph ph-brain' },
                { label: 'Health', href: '#', icon: 'ph ph-activity' },
                { label: 'Labs', href: '#', icon: 'ph ph-flask' },
                { label: 'Hospitals', href: '#', icon: 'ph ph-hospital' },
                { label: 'Pharmacy', href: '#', icon: 'ph ph-pill' },
                { label: 'Devices', href: '#', icon: 'ph ph-device-mobile' },
                { label: 'Insurance', href: '#', icon: 'ph ph-shield-check' },
                { label: 'Family', href: '#', icon: 'ph ph-users-three' },
                { label: 'Profile', href: '#', icon: 'ph ph-user' },
                { label: 'Settings', href: '#', icon: 'ph ph-gear-six' },
                { label: 'Medical Log', href: '#', icon: 'ph ph-clipboard-text' }
            ];

            const pageNav = document.getElementById('page-nav');
            const mobileNavLinks = document.getElementById('mobile-nav-links');

            if(pageNav) {
                PAGES.forEach(p => {
                    const link = document.createElement('a');
                    link.href = p.href;
                    link.innerHTML = `<i class="${p.icon}"></i>${p.label}`;
                    pageNav.appendChild(link);
                });
            }

            if(mobileNavLinks) {
                PAGES.forEach(p => {
                    const link = document.createElement('a');
                    link.href = p.href;
                    link.innerText = p.label;
                    mobileNavLinks.appendChild(link);
                });
            }
            
            // Boot Screen Logic
            setTimeout(() => {
                document.getElementById('boot-screen').style.opacity = '0';
                document.getElementById('app-container').style.opacity = '1';
                setTimeout(() => {
                    document.getElementById('boot-screen').style.display = 'none';
                }, 800);
            }, 2000); // Reduced slightly for better UX

            generateOrganButtons();
            initThree();
            updateUI('heart');
            startWatchdog();

            const openModal = (id) => document.getElementById(id).style.display = 'flex';
            const closeModal = (id) => document.getElementById(id).style.display = 'none';

            document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.close)));

            // Theme toggle
            const themeBtn = document.getElementById('theme-toggle');
            themeBtn.addEventListener('click', () => {
                document.body.classList.toggle('theme-white');
                themeBtn.innerText = document.body.classList.contains('theme-white') ? 'Default Theme' : 'White Theme';
            });

            // Sound Toggle
            const soundBtn = document.getElementById('sound-toggle');
            soundBtn.addEventListener('click', () => {
                const isActive = AudioEngine.toggle();
                soundBtn.style.color = isActive ? '#0A84FF' : 'white';
                soundBtn.style.background = isActive ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)';
            });

            // Chat
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const typingEl = document.getElementById('ai-typing');
            const handleSend = () => {
                const text = chatInput.value.trim();
                if(!text) return;
                pushChatMessage('user', text);
                chatInput.value = '';
                const { detected, level } = analyzeKeywords(text);
                typingEl.style.display = 'block';
                setTimeout(() => {
                    typingEl.style.display = 'none';
                    const response = detected ? `I detected ${detected}. Assessing as ${level} risk.` : 'Noted. Continuing to monitor.';
                    pushChatMessage('bot', response);
                    updateDiagnosisPanel(detected || 'none', level);
                }, 1200);
            };
            chatSend.addEventListener('click', handleSend);
            chatInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleSend(); });

            // Telemedicine
            const openVideo = () => openModal('video-modal');
            document.getElementById('launch-video').addEventListener('click', openVideo);
            document.getElementById('open-video').addEventListener('click', openVideo);
            document.getElementById('toggle-cam').addEventListener('click', () => {
                const camState = document.getElementById('cam-state');
                camState.innerText = camState.innerText === 'ON' ? 'OFF' : 'ON';
            });
            document.getElementById('end-call').addEventListener('click', () => {
                showToast('Call ended');
                closeModal('video-modal');
            });

            // Pharmacy
            const openPharmacy = () => openModal('pharmacy-modal');
            document.getElementById('launch-pharmacy').addEventListener('click', openPharmacy);
            document.getElementById('open-pharmacy').addEventListener('click', openPharmacy);
            document.getElementById('submit-rx').addEventListener('click', () => {
                const rx = document.getElementById('rx-select').value;
                showToast(`${rx} refill request sent.`);
                closeModal('pharmacy-modal');
            });

            // Files + FaceID
            const runFaceID = (onPass) => {
                const overlay = document.getElementById('faceid-overlay');
                const text = document.getElementById('faceid-text');
                overlay.style.display = 'flex';
                text.innerText = 'Scanning Face ID...';
                setTimeout(() => {
                    text.innerText = 'Verified';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        onPass();
                    }, 500);
                }, 1400);
            };

            const openFiles = () => runFaceID(() => openModal('files-modal'));
            document.getElementById('launch-files').addEventListener('click', openFiles);
            document.getElementById('open-files').addEventListener('click', openFiles);
            document.querySelectorAll('[data-file]').forEach(btn => btn.addEventListener('click', () => {
                showToast(`${btn.dataset.file} downloading...`);
            }));

            // SOS button hold
            const sosBtn = document.getElementById('sos-btn');
            let sosTimer = null;
            sosBtn.addEventListener('mousedown', () => {
                sosTimer = setTimeout(() => triggerSOS('Hold-to-trigger SOS activated.'), 1500);
                sosBtn.classList.add('holding');
            });
            ['mouseup','mouseleave','touchend'].forEach(evt => sosBtn.addEventListener(evt, () => {
                clearTimeout(sosTimer);
                sosBtn.classList.remove('holding');
                sosBtn.innerText = 'Hold for SOS';
            }));

            // Logging every 10 minutes plus immediate seed
            setTimeout(appendMedicalLog, 2000);
            setInterval(() => { appendMedicalLog(); }, 600000);

            // Delegate events for dynamically created buttons
            const tray = document.querySelector('.organ-tray');
            tray.addEventListener('click', (e) => {
                const btn = e.target.closest('.organ-item');
                if(!btn) return;
                
                document.querySelectorAll('.organ-item').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.organ-label').forEach(el => el.remove());
                
                btn.classList.add('selected');
                
                const label = document.createElement('div'); label.className = 'organ-label'; 
                label.innerText = 'My ' + btn.dataset.organ.charAt(0).toUpperCase() + btn.dataset.organ.slice(1);
                btn.appendChild(label);
                
                const organ = btn.dataset.organ;
                loadOrganModel(organ);
                updateUI(organ);
            });
        });
    </script>
</body> 
</html>
