<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health flo OS - NEO (Bio-Sync Enabled)</title>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <style>
        :root {
            /* Theme Variables */
            --bg-radial: radial-gradient(circle at 20% 30%, #506176 0%, #1a1f2b 55%, #0E121B 100%);
            
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(24px);
            
            --text-white: #ffffff;
            --text-muted: #94a3b8;

            /* Status Colors */
            --color-blue: #0A84FF;
            --color-yellow: #f59e0b;
            --color-red: #ef4444;
            
            --accent-blue: #2563eb;
            --card-bg: rgba(22, 28, 38, 0.6);
            --card-border: rgba(255, 255, 255, 0.05);
            --card-active-bg: linear-gradient(135deg, rgba(30, 58, 138, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
        }

        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* CUSTOM SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        body {
            height: 100vh; width: 100vw;
            background: var(--bg-radial);
            overflow: hidden; user-select: none;
            color: white;
        }

        /* LAYOUT CONTAINER */
        .app-container {
            width: 100vw; height: 100vh;
            background: transparent;
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }

        /* BROWSER BAR */
        .browser-bar {
            height: 60px; display: flex; align-items: center; padding: 0 32px; gap: 24px;
            border-bottom: 1px solid var(--glass-border); 
            background: rgba(0,0,0,0.2); 
            backdrop-filter: blur(10px);
            z-index: 20;
            flex-shrink: 0;
        }
        .window-controls { display: flex; gap: 8px; margin-right: 12px; }
        .window-dot { width: 12px; height: 12px; border-radius: 50%; opacity: 0.8; }
        .branding-right { margin-left: auto; font-weight: 700; color: white; letter-spacing: 1px; font-size: 14px; opacity: 0.8; display: flex; align-items: center; gap: 10px; }
        .branding-right span { color: var(--color-blue); text-shadow: 0 0 10px rgba(10, 132, 255, 0.5); }

        /* Header Search / Quick Links */
        .search-suite { display: flex; align-items: center; gap: 12px; width: 100%; max-width: 520px; margin-left: auto; position: relative; }
        .search-bar { flex: 1; display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); position: relative; }
        .search-bar i { color: var(--text-muted); font-size: 18px; }
        .search-input { flex: 1; background: transparent; border: none; outline: none; color: white; font-size: 13px; }
        .search-input::placeholder { color: var(--text-muted); }
        .search-results { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: rgba(12,16,24,0.95); border: 1px solid var(--glass-border); border-radius: 14px; padding: 8px; box-shadow: 0 15px 40px rgba(0,0,0,0.35); display: none; flex-direction: column; gap: 6px; z-index: 50; max-height: 320px; overflow-y: auto; }
        .search-results.show { display: flex; }
        .search-result { width: 100%; text-align: left; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 12px; color: white; padding: 10px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; }
        .search-result small { color: var(--text-muted); font-weight: 600; font-size: 11px; margin-left: auto; }
        .search-result:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.06); }
        .model-link { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 12px; background: rgba(10, 132, 255, 0.12); color: white; font-weight: 700; text-decoration: none; border: 1px solid rgba(10,132,255,0.4); white-space: nowrap; }
        .model-link i { color: var(--color-blue); }

        /* DASHBOARD BODY */
        .dashboard-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* SIDEBAR */
        .sidebar {
            width: 90px; display: flex; flex-direction: column; align-items: center; padding: 40px 0; gap: 36px;
            border-right: 1px solid var(--glass-border); 
            z-index: 10; 
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: var(--glass-blur);
            flex-shrink: 0;
        }
        .logo { font-weight: 800; color: white; font-size: 24px; letter-spacing: -1px; margin-bottom: 12px; }
        .logo span { color: var(--color-blue); }
        .menu-item {
            width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center;
            color: var(--text-muted); font-size: 22px; cursor: pointer; transition: 0.3s; border: 1px solid transparent;
        }
        .menu-item:link, .menu-item:visited { text-decoration: none; color: var(--text-muted); }
        .menu-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .menu-item.active {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* MAIN GRID */
        .main-content {
            flex: 1; padding: 30px 40px;
            display: grid;
            grid-template-columns: 1.2fr 1fr 340px;
            grid-template-rows: auto 1fr; /* Optimized rows */
            gap: 30px; overflow-y: auto; position: relative;
        }

        .insights-panel {
            margin-top: 20px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 16px 18px;
            backdrop-filter: blur(16px);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .insight-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .insight-card {
            background: rgba(0,0,0,0.25);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .micro-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.3px;
            width: fit-content;
        }

        .insight-title { color: white; font-weight: 700; font-size: 14px; }
        .insight-sub { color: var(--text-muted); font-size: 12px; line-height: 1.4; }

        .progress-rail { width: 100%; height: 7px; border-radius: 10px; background: rgba(255,255,255,0.08); overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0A84FF, #22d3ee); border-radius: 10px; }

        .resource-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .resource-chip {
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 8px 12px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .resource-chip small { color: var(--text-muted); font-weight: 500; }

        /* HEADER */
        .header-section {
            grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 10px; z-index: 5;
        }
        .header-left { display: flex; flex-direction: column; gap: 15px; }
        .top-toggles { display: flex; gap: 10px; }
        .toggle-pill {
            padding: 8px 24px; border-radius: 100px; font-size: 13px; font-weight: 500;
            color: var(--text-muted); background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border);
            cursor: pointer; transition: 0.3s; backdrop-filter: blur(10px);
        }
        .toggle-pill.active {
            background: rgba(10, 132, 255, 0.2); color: white; border-color: rgba(10, 132, 255, 0.4);
            display: flex; align-items: center; gap: 8px;
        }
        .active-dot { width: 6px; height: 6px; background: var(--color-blue); border-radius: 50%; box-shadow: 0 0 10px var(--color-blue); }

        .page-title h2 { font-size: 18px; color: var(--color-blue); margin-bottom: 5px; font-weight: 600; letter-spacing: 0.5px; }
        .page-title h1 { font-size: 56px; font-weight: 700; color: white; line-height: 1; letter-spacing: -2px; }
        .page-title h1 span { font-weight: 300; opacity: 0.8; }

        /* 3D STAGE */
        .heart-stage {
            grid-column: 1; grid-row: 2 / -1; /* Full height */
            position: relative;
            display: flex; justify-content: center; align-items: center;
            min-height: 520px;
            overflow: visible;
        }
        #model-3d-container {
            width: 100%; height: 100%; position: relative; z-index: 1;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; animation: fadeIn 1.5s ease-out forwards; cursor: grab;
        }
        #model-3d-container:active { cursor: grabbing; }

        /* Animated Rings Background */
        .rings {
            position: absolute; width: 550px; height: 550px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.03); 
            background: radial-gradient(circle, rgba(10, 132, 255, 0.03) 0%, transparent 60%);
            z-index: 0; animation: spin 40s linear infinite;
        }
        .rings::before {
            content: ''; position: absolute; top: 50px; left: 50px; right: 50px; bottom: 50px;
            border-radius: 50%; border: 1px dashed rgba(255,255,255,0.05);
            animation: spinReverse 30s linear infinite;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spinReverse { 100% { transform: rotate(-360deg); } }
        @keyframes fadeIn { to { opacity: 1; } }

        .scanner-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-blue), transparent);
            box-shadow: 0 0 20px var(--color-blue);
            animation: scan-down 4s ease-in-out infinite; z-index: 2; opacity: 0.5;
        }
        @keyframes scan-down { 0% { top: 10%; opacity: 0; } 50% { opacity: 0.8; } 100% { top: 90%; opacity: 0; } }

        .floating-stat {
            position: absolute; bottom: 40px; left: 20px;
            background: rgba(20, 25, 35, 0.6); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 20px;
            padding: 16px 20px; width: 220px; z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .live-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: rgba(239, 68, 68, 0.15); color: #ef4444; border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px; }
        .live-dot { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* STATS GRID */
        .stats-area { grid-column: 2; grid-row: 2 / -1; display: flex; flex-direction: column; z-index: 5; } /* Full height */
        .section-header { font-size: 13px; font-weight: 700; color: var(--color-blue); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .blue-dot { width: 6px; height: 6px; background: var(--color-blue); border-radius: 50%; box-shadow: 0 0 8px var(--color-blue); }

        .cards-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; flex: 1; }
        
        .data-card {
            background: var(--card-bg); 
            backdrop-filter: blur(18px);
            border-radius: 24px; padding: 24px;
            display: flex; flex-direction: column; justify-content: space-between;
            border: 1px solid var(--card-border); position: relative; overflow: hidden; transition: 0.3s;
        }
        
        .data-card:hover { border-color: rgba(255,255,255,0.15); background: rgba(30, 35, 45, 0.8); transform: translateY(-2px); }

        /* SCANNING STATE CSS */
        .scanning-text {
            color: var(--color-blue);
            font-size: 14px; font-weight: 600; letter-spacing: 1px;
            animation: pulseText 1s infinite;
        }
        @keyframes pulseText { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        /* DYNAMIC CARD COLORS */
        .data-card.state-blue .card-icon { color: var(--color-blue); }
        .data-card.active-blue {
            background: var(--card-active-bg); 
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 20px 50px -20px rgba(30, 58, 138, 0.4);
        }
        .data-card.state-yellow {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        .data-card.state-yellow .card-icon { color: var(--color-yellow); }
        
        .data-card.state-red {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.4);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.1);
        }
        .data-card.state-red .card-icon { color: var(--color-red); }

        .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; z-index: 2; }
        .card-icon { font-size: 20px; transition: color 0.3s; }
        .card-title { font-size: 13px; color: var(--text-muted); display: block; margin-bottom: 6px; font-weight: 500; }
        .card-val { font-size: 26px; font-weight: 700; color: white; letter-spacing: -0.5px; transition: 0.3s; }
        
        .bar-chart { display: flex; align-items: flex-end; gap: 6px; height: 45px; margin-top: auto; z-index: 2; }
        .bar { flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; transition: height 0.5s ease-in-out, background 0.3s; }
        .bar.act { background: currentColor; }
        
        .blue-square-val {
            position: absolute; right: 24px; bottom: 24px; width: 50px; height: 50px;
            background: var(--accent-blue); border-radius: 16px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4); z-index: 2;
        }

        /* RIGHT COLUMN (Organ Icons + Schedule) */
        .right-column {
            grid-column: 3; grid-row: 2 / -1;
            display: flex; flex-direction: column; gap: 20px;
            overflow-y: auto; padding-right: 5px;
        }

        /* ORGAN TRAY (Updated Layout - Wrapped Flex) */
        .organ-tray {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping to form rows */
            gap: 12px;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .organ-item {
            width: 60px; height: 60px; /* Compact size */
            background: rgba(255,255,255,0.01); 
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(15px);
            border-radius: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            flex-shrink: 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }
        .organ-item:hover { 
            background: rgba(255,255,255,0.05); 
            transform: translateY(-3px); 
            border-color: rgba(255,255,255,0.2);
        }
        .organ-item i, .organ-item svg { font-size: 24px; color: var(--text-muted); transition: 0.3s; margin-bottom: 0; fill: none; stroke: currentColor; stroke-width: 1.5; }
        
        .organ-item.selected {
            background: linear-gradient(145deg, rgba(10, 132, 255, 0.15), rgba(0,0,0,0));
            border: 1px solid var(--color-blue);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.3), inset 0 0 20px rgba(10, 132, 255, 0.1);
        }
        .organ-item.selected i, .organ-item.selected svg {
            color: white; stroke: white; filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.8)); transform: scale(1.1);
        }
        
        .organ-name-mini { display: none; } /* Hide text for compact grid */

        .organ-label {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: #ffffff; color: #000; font-size: 10px; font-weight: 800;
            padding: 2px 8px; border-radius: 100px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; white-space: nowrap; z-index: 20;
        }

        
@@ -68,67 +68,133 @@
            flex-shrink: 0;
            flex-shrink: 0;
        }
        }
        .window-controls { display: flex; gap: 8px; margin-right: 12px; }
        .window-controls { display: flex; gap: 8px; margin-right: 12px; }
        .window-dot { width: 12px; height: 12px; border-radius: 50%; opacity: 0.8; }
        .window-dot { width: 12px; height: 12px; border-radius: 50%; opacity: 0.8; }
        .branding-right { margin-left: auto; font-weight: 700; color: white; letter-spacing: 1px; font-size: 14px; opacity: 0.8; display: flex; align-items: center; gap: 10px; }
        .branding-right { margin-left: auto; font-weight: 700; color: white; letter-spacing: 1px; font-size: 14px; opacity: 0.8; display: flex; align-items: center; gap: 10px; }
        .branding-right span { color: var(--color-blue); text-shadow: 0 0 10px rgba(10, 132, 255, 0.5); }
        .branding-right span { color: var(--color-blue); text-shadow: 0 0 10px rgba(10, 132, 255, 0.5); }


        /* DASHBOARD BODY */
        /* DASHBOARD BODY */
        .dashboard-body { flex: 1; display: flex; overflow: hidden; position: relative; }
        .dashboard-body { flex: 1; display: flex; overflow: hidden; position: relative; }


        /* SIDEBAR */
        /* SIDEBAR */
        .sidebar {
        .sidebar {
            width: 90px; display: flex; flex-direction: column; align-items: center; padding: 40px 0; gap: 36px;
            width: 90px; display: flex; flex-direction: column; align-items: center; padding: 40px 0; gap: 36px;
            border-right: 1px solid var(--glass-border); 
            border-right: 1px solid var(--glass-border); 
            z-index: 10; 
            z-index: 10; 
            background: rgba(255, 255, 255, 0.02);
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: var(--glass-blur);
            backdrop-filter: var(--glass-blur);
            flex-shrink: 0;
            flex-shrink: 0;
        }
        }
        .logo { font-weight: 800; color: white; font-size: 24px; letter-spacing: -1px; margin-bottom: 12px; }
        .logo { font-weight: 800; color: white; font-size: 24px; letter-spacing: -1px; margin-bottom: 12px; }
        .logo span { color: var(--color-blue); }
        .logo span { color: var(--color-blue); }
        .menu-item {
        .menu-item {
            width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center;
            width: 50px; height: 50px; border-radius: 16px; display: flex; justify-content: center; align-items: center;
            color: var(--text-muted); font-size: 22px; cursor: pointer; transition: 0.3s; border: 1px solid transparent;
            color: var(--text-muted); font-size: 22px; cursor: pointer; transition: 0.3s; border: 1px solid transparent;
        }
        }
        .menu-item:link, .menu-item:visited { text-decoration: none; color: var(--text-muted); }
        .menu-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .menu-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .menu-item.active { 
        .menu-item.active {
            background: rgba(255, 255, 255, 0.08); 
            background: rgba(255, 255, 255, 0.08);
            color: white; 
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        }


        /* MAIN GRID */
        /* MAIN GRID */
        .main-content {
        .main-content {
            flex: 1; padding: 30px 40px;
            flex: 1; padding: 30px 40px;
            display: grid;
            display: grid;
            grid-template-columns: 1.2fr 1fr 340px; 
            grid-template-columns: 1.2fr 1fr 340px;
            grid-template-rows: auto 1fr; /* Optimized rows */
            grid-template-rows: auto 1fr; /* Optimized rows */
            gap: 30px; overflow-y: auto; position: relative;
            gap: 30px; overflow-y: auto; position: relative;
        }
        }


        .insights-panel {
            margin-top: 20px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 16px 18px;
            backdrop-filter: blur(16px);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .insight-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .insight-card {
            background: rgba(0,0,0,0.25);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .micro-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.3px;
            width: fit-content;
        }

        .insight-title { color: white; font-weight: 700; font-size: 14px; }
        .insight-sub { color: var(--text-muted); font-size: 12px; line-height: 1.4; }

        .progress-rail { width: 100%; height: 7px; border-radius: 10px; background: rgba(255,255,255,0.08); overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #0A84FF, #22d3ee); border-radius: 10px; }

        .resource-links { display: flex; gap: 10px; flex-wrap: wrap; }
        .resource-chip {
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 8px 12px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .resource-chip small { color: var(--text-muted); font-weight: 500; }

        /* HEADER */
        /* HEADER */
        .header-section {
        .header-section {
            grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: flex-end;
            grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 10px; z-index: 5;
            margin-bottom: 10px; z-index: 5;
        }
        }
        .header-left { display: flex; flex-direction: column; gap: 15px; }
        .header-left { display: flex; flex-direction: column; gap: 15px; }
        .top-toggles { display: flex; gap: 10px; }
        .top-toggles { display: flex; gap: 10px; }
        .toggle-pill {
        .toggle-pill {
            padding: 8px 24px; border-radius: 100px; font-size: 13px; font-weight: 500;
            padding: 8px 24px; border-radius: 100px; font-size: 13px; font-weight: 500;
            color: var(--text-muted); background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border);
            color: var(--text-muted); background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border);
            cursor: pointer; transition: 0.3s; backdrop-filter: blur(10px);
            cursor: pointer; transition: 0.3s; backdrop-filter: blur(10px);
        }
        }
        .toggle-pill.active {
        .toggle-pill.active {
            background: rgba(10, 132, 255, 0.2); color: white; border-color: rgba(10, 132, 255, 0.4);
            background: rgba(10, 132, 255, 0.2); color: white; border-color: rgba(10, 132, 255, 0.4);
            display: flex; align-items: center; gap: 8px;
            display: flex; align-items: center; gap: 8px;
        }
        }
        .active-dot { width: 6px; height: 6px; background: var(--color-blue); border-radius: 50%; box-shadow: 0 0 10px var(--color-blue); }
        .active-dot { width: 6px; height: 6px; background: var(--color-blue); border-radius: 50%; box-shadow: 0 0 10px var(--color-blue); }


        .page-title h2 { font-size: 18px; color: var(--color-blue); margin-bottom: 5px; font-weight: 600; letter-spacing: 0.5px; }
        .page-title h2 { font-size: 18px; color: var(--color-blue); margin-bottom: 5px; font-weight: 600; letter-spacing: 0.5px; }
        .page-title h1 { font-size: 56px; font-weight: 700; color: white; line-height: 1; letter-spacing: -2px; }
        .page-title h1 { font-size: 56px; font-weight: 700; color: white; line-height: 1; letter-spacing: -2px; }
        .page-title h1 span { font-weight: 300; opacity: 0.8; }
        .page-title h1 span { font-weight: 300; opacity: 0.8; }


        /* 3D STAGE */
        /* 3D STAGE */
        .heart-stage {
        .heart-stage {
            grid-column: 1; grid-row: 2 / -1; /* Full height */
            grid-column: 1; grid-row: 2 / -1; /* Full height */
@@ -271,55 +337,99 @@
        }
        }
        .organ-item i, .organ-item svg { font-size: 24px; color: var(--text-muted); transition: 0.3s; margin-bottom: 0; fill: none; stroke: currentColor; stroke-width: 1.5; }
        .organ-item i, .organ-item svg { font-size: 24px; color: var(--text-muted); transition: 0.3s; margin-bottom: 0; fill: none; stroke: currentColor; stroke-width: 1.5; }
        
        
        .organ-item.selected {
        .organ-item.selected {
            background: linear-gradient(145deg, rgba(10, 132, 255, 0.15), rgba(0,0,0,0));
            background: linear-gradient(145deg, rgba(10, 132, 255, 0.15), rgba(0,0,0,0));
            border: 1px solid var(--color-blue);
            border: 1px solid var(--color-blue);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.3), inset 0 0 20px rgba(10, 132, 255, 0.1);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.3), inset 0 0 20px rgba(10, 132, 255, 0.1);
        }
        }
        .organ-item.selected i, .organ-item.selected svg {
        .organ-item.selected i, .organ-item.selected svg {
            color: white; stroke: white; filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.8)); transform: scale(1.1);
            color: white; stroke: white; filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.8)); transform: scale(1.1);
        }
        }
        
        
        .organ-name-mini { display: none; } /* Hide text for compact grid */
        .organ-name-mini { display: none; } /* Hide text for compact grid */


        .organ-label {
        .organ-label {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            background: #ffffff; color: #000; font-size: 10px; font-weight: 800;
            background: #ffffff; color: #000; font-size: 10px; font-weight: 800;
            padding: 2px 8px; border-radius: 100px;
            padding: 2px 8px; border-radius: 100px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; white-space: nowrap; z-index: 20;
            pointer-events: none; white-space: nowrap; z-index: 20;
        }
        }


        /* SCHEDULE AREA */
        /* SCHEDULE AREA */
        .schedule-area {
        .schedule-area {
            flex: 1; /* Fill remaining height */
            flex: 1; /* Fill remaining height */
            background: rgba(255, 255, 255, 0.03); 
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(24px);
            backdrop-filter: blur(24px);
            border-radius: 28px; padding: 24px;
            border-radius: 28px; padding: 24px;
            border: 1px solid var(--glass-border); display: flex; flex-direction: column; z-index: 5;
            border: 1px solid var(--glass-border); display: flex; flex-direction: column; z-index: 5;
        }
        }

        .link-suite {
            margin-top: 16px;
            padding: 14px;
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .link-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .link-tile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.05);
            background: rgba(255,255,255,0.03);
            color: white;
            text-decoration: none;
            font-weight: 700;
            font-size: 12px;
            transition: 0.2s;
        }

        .link-tile:hover {
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }

        .link-tile small {
            display: block;
            color: var(--text-muted);
            font-weight: 500;
            line-height: 1.3;
        }
        .ai-panel {
            margin-top: 20px; padding: 16px; background: rgba(10, 132, 255, 0.08); 
            border-radius: 16px; border: 1px solid rgba(10, 132, 255, 0.2); transition: 0.3s;
        }
        .ai-panel.warn { background: rgba(239, 68, 68, 0.1); border-color: var(--color-red); }
        .ai-title { font-size: 11px; font-weight: 800; color: var(--color-blue); margin-bottom: 6px; display: block; letter-spacing: 1px; }
        .ai-text { font-size: 12px; line-height: 1.5; color: #cbd5e1; }

        .next-checkup {
            background: rgba(255,255,255,0.03); border-radius: 16px; padding: 16px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; color: white; border: 1px solid rgba(255,255,255,0.03);
        }
        .date-nav {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;
            background: rgba(0,0,0,0.2); padding: 6px; border-radius: 100px; border: 1px solid rgba(255,255,255,0.03);
        }
        .nav-arrow { 
            width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.05); 
            display: flex; justify-content: center; align-items: center; font-size: 14px; color: #9ca3af; cursor: pointer; transition: 0.2s;
        }
        .doc-list { display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
        .doc-row { 
            display: flex; align-items: center; gap: 14px; padding: 12px; border-radius: 16px; 
            transition: 0.2s; cursor: pointer; border: 1px solid transparent;
        }
        .doc-row:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.04); }
        .doc-img { width: 40px; height: 40px; border-radius: 12px; object-fit: cover; }
        .consult-btn {
            margin-top: 24px; background: linear-gradient(135deg, #0A84FF, #006CFF); color: white; border: none; padding: 14px;
            border-radius: 100px; font-weight: 700; font-size: 13px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px -5px rgba(10, 132, 255, 0.4); transition: 0.3s;
        }

        /* Sound Button */
        .sound-btn {
            position: absolute; top: 20px; left: 20px;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 100; color: white; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .sound-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.05); }
        
        .sound-btn.active {
            color: var(--color-blue);
            background: rgba(10, 132, 255, 0.15);
            border-color: var(--color-blue);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.3);
        }
        .sound-btn.active i {
            animation: pulseIcon 1.5s infinite;
        }
        @keyframes pulseIcon { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* --- RESPONSIVE OPTIMIZATION --- */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 400px auto auto auto;
                padding: 20px;
                overflow-y: scroll;
            }
            .heart-stage { grid-row: 2; height: 100%; width: 100%; }
            .stats-area { grid-row: 3; grid-column: 1; }
            .right-column { grid-row: 4; grid-column: 1; overflow: visible; }
            .sidebar { display: none; }
            .logo { display: none; }
        }

        @media (max-width: 768px) {
            .browser-bar { padding: 0 16px; justify-content: space-between; }
            .search-suite { max-width: 100%; }
            .model-link { display: none; }
            .nav-icons { display: none; }
            .main-content { padding: 16px; gap: 20px; display: flex; flex-direction: column; }
            .page-title h1 { font-size: 36px; }
            .heart-stage { height: 320px; flex-shrink: 0; }
            .cards-grid { grid-template-columns: 1fr; }
            .organ-tray { justify-content: center; } /* Stack on mobile */
            .organ-item { width: 50px; height: 50px; }
            .organ-item i, .organ-item svg { font-size: 20px; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="browser-bar">
            <div class="window-controls">
                <div class="window-dot" style="background: #ef4444;"></div>
                <div class="window-dot" style="background: #f59e0b;"></div>
                <div class="window-dot" style="background: #10b981;"></div>
            </div>
            <div class="nav-icons"><i class="ph ph-caret-left"></i><i class="ph ph-caret-right"></i></div>
            <div class="search-suite">
                <div class="search-bar">
                    <i class="ph-bold ph-magnifying-glass"></i>
                    <input class="search-input" id="page-search" type="text" placeholder="Search pages or 3D models..." autocomplete="off" />
                    <div class="search-results" id="search-results"></div>
                </div>
                <a class="model-link" href="patient-organs.html" title="Open 3D models">
                    <i class="ph ph-cube-focus"></i>
                    <span>3D models</span>
                </a>
            </div>
            <div class="branding-right">Health flo <span>OS NEO</span></div>
        </div>
        
        <div class="dashboard-body">
            <div class="sidebar">
                <div class="logo">H<span>+</span></div>
                <a class="menu-item active" href="patient-dashboard.html" aria-label="Dashboard"><i class="ph-fill ph-heartbeat"></i></a>
                <a class="menu-item" href="patient-health.html" aria-label="Health Plan"><i class="ph ph-chat-circle-dots"></i></a>
                <a class="menu-item" href="patient-labs.html" aria-label="Labs"><i class="ph ph-file-text"></i></a>
                <a class="menu-item" href="patient-profile.html" aria-label="Profile"><i class="ph ph-user"></i></a>
                <a class="menu-item" href="patient-organs.html" aria-label="Organs"><i class="ph ph-squares-four"></i></a>
                <a class="menu-item" href="patient-settings.html" aria-label="Settings" style="margin-top: auto; color: #ef4444;"><i class="ph ph-power"></i></a>
            </div>

            <div class="main-content">
                
                <div class="header-section">
                    <div class="header-left">
                        <div class="top-toggles">
                            <div class="toggle-pill">Diagnose</div>
                            <div class="toggle-pill active" id="mode-pill"><div class="active-dot"></div> My Heart</div>
                        </div>
                        <div class="page-title">
                            <h2>Hi Dhivakaran,</h2>
                            <h1>Overview <span>Conditions</span></h1>
                        </div>
                    </div>
                </div>

                <div class="heart-stage">
                    <div class="sound-btn" id="sound-toggle"><i class="ph-fill ph-speaker-simple-high"></i></div>
                    <div class="rings"></div>
                    <div class="scanner-line"></div>
                    <div id="model-3d-container"></div>
                    
                    <div class="floating-stat" id="float-card">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <div class="live-badge"><div class="live-dot"></div> LIVE</div>
                        </div>
                        <div style="font-size:24px; font-weight:800; color:white; margin-bottom:4px;" id="main-stat">120 <span style="font-size:12px; font-weight:500;">bpm</span></div>
                        <svg width="100%" height="30" viewBox="0 0 100 30" id="live-ecg-svg">
                            <path id="live-ecg-path" d="M0,15 L10,15 L15,5 L20,25 L25,10 L30,20 L40,15 L50,15 L55,5 L60,25 L65,10 L70,20 L80,15 L100,15" fill="none" stroke="#0A84FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                </div>

                <div class="stats-area">
                    <div class="section-header"><div class="blue-dot"></div> <span id="section-title">My Heart Condition</span></div>
                    <div class="cards-grid">
                        <div class="data-card state-blue" id="card-1">
                            <div class="card-head">
                                <div><span class="card-title" id="c1-title">Blood Status</span><span class="card-val" id="c1-val">116/70</span></div>
                                <i class="ph-fill ph-drop card-icon" id="c1-icon"></i>
                            </div>
                            <div class="bar-chart" id="blood-chart">
                                <div class="bar" style="height:40%"></div><div class="bar" style="height:70%"></div><div class="bar" style="height:50%"></div><div class="bar act" style="height:90%"></div><div class="bar act" style="height:60%"></div><div class="bar" style="height:40%"></div>
                            </div>
                        </div>
                        <div class="data-card active-blue" id="card-2">
                            <div class="card-head">
                                <div><span class="card-title" id="c2-title">Heart Rate</span><span class="card-val" id="c2-val">120 <span style="font-size:14px; font-weight:500;">bpm</span></span></div>
                                <i class="ph ph-heartbeat card-icon" style="color:white;" id="c2-icon"></i>
                            </div>
                            <svg width="100%" height="50" style="margin-top:auto; opacity:0.8; overflow:visible;"><path id="card-wave-path" d="M0,25 Q10,25 15,10 T30,25 T45,40 T60,10 T75,25 T100,25" fill="none" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round"/></svg>
                            <div class="blue-square-val"><span style="font-size:16px; font-weight:800;" id="box-bpm">120</span></div>
                        </div>
                        <div class="data-card state-blue" id="card-3">
                            <div class="card-head">
                                <div><span class="card-title" id="c3-title">Blood Count</span><span class="card-val" id="c3-val">80-90</span></div>
                                <i class="ph-fill ph-chart-bar card-icon" id="c3-icon"></i>
                            </div>
                            <svg width="100%" height="40" style="margin-top:auto;"><path d="M0,20 Q25,5 50,20 T100,20" fill="none" stroke="#6b7280" stroke-width="2.5" stroke-linecap="round"/><circle cx="80" cy="20" r="4" fill="#3b82f6" /></svg>
                        </div>
                        <div class="data-card state-blue" id="card-4">
                            <div class="card-head">
                                <div><span class="card-title" id="c4-title">Glucose Level</span><span class="card-val" id="c4-val">230<small style="font-size:12px; color:#6b7280;">/ml</small></span></div>
                                <i class="ph-fill ph-dna card-icon" id="c4-icon"></i>
                            </div>
                            <svg width="100%" height="40" style="margin-top:auto;"><path d="M0,20 L10,25 L20,15 L30,25 L40,15 L50,25 L60,15 L100,20" fill="none" stroke="#6b7280" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/></svg>
                        </div>
                    </div>

                    <div class="insights-panel">
                        <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                            <div class="section-header" style="margin-bottom:0;"><div class="blue-dot"></div> Guided Health Tracks</div>
                            <div class="micro-pill"><i class="ph ph-compass"></i> Everyday language</div>
                        </div>
                        <div class="insight-grid">
                            <div class="insight-card">
                                <div class="micro-pill"><i class="ph ph-heart"></i> Cardio basics</div>
                                <div class="insight-title">Stay in the blue zone</div>
                                <div class="insight-sub">Walk 20 mins after meals and keep your resting rate near the calm range.</div>
                                <div class="progress-rail"><div class="progress-bar" style="width:72%"></div></div>
                            </div>
                            <div class="insight-card">
                                <div class="micro-pill"><i class="ph ph-bandaids"></i> Preventive check</div>
                                <div class="insight-title">Labs to watch</div>
                                <div class="insight-sub">Keep kidneys, liver, and heart markers aligned with your care plan.</div>
                                <div class="progress-rail"><div class="progress-bar" style="width:64%"></div></div>
                            </div>
                            <div class="insight-card">
                                <div class="micro-pill"><i class="ph ph-moon-stars"></i> Recovery</div>
                                <div class="insight-title">Sleep & recharge</div>
                                <div class="insight-sub">Aim for 7-8 hours, dim screens by 10pm, and hydrate before bed.</div>
                                <div class="progress-rail"><div class="progress-bar" style="width:58%"></div></div>
                            </div>
                            <div class="insight-card">
                                <div class="micro-pill"><i class="ph ph-apple-logo"></i> Nutrition</div>
                                <div class="insight-title">Everyday plate</div>
                                <div class="insight-sub">Fill half your plate with greens, lean protein, and steady water sips.</div>
                                <div class="progress-rail"><div class="progress-bar" style="width:69%"></div></div>
                            </div>
                        </div>
                        <div class="resource-links">
                            <a class="resource-chip" href="patient-health.html"><i class="ph ph-hand-heart"></i> See my plan <small>guided steps</small></a>
                            <a class="resource-chip" href="patient-labs.html"><i class="ph ph-flask"></i> Labs at a glance <small>plain words</small></a>
                            <a class="resource-chip" href="patient-insurance.html"><i class="ph ph-shield-check"></i> Coverage tips <small>what's included</small></a>
                            <a class="resource-chip" href="patient-pharmacy.html"><i class="ph ph-pill"></i> Med reminders <small>everyday language</small></a>
                        </div>
                    </div>
                </div>

                <div class="right-column">
                    <div class="section-header"><div class="blue-dot"></div> Select Organ</div>
                    <div class="organ-tray">
                        </div>

                    <div class="schedule-area">
                        <div class="section-header" style="margin-bottom:10px;"><div class="blue-dot"></div> AI Analysis</div>
                        
                        <div class="ai-panel" id="ai-panel">
                            <span class="ai-title" id="ai-title">AI ANALYSIS</span>
                            <p class="ai-text" id="ai-text">Patient vitals are stable. All organ functions within normal range. Monitoring active.</p>
                        </div>

                        <div class="next-checkup" style="margin-top: 20px;">
                            <div><div style="font-size:11px; color:#9ca3af; margin-bottom:4px; font-weight: 600;">NEXT CHECKUP</div><div style="font-weight:700; font-size: 15px;">Fri, 24 Mar</div></div>
                            <i class="ph-fill ph-calendar-check" style="font-size:24px; color: var(--color-blue);"></i>
                        </div>
                        <div class="date-nav">
                            <div class="nav-arrow"><i class="ph-bold ph-caret-left"></i></div><span style="font-size:13px; color:white; font-weight:600;">20 March 2023</span><div class="nav-arrow"><i class="ph-bold ph-caret-right"></i></div>
                        </div>
                        <div class="doc-list">
                            <div class="doc-row"><img src="https://randomuser.me/api/portraits/men/32.jpg" class="doc-img" alt=""><div><div style="font-size:13px; font-weight:700; color:white;">Dr. Hanzer Jon</div><div style="font-size:11px; color:#9ca3af;">Cardiologist</div></div></div>
                            <div class="doc-row"><img src="https://randomuser.me/api/portraits/women/45.jpg" class="doc-img" alt=""><div><div style="font-size:13px; font-weight:700; color:white;">Dr. Sarah Lee</div><div style="font-size:11px; color:#9ca3af;">Neurologist</div></div></div>
                        </div>

                        <div class="link-suite">
                            <div class="section-header" style="margin-bottom:0;"><div class="blue-dot"></div> Connected Pages</div>
                            <p style="color:var(--text-muted); font-size:12px; margin:0;">Deep-link this organ to other Health Flo OS experiences.</p>
                            <div class="link-grid">
                                <a class="link-tile" id="link-health" href="patient-health.html"><i class="ph ph-activity"></i><div><div>Health plan</div><small id="link-health-copy">Open care plan</small></div></a>
                                <a class="link-tile" id="link-organs" href="patient-organs.html"><i class="ph ph-hand-heart"></i><div><div>Organ watch</div><small id="link-organs-copy">3D studio jump</small></div></a>
                                <a class="link-tile" id="link-labs" href="patient-labs.html"><i class="ph ph-flask"></i><div><div>Labs</div><small id="link-labs-copy">Mirror organ markers</small></div></a>
                                <a class="link-tile" id="link-pharmacy" href="patient-pharmacy.html"><i class="ph ph-pill"></i><div><div>Pharmacy</div><small id="link-pharmacy-copy">Dose guard</small></div></a>
                            </div>
                        </div>
                        <button class="consult-btn">Consult Now <i class="ph-bold ph-arrow-right"></i></button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        // Load GLB assets directly from the local 3d_models directory for offline-friendly usage.
        const MODEL_BASE_PATH = './3d_models/';
        const ORGAN_MODEL_MAP = {
            heart: 'heart.glb',
            brain: 'brain.glb',
            lungs: 'lungs.glb',
            liver: 'liver.glb',
            cirrhotic_liver: 'cirrhotic_liver.glb',
            kidneys: 'kidneys.glb',
            eyes: 'eyes.glb'
        };

        // Quick navigation targets surfaced in the header search
        const PAGE_LINKS = [
            { label: 'Dashboard', url: 'patient-dashboard.html', detail: 'Live vitals overview', tags: ['home', 'overview', 'heart'] },
            { label: 'Health Plan', url: 'patient-health.html', detail: 'Care tasks & routines', tags: ['plan', 'tasks', 'care'] },
            { label: 'Labs', url: 'patient-labs.html', detail: 'Results & markers', tags: ['labs', 'reports'] },
            { label: 'Organs / 3D models', url: 'patient-organs.html', detail: 'Atlas + 3D viewer', tags: ['organs', '3d', 'models', 'atlas'] },
            { label: 'Pharmacy', url: 'patient-pharmacy.html', detail: 'Meds & refills', tags: ['meds', 'pharmacy', 'prescriptions'] },
            { label: 'Hospitals', url: 'patient-hospitals.html', detail: 'Care network', tags: ['hospitals', 'providers'] },
            { label: 'Devices', url: 'patient-devices.html', detail: 'Linked wearables', tags: ['devices', 'wearables'] },
            { label: 'Family', url: 'patient-family.html', detail: 'Care circle', tags: ['family', 'contacts'] },
            { label: 'Profile', url: 'patient-profile.html', detail: 'Patient identity', tags: ['profile', 'user'] },
            { label: 'Insurance', url: 'patient-insurance.html', detail: 'Coverage & claims', tags: ['insurance', 'claims'] },
            { label: 'Settings', url: 'patient-settings.html', detail: 'System preferences', tags: ['settings', 'theme'] },
            { label: '3D Model Shelf', url: 'patient-organs.html#models', detail: 'Jump to model gallery', tags: ['models', 'gallery', 'viewer'] }
        ];
        
        // --- CUSTOM SVG ICONS FOR ORGANS ---
        const ORGAN_SVGS = {
            liver: `<svg viewBox="0 0 24 24"><path d="M20.5 13.5c-.5-3.5-3.5-6.5-8.5-6.5s-8 3-8 6.5c0 3.5 3 6.5 6 6.5 1.5 0 3-.5 4.5-1.5 3.5-2.5 5.5-3.5 6-5z" /><path d="M8 8.5v3" /></svg>`,
            lungs: `<svg viewBox="0 0 24 24"><path d="M12 2v20M6 5c-2.2 0-4 2.2-4 5.5S4 19 6.5 19 11 17 11 12 8.2 5 6 5zM18 5c2.2 0 4 2.2 4 5.5S20 19 17.5 19 13 17 13 12 15.8 5 18 5z" /></svg>`,
            kidneys: `<svg viewBox="0 0 24 24"><path d="M7.5 6c-2.5 0-4.5 2-4.5 5.5s3 7.5 6 7.5c2 0 3-1.5 3-4-1 1-3 0-3-2s2-3.5 4.5-3.5c-1-2.5-3.5-3.5-6-3.5z" /><path d="M16.5 6c2.5 0 4.5 2 4.5 5.5s-3 7.5-6 7.5c-2 0-3-1.5-3-4 1 1 3 0 3-2s-2-3.5-4.5-3.5c1-2.5 3.5-3.5 6-3.5z" /></svg>`,
            stomach: `<svg viewBox="0 0 24 24"><path d="M7 5c2-2 7-2 9 0 2 2 2 6 0 9-1 1.5-3 5-3 5-2 1-5 1-7-1s-3-5-2-8c1-3 3-5 3-5z" /><path d="M10 8h4" /></svg>`,
            intestines: `<svg viewBox="0 0 24 24"><path d="M6 5c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v1c0 1.1-.9 2-2 2H8c-1.1 0-2 .9-2 2v1c0 1.1.9 2 2 2h8c1.1 0 2 .9 2 2v1c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2V5z" /></svg>`,
            pancreas: `<svg viewBox="0 0 24 24"><path d="M21 9c-1-2-4-2-6 0l-9 9c-2 2-2 4 0 4s2 2 4 0l11-11c.5-.5 1-1.5 0-2z" /><path d="M12 12l2 2" /></svg>`,
            gallbladder: `<svg viewBox="0 0 24 24"><path d="M12 3c-1.5 0-3 1.5-3 3v2c0 3.5 2 8 3 8s3-4.5 3-8V6c0-1.5-1.5-3-3-3z" /></svg>`,
            urinary: `<svg viewBox="0 0 24 24"><path d="M12 4v4M8 10c0 4 1.5 8 4 8s4-4 4-8H8zM12 18v3" /></svg>`
        };

        // --- COMPREHENSIVE ORGAN DATA ---
        const ORGAN_DATA = {
            heart: {
                title: "My Heart Condition",
                mainStat: "BPM",
                animKey: "bpm",
                simValue: 80,
                icon: "ph-heart",
                stats: [
                    { id: "c1", title: "Blood Pressure", base: 116, unit: "/70", icon: "ph-drop", type: "bp" },
                    { id: "c2", title: "Heart Rate", base: 80, unit: "bpm", icon: "ph-heartbeat", type: "bpm" },
                    { id: "c3", title: "O2 Saturation", base: 98, unit: "%", icon: "ph-activity", type: "norm" },
                    { id: "c4", title: "Cardiac Output", base: 5.2, unit: "L/min", icon: "ph-waves", type: "norm" }
                ],
                abnormal: { msg: "Arrhythmia Detected.", action: "Recommend immediate ECG." }
            },
            brain: {
                title: "Brain & Nervous System",
                mainStat: "Hz",
                animKey: "hz",
                simValue: 14,
                icon: "ph-brain",
                stats: [
                    { id: "c1", title: "Brain Waves", base: 14, unit: "Hz", icon: "ph-wave-sine", type: "hz" },
                    { id: "c2", title: "Cognitive Load", base: 45, unit: "%", icon: "ph-lightning", type: "perc" },
                    { id: "c3", title: "Oxygenation", base: 99, unit: "%", icon: "ph-wind", type: "perc" },
                    { id: "c4", title: "ICP", base: 11, unit: "mmHg", icon: "ph-gauge", type: "norm" }
                ],
                abnormal: { msg: "High Cortisol Levels.", action: "Stress reduction advised." }
            },
            liver: {
                title: "Liver Function",
                mainStat: "Tox",
                animKey: "tox",
                simValue: 5,
                icon: "svg-liver",
                stats: [
                    { id: "c1", title: "ALT Enzymes", base: 29, unit: "U/L", icon: "ph-flask", type: "norm" },
                    { id: "c2", title: "Toxicity Filter", base: 95, unit: "%", icon: "ph-shield-check", type: "perc" },
                    { id: "c3", title: "Bilirubin", base: 0.8, unit: "mg", icon: "ph-test-tube", type: "norm" },
                    { id: "c4", title: "Albumin", base: 4.2, unit: "g/dL", icon: "ph-egg", type: "norm" }
                ],
                abnormal: { msg: "Elevated Enzymes.", action: "Dietary review needed." }
            },
            lungs: {
                title: "Respiratory System",
                mainStat: "RPM",
                animKey: "rpm",
                simValue: 16,
                icon: "svg-lungs",
                stats: [
                    { id: "c1", title: "Resp Rate", base: 16, unit: "rpm", icon: "ph-wind", type: "rpm" },
                    { id: "c2", title: "SpO2 Level", base: 98, unit: "%", icon: "ph-drop", type: "perc" },
                    { id: "c3", title: "Lung Capacity", base: 4.8, unit: "L", icon: "ph-chart-bar", type: "norm" },
                    { id: "c4", title: "EtCO2", base: 38, unit: "mmHg", icon: "ph-cloud", type: "norm" }
                ],
                abnormal: { msg: "Reduced Capacity.", action: "Spirometry test advised." }
            },
            kidneys: {
                title: "Renal Function",
                mainStat: "GFR",
                animKey: "gfr",
                simValue: 90,
                icon: "svg-kidneys",
                stats: [
                    { id: "c1", title: "GFR", base: 95, unit: "mL", icon: "ph-activity", type: "norm" },
                    { id: "c2", title: "Creatinine", base: 0.9, unit: "mg", icon: "ph-flask", type: "norm" },
                    { id: "c3", title: "Urea (BUN)", base: 14, unit: "mg", icon: "ph-test-tube", type: "norm" },
                    { id: "c4", title: "Hydration", base: 92, unit: "%", icon: "ph-drop-half", type: "perc" }
                ],
                abnormal: { msg: "Low Filtration.", action: "Increase fluid intake." }
            },
           eyes: {
                title: "Vision & Eye Health",
                mainStat: "Focus",
                animKey: "vis",
                simValue: 20,
                icon: "ph-eye",
                stats: [
                    { id: "c1", title: "IOP", base: 16, unit: "mmHg", icon: "ph-eye", type: "norm" },
                    { id: "c2", title: "Visual Acuity", base: 20, unit: "/20", icon: "ph-browsers", type: "norm" },
                    { id: "c3", title: "Dryness", base: 12, unit: "%", icon: "ph-drop-half", type: "perc" },
                    { id: "c4", title: "Blue Light", base: 45, unit: "%", icon: "ph-device-mobile", type: "norm" }
                ],
                abnormal: { msg: "Dry eye detected.", action: "Add lubrication drops + breaks." }
            },
            stomach: {
                title: "Gastric Health",
                mainStat: "pH",
                animKey: "ph",
                simValue: 2,
                icon: "svg-stomach",
                stats: [
                    { id: "c1", title: "Acidity (pH)", base: 2.1, unit: "pH", icon: "ph-drop", type: "norm" },
                    { id: "c2", title: "Motility", base: 3, unit: "cpm", icon: "ph-waves", type: "norm" },
                    { id: "c3", title: "Digestion", base: 94, unit: "%", icon: "ph-percent", type: "perc" },
                    { id: "c4", title: "Microbiome", base: 90, unit: "Sc", icon: "ph-plant", type: "norm" }
                ],
                abnormal: { msg: "High Acidity.", action: "Antacid recommended." }
            },
            intestines: {
                title: "Intestinal Tract",
                mainStat: "Absorp",
                animKey: "mot",
                simValue: 95,
                icon: "svg-intestines", 
                stats: [
                    { id: "c1", title: "Peristalsis", base: 8, unit: "/min", icon: "ph-arrows-left-right", type: "norm" },
                    { id: "c2", title: "Absorption", base: 95, unit: "%", icon: "ph-arrow-fat-lines-in", type: "perc" },
                    { id: "c3", title: "Flora", base: 92, unit: "%", icon: "ph-plant", type: "norm" },
                    { id: "c4", title: "Fiber Intake", base: 25, unit: "g", icon: "ph-carrot", type: "norm" }
                ],
                abnormal: { msg: "Slow Transit.", action: "Increase fiber intake." }
            },
            eyes: {
                title: "Ocular Health",
                mainStat: "Vision",
                animKey: "vis",
                simValue: 20,
                icon: "ph-eye",
                stats: [
                    { id: "c1", title: "Acuity (R)", base: 20, unit: "/20", icon: "ph-eye", type: "norm" },
                    { id: "c2", title: "Acuity (L)", base: 20, unit: "/20", icon: "ph-eye", type: "norm" },
                    { id: "c3", title: "Pressure", base: 16, unit: "mmHg", icon: "ph-gauge", type: "norm" },
                    { id: "c4", title: "Response", base: 150, unit: "ms", icon: "ph-timer", type: "norm" }
                ],
                abnormal: { msg: "Elevated IOP.", action: "Glaucoma screening." }
            },
            pancreas: {
                title: "Pancreatic System",
                mainStat: "Insulin",
                animKey: "ins",
                simValue: 12,
                icon: "svg-pancreas",
                stats: [
                    { id: "c1", title: "Insulin", base: 12, unit: "uIU", icon: "ph-drop", type: "norm" },
                    { id: "c2", title: "Glucose", base: 92, unit: "mg", icon: "ph-cube", type: "norm" },
                    { id: "c3", title: "Lipase", base: 45, unit: "U/L", icon: "ph-flask", type: "norm" },
                    { id: "c4", title: "Amylase", base: 55, unit: "U/L", icon: "ph-test-tube", type: "norm" }
                ],
                abnormal: { msg: "Sugar Spike.", action: "Monitor carbohydrate intake." }
            },
            gallbladder: {
                title: "Gallbladder",
                mainStat: "Bile",
                animKey: "bile",
                simValue: 100,
                icon: "svg-gallbladder",
                stats: [
                    { id: "c1", title: "Bile Flow", base: 100, unit: "%", icon: "ph-waves", type: "norm" },
                    { id: "c2", title: "Calculi", base: 0, unit: "cnt", icon: "ph-prohibit", type: "norm" },
                    { id: "c3", title: "Wall Thick", base: 2, unit: "mm", icon: "ph-ruler", type: "norm" },
                    { id: "c4", title: "Ejection", base: 65, unit: "%", icon: "ph-arrow-fat-up", type: "norm" }
                ],
                abnormal: { msg: "Flow Reduced.", action: "Ultrasound advised." }
            },
            urinary: {
                title: "Urinary Tract",
                mainStat: "Output",
                animKey: "out",
                simValue: 1500,
                icon: "svg-urinary",
                stats: [
                    { id: "c1", title: "24h Output", base: 1.5, unit: "L", icon: "ph-drop", type: "norm" },
                    { id: "c2", title: "pH Level", base: 6.0, unit: "pH", icon: "ph-test-tube", type: "norm" },
                    { id: "c3", title: "Specific Grav", base: 1.01, unit: "sg", icon: "ph-flask", type: "norm" },
                    { id: "c4", title: "Leukocytes", base: 0, unit: "neg", icon: "ph-shield", type: "norm" }
                ],
                abnormal: { msg: "Trace Protein.", action: "Retest in 24 hours." }
            },
            skeletal: {
                title: "Skeletal System",
                mainStat: "Density",
                animKey: "den",
                simValue: 0,
                icon: "ph-bone",
                stats: [
                    { id: "c1", title: "Bone Density", base: 0.5, unit: "T", icon: "ph-chart-bar", type: "norm" },
                    { id: "c2", title: "Calcium", base: 9.4, unit: "mg", icon: "ph-drop", type: "norm" },
                    { id: "c3", title: "Vit D3", base: 45, unit: "ng", icon: "ph-sun", type: "norm" },
                    { id: "c4", title: "Marrow Act", base: 98, unit: "%", icon: "ph-activity", type: "perc" }
                ],
                abnormal: { msg: "Mild Osteopenia.", action: "Increase Calcium/D3." }
            },
            cells: {
                title: "Cellular Health",
                mainStat: "Count",
                animKey: "wbc",
                simValue: 6.5,
                icon: "ph-dna",
                stats: [
                    { id: "c1", title: "WBC Count", base: 6.5, unit: "k", icon: "ph-shield-check", type: "norm" },
                    { id: "c2", title: "RBC Count", base: 5.1, unit: "M", icon: "ph-drop", type: "norm" },
                    { id: "c3", title: "Platelets", base: 250, unit: "k", icon: "ph-bandaids", type: "norm" },
                    { id: "c4", title: "Regen Rate", base: 95, unit: "%", icon: "ph-arrows-clockwise", type: "perc" }
                ],
                abnormal: { msg: "Low Platelets.", action: "Hematology consult." }
            },
            immune: {
                title: "Immune System",
                mainStat: "Resp",
                animKey: "imm",
                simValue: 98,
                icon: "ph-shield-star",
                stats: [
                    { id: "c1", title: "Response", base: 98, unit: "%", icon: "ph-lightning", type: "perc" },
                    { id: "c2", title: "Neutrophils", base: 60, unit: "%", icon: "ph-chart-pie", type: "norm" },
                    { id: "c3", title: "Lymphocytes", base: 30, unit: "%", icon: "ph-users", type: "norm" },
                    { id: "c4", title: "Inflammation", base: 0.3, unit: "CRP", icon: "ph-fire", type: "norm" }
                ],
                abnormal: { msg: "Elevated CRP.", action: "Check for infection." }
            },
            dental: {
                title: "Dental Health",
                mainStat: "Plaque",
                animKey: "den",
                simValue: 5,
                icon: "ph-smiley",
                stats: [
                    { id: "c1", title: "Plaque Idx", base: 5, unit: "%", icon: "ph-sparkle", type: "norm" },
                    { id: "c2", title: "Gum Health", base: 98, unit: "%", icon: "ph-heart", type: "perc" },
                    { id: "c3", title: "Enamel", base: 95, unit: "%", icon: "ph-shield", type: "perc" },
                    { id: "c4", title: "pH Balance", base: 7.0, unit: "pH", icon: "ph-drop", type: "norm" }
                ],
                abnormal: { msg: "Gingivitis Risk.", action: "Hygiene review." }
            },
            cirrhotic_liver: {
                title: "Liver - Cirrhotic Model",
                mainStat: "Fibrosis",
                animKey: "fib",
                simValue: 3,
                icon: "svg-liver",
                stats: [
                    { id: "c1", title: "Fibrosis Score", base: 3, unit: "/6", icon: "ph-warning", type: "norm" },
                    { id: "c2", title: "Portal Pressure", base: 12, unit: "mmHg", icon: "ph-gauge", type: "norm" },
                    { id: "c3", title: "Albumin", base: 3.2, unit: "g/dL", icon: "ph-egg", type: "norm" },
                    { id: "c4", title: "Ascites Risk", base: 8, unit: "%", icon: "ph-activity", type: "perc" }
                ],
                abnormal: { msg: "Compensated cirrhosis.", action: "Schedule hepatology consult." }
            },
            cirrhotic_liver: {
                title: "Liver - Cirrhotic Model",
                mainStat: "Fibrosis",
                animKey: "fib",
                simValue: 3,
                icon: "svg-liver",
                stats: [
                    { id: "c1", title: "Fibrosis Score", base: 3, unit: "/6", icon: "ph-warning", type: "norm" },
                    { id: "c2", title: "Portal Pressure", base: 12, unit: "mmHg", icon: "ph-gauge", type: "norm" },
                    { id: "c3", title: "Albumin", base: 3.2, unit: "g/dL", icon: "ph-egg", type: "norm" },
                    { id: "c4", title: "Ascites Risk", base: 8, unit: "%", icon: "ph-activity", type: "perc" }
                ],
                abnormal: { msg: "Compensated cirrhosis.", action: "Schedule hepatology consult." }
            },
            breast: {
                title: "Breast Tissue",
                mainStat: "Dense",
                animKey: "br",
                simValue: 2,
                icon: "ph-gender-female",
                stats: [
                    { id: "c1", title: "Density", base: 2, unit: "Cat", icon: "ph-squares-four", type: "norm" },
                    { id: "c2", title: "Vascularity", base: "Norm", unit: "", icon: "ph-waves", type: "norm" },
                    { id: "c3", title: "Lymph Nodes", base: "Clrv", unit: "", icon: "ph-check-circle", type: "norm" },
                    { id: "c4", title: "Asymmetry", base: 0, unit: "%", icon: "ph-scales", type: "norm" }
                ],
                abnormal: { msg: "Dense Tissue.", action: "Annual mammogram." }
            },
            ligaments: {
                title: "Joints & Ligaments",
                mainStat: "Flex",
                animKey: "flx",
                simValue: 85,
                icon: "ph-person-simple-run",
                stats: [
                    { id: "c1", title: "Flexibility", base: 85, unit: "%", icon: "ph-arrows-out", type: "perc" },
                    { id: "c2", title: "Synovial Fld", base: 100, unit: "%", icon: "ph-drop", type: "norm" },
                    { id: "c3", title: "Inflammation", base: 2, unit: "%", icon: "ph-fire", type: "norm" },
                    { id: "c4", title: "Cartilage", base: 90, unit: "%", icon: "ph-circle-notch", type: "norm" }
                ],
                abnormal: { msg: "Stiffness.", action: "Mobility exercises." }
            }
        };

        const CONNECTED_LINKS = {
            health: { id: 'link-health', copy: 'link-health-copy', href: 'patient-health.html' },
            organs: { id: 'link-organs', copy: 'link-organs-copy', href: 'patient-organs.html' },
            labs: { id: 'link-labs', copy: 'link-labs-copy', href: 'patient-labs.html' },
            pharmacy: { id: 'link-pharmacy', copy: 'link-pharmacy-copy', href: 'patient-pharmacy.html' }
        };

        const CONNECTED_LINKS = {
            health: { id: 'link-health', copy: 'link-health-copy', href: 'patient-health.html' },
            organs: { id: 'link-organs', copy: 'link-organs-copy', href: 'patient-organs.html' },
            labs: { id: 'link-labs', copy: 'link-labs-copy', href: 'patient-labs.html' },
            pharmacy: { id: 'link-pharmacy', copy: 'link-pharmacy-copy', href: 'patient-pharmacy.html' }
        };

        const renderSearchResults = (query = '') => {
            const input = document.getElementById('page-search');
            const results = document.getElementById('search-results');
            if (!input || !results) return;

            const normalized = query.trim().toLowerCase();
            const matches = PAGE_LINKS.filter(link =>
                !normalized ||
                link.label.toLowerCase().includes(normalized) ||
                link.tags.some(tag => tag.includes(normalized))
            ).slice(0, 7);

            results.innerHTML = matches.map(link => `
                <button class="search-result" data-url="${link.url}" type="button">
                    <span>${link.label}</span>
                    <small>${link.detail}</small>
                </button>
            `).join('');

            if (matches.length && (normalized || document.activeElement === input)) results.classList.add('show');
            else results.classList.remove('show');
        };

        const initSearchBar = () => {
            const input = document.getElementById('page-search');
            const results = document.getElementById('search-results');
            if (!input || !results) return;

            renderSearchResults('');

            input.addEventListener('input', () => renderSearchResults(input.value));
            input.addEventListener('focus', () => renderSearchResults(input.value));
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const first = results.querySelector('.search-result');
                    if (first) window.location.href = first.dataset.url;
                }
            });

            results.addEventListener('mousedown', (e) => {
                const btn = e.target.closest('.search-result');
                if (btn) window.location.href = btn.dataset.url;
            });

            document.addEventListener('click', (e) => {
                if (!results.contains(e.target) && e.target !== input) {
                    results.classList.remove('show');
                }
            });
        };

        const getColorClass = (val, type) => {
            if (type === 'bpm') {
                if (val < 60 || val > 120) return 'state-red';
                if (val > 100) return 'state-yellow';
                return 'state-blue';
            }
            if (type === 'perc') {
                if (val < 80) return 'state-red';
                if (val < 90) return 'state-yellow';
                return 'state-blue';
            }
            const r = Math.random();
            if (r > 0.95) return 'state-red';
            if (r > 0.8) return 'state-yellow';
            return 'state-blue';
        };

        let activeOrgan = 'heart';
        let liveIntervals = [];

        // --- BIO-SYNC AUDIO ENGINE ---
        // Generates pleasant procedural heart sounds based on BPM
        const AudioEngine = {
            ctx: null,
            nextNoteTime: 0.0,
            timerID: null,
            bpm: 80,
            isPlaying: false,

            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },

            toggle: function() {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                this.isPlaying = !this.isPlaying;
                
                // Visual feedback for audio button
                const btn = document.getElementById('sound-toggle');
                if(this.isPlaying) btn.classList.add('active');
                else btn.classList.remove('active');
                
                if (this.isPlaying) {
                    this.nextNoteTime = this.ctx.currentTime + 0.1;
                    this.scheduler();
                } else {
                    window.clearTimeout(this.timerID);
                }
                return this.isPlaying;
            },

            setBPM: function(newBpm) {
                this.bpm = newBpm;
            },

            scheduleHeartbeat: function(time) {
                // "LUB" Sound (Low, Thud)
                const osc1 = this.ctx.createOscillator();
                const gain1 = this.ctx.createGain();
                const filter1 = this.ctx.createBiquadFilter();

                osc1.type = 'triangle';
                osc1.frequency.setValueAtTime(60, time);
                osc1.frequency.exponentialRampToValueAtTime(40, time + 0.1);

                filter1.type = 'lowpass';
                filter1.frequency.value = 180;

                // Envelope
                gain1.gain.setValueAtTime(0, time);
                gain1.gain.linearRampToValueAtTime(0.8, time + 0.02);
                gain1.gain.exponentialRampToValueAtTime(0.001, time + 0.15);

                osc1.connect(filter1);
                filter1.connect(gain1);
                gain1.connect(this.ctx.destination);

                osc1.start(time);
                osc1.stop(time + 0.2);

                // "DUB" Sound (Slightly higher, sharper)
                const t2 = time + 0.25; // Delay for Dub
                const osc2 = this.ctx.createOscillator();
                const gain2 = this.ctx.createGain();
                const filter2 = this.ctx.createBiquadFilter();

                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(80, t2);
                osc2.frequency.exponentialRampToValueAtTime(50, t2 + 0.1);

                filter2.type = 'lowpass';
                filter2.frequency.value = 250;

                gain2.gain.setValueAtTime(0, t2);
                gain2.gain.linearRampToValueAtTime(0.6, t2 + 0.02);
                gain2.gain.exponentialRampToValueAtTime(0.001, t2 + 0.15);

                osc2.connect(filter2);
                filter2.connect(gain2);
                gain2.connect(this.ctx.destination);

                osc2.start(t2);
                osc2.stop(t2 + 0.2);
            },

            scheduler: function() {
                while (this.nextNoteTime < this.ctx.currentTime + 0.1) {
                    if(activeOrgan === 'heart') {
                        this.scheduleHeartbeat(this.nextNoteTime);
                    }
                    // Add logic for other organ sounds if needed (breathing for lungs)
                    
                    const secondsPerBeat = 60.0 / this.bpm;
                    this.nextNoteTime += secondsPerBeat;
                }
                this.timerID = window.setTimeout(this.scheduler.bind(this), 25);
            }
        };

        // --- DASHBOARD LOGIC ---
        const generateOrganButtons = () => {
            const tray = document.querySelector('.organ-tray'); // Updated target
            tray.innerHTML = '';
            
            Object.keys(ORGAN_DATA).forEach(key => {
                const data = ORGAN_DATA[key];
                const btn = document.createElement('div');
                btn.className = `organ-item ${key === 'heart' ? 'selected' : ''}`;
                btn.dataset.organ = key;
                
                // Logic to use custom SVG if available, else fallback to Phosphor icon class
                let iconHtml = '';
                if (data.icon.startsWith('svg-')) {
                    const svgKey = data.icon.split('-')[1];
                    iconHtml = ORGAN_SVGS[svgKey] || '<i class="ph ph-warning"></i>'; // Fallback
                } else {
                    iconHtml = `<i class="ph ${data.icon}"></i>`;
                }

                btn.innerHTML = `
                    ${iconHtml}
                    <span class="organ-name-mini">${key.toUpperCase()}</span>
                    ${key === 'heart' ? '<div class="organ-label">My Heart</div>' : ''}
                `;
                tray.appendChild(btn);
            });
        };

        const formatOrganTitle = (key) => key.split('_').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');

        const updateLinkSuite = (organType) => {
            const label = formatOrganTitle(organType);

            Object.entries(CONNECTED_LINKS).forEach(([slot, cfg]) => {
                const anchor = document.getElementById(cfg.id);
                const copyEl = document.getElementById(cfg.copy);

                if(anchor) anchor.href = `${cfg.href}?organ=${organType}`;

                if(copyEl) {
                    const line = {
                        health: `Push ${label} plan`,
                        organs: `Inspect ${label} in 3D`,
                        labs: `Cross-check labs for ${label}`,
                        pharmacy: `Dose match for ${label}`
                    }[slot];
                    copyEl.textContent = line || copyEl.textContent;
                }
            });
        };

        const updateUI = (organType) => {
            activeOrgan = organType;
            const data = ORGAN_DATA[organType];

            // Audio Sync
            AudioEngine.setBPM(data.simValue);

            updateLinkSuite(organType);

            // Text Updates
            document.getElementById('section-title').innerHTML = `<div class="blue-dot"></div> ${data.title}`;
            document.getElementById('mode-pill').innerHTML = `<div class="active-dot"></div> My ${organType.charAt(0).toUpperCase() + organType.slice(1)}`;
            
            // AI Panel Reset
            const aiPanel = document.getElementById('ai-panel');
            aiPanel.className = 'ai-panel';
            document.getElementById('ai-title').innerText = "AI ANALYSIS";
            document.getElementById('ai-text').innerText = "Analyzing recent biometrics. Systems operating within normal parameters.";

            // Show Scanning State briefly
            data.stats.forEach((s, i) => {
                const idx = i + 1;
                document.getElementById(`c${idx}-title`).innerText = s.title;
                document.getElementById(`c${idx}-icon`).className = `ph-fill ${s.icon} card-icon`;
                
                // Reset to scanning
                document.getElementById(`c${idx}-val`).innerHTML = `<span class="scanning-text">Scanning...</span>`;
                const card = document.getElementById(`card-${idx}`);
                card.className = `data-card state-blue`; // Reset color
            });

            // Simulate Scan Delay then reveal
            setTimeout(() => {
                data.stats.forEach((s, i) => {
                    const idx = i + 1;
                    updateCardValue(idx, s.base, s.unit, s.type);
                });
                startLiveSimulation(organType);
            }, 800);
        };

        const updateCardValue = (idx, val, unit, type) => {
            const card = document.getElementById(`card-${idx}`);
            const state = getColorClass(val, type);
            
            if(idx !== 2) {
                card.className = `data-card ${state}`;
            } else {
                if(state === 'state-red') card.className = `data-card state-red`;
                else card.className = `data-card active-blue`;
            }
            
            const el = document.getElementById(`c${idx}-val`);
            el.innerHTML = `${val} <span style="font-size:12px;opacity:0.6;">${unit}</span>`;
            
            if (idx === 2) {
                document.getElementById('main-stat').innerHTML = `${val} <span style="font-size:12px;font-weight:500;">${unit}</span>`;
                const boxBpm = document.getElementById('box-bpm');
                if(boxBpm) boxBpm.innerText = val;

                if(ORGAN_DATA[activeOrgan].animKey === type) {
                    ORGAN_DATA[activeOrgan].simValue = val;
                    if(activeOrgan === 'heart') AudioEngine.setBPM(val);
                }
            }
        };

        const startLiveSimulation = (organ) => {
            liveIntervals.forEach(clearInterval);
            liveIntervals = [];
            const data = ORGAN_DATA[organ];

            const mainInt = setInterval(() => {
                let hasAlert = false;
                data.stats.forEach((s, i) => {
                    if (typeof s.base === 'string') return; // Skip text based stats

                    let val = parseFloat(s.base);
                    let flux = (Math.random() - 0.5) * (val * 0.15); 
                    if(Math.random() > 0.85) flux *= 2.5; 

                    let newVal = Math.floor(val + flux);
                    if(s.unit === 'M' || s.unit === 'L' || s.unit.includes('g')) newVal = (val + flux/10).toFixed(1);

                    const state = getColorClass(newVal, s.type);
                    if(state === 'state-red') hasAlert = true;

                    updateCardValue(i+1, newVal, s.unit, s.type);
                });

                const aiPanel = document.getElementById('ai-panel');
                if(hasAlert) {
                    aiPanel.className = 'ai-panel warn';
                    document.getElementById('ai-title').innerText = "ATTENTION REQUIRED";
                    document.getElementById('ai-text').innerText = data.abnormal.msg + " " + data.abnormal.action;
                } else {
                    aiPanel.className = 'ai-panel';
                    document.getElementById('ai-title').innerText = "AI ANALYSIS";
                    document.getElementById('ai-text').innerText = "Vital signs are stable. No immediate irregularities detected.";
                }

            }, 2000);
            liveIntervals.push(mainInt);
        };

        // --- THREE.JS ENGINE ---
        let scene, camera, renderer, group, particles;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let mouseX = 0, mouseY = 0;
        let spotLight;

        const initThree = () => {
            const container = document.getElementById('model-3d-container');
            if(!container) return;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 1, 18);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            
            container.appendChild(renderer.domElement);

            // Particles
            const particlesGeo = new THREE.BufferGeometry();
            const pCount = 200;
            const pArray = new Float32Array(pCount * 3);
            for (let i = 0; i < pCount * 3; i++) pArray[i] = (Math.random() - 0.5) * 20;

            particlesGeo.setAttribute("position", new THREE.BufferAttribute(pArray, 3));
            const particlesMat = new THREE.PointsMaterial({
                size: 0.05,
                color: 0x3b82f6,
                transparent: true,
                opacity: 0.6
            });

            particles = new THREE.Points(particlesGeo, particlesMat);
            scene.add(particles);

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.2); 
            scene.add(ambient);
            
            spotLight = new THREE.SpotLight(0xffffff, 2); 
            spotLight.position.set(15, 20, 20); spotLight.angle = 0.6; spotLight.penumbra = 1; 
            scene.add(spotLight);
            
            const rimLight = new THREE.PointLight(0xff0055, 3, 50); rimLight.position.set(-10, 5, -5); scene.add(rimLight);
            const fillLight = new THREE.PointLight(0x3b82f6, 1, 50); fillLight.position.set(10, -10, 10); scene.add(fillLight);

            loadOrganModel('heart');
            
            // --- ANIMATION LOOP ---
            const clock = new THREE.Clock();
            const animate = () => {
                requestAnimationFrame(animate);
                const t = clock.getElapsedTime();
                const simVal = ORGAN_DATA[activeOrgan].simValue || 1;

                if (group && !isDragging) {
                    const type = group.userData.type;
                    
                    if (type === 'heart') {
                        // Heart Animation (Scaling for heartbeat effect)
                        const speed = simVal / 60; 
                        const beat = Math.sin(t * speed * Math.PI * 2);
                        const scale = beat > 0.8 ? 1 + (beat-0.8)*0.4 : 1;
                        
                        group.scale.set(scale, scale, scale);
                        group.rotation.y = Math.sin(t * 0.5) * 0.1 + (mouseX * 0.5);
                        group.rotation.x = Math.cos(t * 0.3) * 0.05 + (mouseY * 0.2);
                        
                        spotLight.intensity = 2 + (scale - 1) * 8; 
                    } else {
                        // All Other Imported Models (Generic Rotation/Pulse)
                        group.rotation.y += 0.005;
                        const pulse = 1 + Math.sin(t * 2) * 0.01;
                        group.scale.set(pulse * 2, pulse * 2, pulse * 2); 
                    }
                }
                
                if(particles) particles.rotation.y += 0.0005;
                renderer.render(scene, camera);
            };
            animate();

            // INPUT HANDLERS
            container.addEventListener('mousemove', (e) => {
                const rect = container.getBoundingClientRect();
                mouseX = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouseY = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                
                if (isDragging && group) {
                    const deltaMove = { x: e.offsetX - previousMousePosition.x, y: e.offsetY - previousMousePosition.y };
                    group.rotation.y += deltaMove.x * 0.01;
                    group.rotation.x += deltaMove.y * 0.01;
                }
                previousMousePosition = { x: e.offsetX, y: e.offsetY };
            });
            
            container.addEventListener('mousedown', () => isDragging = true);
            document.addEventListener('mouseup', () => isDragging = false);

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        };

        const loadOrganModel = (type) => {
            if (group) scene.remove(group);
            group = new THREE.Group();
            group.userData.type = type;
            scene.add(group);

            // UNIFIED LOADER: Now loads external GLB for ALL types (including heart and cells)
            const loader = new THREE.GLTFLoader();
            const fileName = ORGAN_MODEL_MAP[type] || `${type}.glb`;
            const url = `${MODEL_BASE_PATH}${fileName}`;

           loader.load(url, (gltf) => {
                const model = gltf.scene;
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());

                // Normalize Size using the largest dimension to keep proportions consistent
                const maxDim = Math.max(size.x, size.y, size.z);
                const scaleFactor = 6 / maxDim;
                model.scale.setScalar(scaleFactor);

                // Re-center the model at the origin so it sits in the middle of the stage
                box.setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center);
                
                group.add(model);
            }, undefined, (error) => {
                // FALLBACK: If model fails to load, show a placeholder wireframe shape
                console.warn(`Failed to load ${type}.glb from ${url}. Using fallback.`, error);
                
                const geo = new THREE.IcosahedronGeometry(2.5, 1);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: 0x0A84FF, 
                    wireframe: true, 
                    transparent: true, 
                    opacity: 0.5 
                });
                const fallbackMesh = new THREE.Mesh(geo, mat);
                group.add(fallbackMesh);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            generateOrganButtons();
            initSearchBar();
            initThree();
            updateUI('heart');

            // Sound Toggle
            const soundBtn = document.getElementById('sound-toggle');
            soundBtn.addEventListener('click', () => {
                const isActive = AudioEngine.toggle();
                soundBtn.style.color = isActive ? '#0A84FF' : 'white';
                soundBtn.style.background = isActive ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)';
            });

            // Delegate events for dynamically created buttons
            const tray = document.querySelector('.organ-tray');
            tray.addEventListener('click', (e) => {
                const btn = e.target.closest('.organ-item');
                if(!btn) return;
                
                document.querySelectorAll('.organ-item').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll('.organ-label').forEach(el => el.remove());
                
                btn.classList.add('selected');
                
                const label = document.createElement('div'); label.className = 'organ-label'; 
                label.innerText = 'My ' + btn.dataset.organ.charAt(0).toUpperCase() + btn.dataset.organ.slice(1);
                btn.appendChild(label);
                
                const organ = btn.dataset.organ;
                loadOrganModel(organ);
                updateUI(organ);
            });
        });
    </script>
</body> 
</html>
